/*!
 * Mollify v2.4.4 (http://www.mollify.org/)
 * Copyright 2008-2014 Samuli Järvelä
 * Licensed under GPLv2 (http://www.gnu.org/licenses/old-licenses/gpl-2.0.html)
 */
if("undefined"==typeof jQuery)throw new Error("Mollify requires jQuery");!function(a,b){"use strict";b.view.MainViewConfigView=function(){var c=this;this.viewId="admin",this._views=[],this._adminViews=[],this._adminViewsLoaded=!1,this.init=function(d){c.title=b.ui.texts.get("configviewMenuTitle"),c.icon="icon-cogs",c._views.push(new b.view.config.user.AccountView(d)),a.each(b.plugins.getConfigViewPlugins(),function(b,d){if(d.configViewHandler.views){var e=d.configViewHandler.views();e&&a.each(e,function(a,b){b.admin?c._adminViews.push(b):c._views.push(b)})}})},this.onResize=function(){},this.onActivate=function(d){b.templates.load("configview",b.templates.url("configview.html")).done(function(){b.dom.template("mollify-tmpl-configview").appendTo(d.content),c.showLoading(!0);var e=[];if(a.each(c._views,function(a,b){e.push({title:b.title,obj:b,callback:function(){c._activateView(b)}})}),c._userNav=d.addNavBar({title:b.ui.texts.get("configViewUserNavTitle"),items:e}),c.onResize(),b.session.user.admin)if(c._adminViewsLoaded)c._initAdminViews(d);else{c._adminViewsLoaded=!0,c._adminViews.unshift(new b.view.config.admin.FoldersView),c._adminViews.unshift(new b.view.config.admin.GroupsView),c._adminViews.unshift(new b.view.config.admin.UsersView);var f=[];for(var g in b.session.plugins)b.session.plugins[g]&&b.session.plugins[g].admin&&f.push(g);b.admin={plugins:[]},c._loadAdminPlugins(f).done(function(){c._initAdminViews(d)})}else c._onInitDone(d)})},this._loadAdminPlugins=function(d){var e=a.Deferred(),f=[];f.push(b.service.get("configuration/settings").done(function(a){c._settings=a}));for(var g=0,h=d.length;h>g;g++)f.push(b.dom.importScript(b.plugins.url(d[g],"plugin.js",!0)));return a.when.apply(a,f).done(function(){var d=[],f=function(a,b){c._adminViews.push(b)};for(var g in b.admin.plugins){var h=b.admin.plugins[g];h&&h.views&&(h.resources&&h.resources.texts&&d.push(b.ui.texts.loadPlugin(g)),a.each(h.views,f))}a.when.apply(a,d).done(e.resolve)}),e},this._initAdminViews=function(d){a.each(c._adminViews,function(a,b){b.init&&b.init(c._settings,c)});var e=[];a.each(c._adminViews,function(a,b){e.push({title:b.title,obj:b,callback:function(){c._activateView(b,!0)}})}),c._adminNav=d.addNavBar({title:b.ui.texts.get("configViewAdminNavTitle"),items:e}),c._onInitDone(d)},this._findView=function(b){var d=!1;return a.each(c._views,function(a,c){return c.viewId==b?(d={view:c,admin:!1},!1):void 0}),d||a.each(c._adminViews,function(a,c){return c.viewId==b?(d={view:c,admin:!0},!1):void 0}),d},this._onInitDone=function(a){if(a.id){var b=c._findView(a.id[0]);b&&c._activateView(b.view,b.admin)}else c._activateView(c._views[0])},this.onRestoreView=function(a){var b=c._findView(a[0]);b&&c._activateView(b.view,b.admin,!0)},this._activateView=function(d,e,f){c._activeView&&(c._activeView.onDeactivate&&c._activeView.onDeactivate(),c._adminNav&&c._adminNav.setActive(!1),c._userNav.setActive(!1)),e?c._adminNav.setActive(d):c._userNav.setActive(d),c.showLoading(!1),c._activeView=d,!f&&c._activeView.viewId&&b.App.storeView("admin/"+c._activeView.viewId),a("#mollify-configview-header").html(d.title),d.onActivate(c._getContentElement().empty(),c)},this._getContentElement=function(){return a("#mollify-configview-content")},this.onDeactivate=function(){c._activeView&&c._activeView.onDeactivate&&c._activeView.onDeactivate()},this.showLoading=function(a){a?c._getContentElement().find(".mollify-configlistview").addClass("loading"):c._getContentElement().find(".mollify-configlistview").removeClass("loading")}},b.view.ConfigListView=function(c,d){b.dom.template("mollify-tmpl-configlistview",{title:d.title,actions:d.actions||!1}).appendTo(c);var e=c.find(".mollify-configlistview-table"),f=b.ui.controls.table(e,d.table),g=function(a,b){b?c.find("#mollify-configlistview-action-"+a).removeClass("disabled"):c.find("#mollify-configlistview-action-"+a).addClass("disabled")};return d.actions&&(a.each(d.actions,function(c,d){d.depends&&g(d.id,!1),d.tooltip&&b.ui.controls.tooltip(a("#mollify-configlistview-action-"+d.id),{title:d.tooltip})}),f.onSelectionChanged(function(){var b=f.getSelected(),c=b.length>0,e=1==b.length,h=b.length>1;a.each(d.actions,function(a,b){b.depends&&("table-selection"==b.depends?g(b.id,c):"table-selection-one"==b.depends?g(b.id,e):"table-selection-many"==b.depends&&g(b.id,h))})}),c.find(".mollify-configlistview-actions > .mollify-configlistview-action").click(function(){if(!a(this).hasClass("disabled")){var b=a(this).tmplItem().data;if(b.callback){var c;b.depends&&b.depends.startsWith("table-selection")&&(c=f.getSelected()),b.callback(c)}}})),{table:f,enableAction:g}},b.view.config={user:{},admin:{}},b.view.config.user.AccountView=function(c){this.viewId="account",this.title=b.ui.texts.get("configUserAccountNavTitle"),this.onActivate=function(d){b.dom.template("mollify-tmpl-config-useraccountview",b.session).appendTo(d),b.ui.process(d,["localize"]),a("#user-account-change-password-btn").click(c.changePassword)}},b.view.config.admin.UsersView=function(){var c=this;this.viewId="users",this.init=function(a,d){c._cv=d,c.title=b.ui.texts.get("configAdminUsersNavTitle"),c._authenticationOptions=a.authentication_methods,c._authFormatter=function(a){return a},c._defaultAuthMethod=a.authentication_methods[0],c._langFormatter=function(a){return b.ui.texts.get("language_"+a)}},this.onActivate=function(d){var e=!1;c._details=b.ui.controls.slidePanel(a("#mollify-mainview-viewcontent"),{resizable:!0});var f=function(){var b={criteria:{}},c=a("#mollify-admin-user-searchoptions-name").val();c&&c.length>0&&(b.criteria.name=c);var d=a("#mollify-admin-user-searchoptions-email").val();return d&&d.length>0&&(b.criteria.email=d),b},g=function(){c._cv.showLoading(!0),e.table.refresh().done(function(){c._cv.showLoading(!1)})},h=function(){c._details.hide(),g()};e=new b.view.ConfigListView(d,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){c.onAddEditUser(!1,h)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminUsersRemoveUsersConfirmationTitle"),message:b.ui.texts.get("configAdminUsersRemoveUsersConfirmationMessage",[a.length]),callback:function(){c._removeUsers(a).done(h)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:g}],table:{id:"config-admin-users",key:"id",narrow:!0,hilight:!0,remote:{path:"configuration/users/query",paging:{max:50},queryParams:f,onLoad:function(a){d.addClass("loading"),a.done(function(){d.removeClass("loading")})}},columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"name",title:b.ui.texts.get("configAdminUsersNameTitle"),sortable:!0},{id:"user_type",title:b.ui.texts.get("configAdminUsersTypeTitle"),sortable:!0,valueMapper:function(a,c){return b.ui.texts.get(null==c?"configAdminUsersTypeNormal":"configAdminUsersType_"+c.toLowerCase())}},{id:"email",title:b.ui.texts.get("configAdminUsersEmailTitle"),sortable:!0},{id:"edit",title:b.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"pw",title:b.ui.texts.get("configAdminUsersActionChangePasswordTitle"),type:"action",content:'<i class="icon-key"></i>'},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"edit"==a?b.service.get("configuration/users/"+d.id).done(function(a){c.onAddEditUser(a,h)}):"pw"==a?c.onChangePassword(d):"remove"==a&&b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminUsersRemoveUserConfirmationTitle"),message:b.ui.texts.get("configAdminUsersRemoveUserConfirmationMessage",[d.name]),callback:function(){b.service.del("configuration/users/"+d.id).done(h)}})},onHilight:function(a){a?(c._showUserDetails(a,c._details.getContentElement().empty(),c._allGroups,c._allFolders),c._details.show(!1,400)):c._details.hide()}}}),c._cv.showLoading(!0);var i=d.find(".mollify-configlistview-options");b.dom.template("mollify-tmpl-config-admin-user-searchoptions").appendTo(i),b.ui.process(i,["localize"]);var j=b.service.get("configuration/usergroups").done(function(a){c._allGroups=a}),k=b.service.get("configuration/folders").done(function(a){c._allFolders=a});a.when(j,k).done(g)},this.onChangePassword=function(d,e){var f=!1,g=!1;b.ui.dialogs.custom({resizable:!0,initSize:[600,200],title:b.ui.texts.get("configAdminUsersChangePasswordDialogTitle",d.name),content:b.dom.template("mollify-tmpl-config-admin-userchangepassworddialog",{user:d}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,c){if("no"==a.id)return void c.close();var f=g.val();f&&0!==f.length&&b.service.put("configuration/users/"+d.id+"/password",{"new":window.Base64.encode(f)}).done(c.close).done(e)},"on-show":function(e,h){a("#change-password-title").text(b.ui.texts.get("configAdminUsersChangePasswordTitle",d.name)),f=h.find("#mollify-config-admin-userchangepassworddialog-content"),g=h.find("#passwordField"),a("#generatePasswordBtn").click(function(){return g.val(c._generatePassword()),!1}),g.focus(),e.center()}})},this.onDeactivate=function(){c._details.remove()},this._showUserDetails=function(c,d,e,f){b.dom.template("mollify-tmpl-config-admin-userdetails",{user:c}).appendTo(d),b.ui.process(d,["localize"]);var g=d.find(".mollify-config-admin-userdetails-groups"),h=d.find(".mollify-config-admin-userdetails-folders"),i=!1,j=!1,k=!1,l=!1,m=function(){g.addClass("loading"),b.service.get("configuration/users/"+c.id+"/groups/").done(function(a){g.removeClass("loading"),l=a,j.table.set(l)})},n=function(){h.addClass("loading"),b.service.get("configuration/users/"+c.id+"/folders/").done(function(a){h.removeClass("loading"),k=a,i.table.set(k)})},o=function(){var d=b.helpers.extractValue(k,"id"),e=b.helpers.filter(f,function(a){return d.indexOf(a.id)<0});b.ui.dialogs.select({title:b.ui.texts.get("configAdminUserAddFolderTitle"),message:b.ui.texts.get("configAdminUserAddFolderMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersFolderDefaultNameTitle")},{id:"user_name",title:b.ui.texts.get("configAdminUsersFolderNameTitle"),type:"input"},{id:"path",title:b.ui.texts.get("configAdminFoldersPathTitle")}],list:e,onSelect:function(d,e){var f=[];a.each(d,function(a,b){var c={id:b.id},d=e[b.id]?e[b.id].user_name:!1;d&&b.name!=d&&(c.name=d),f.push(c)}),b.service.post("configuration/users/"+c.id+"/folders/",f).done(n)}})},p=function(){var a=b.helpers.extractValue(l,"id"),d=b.helpers.filter(e,function(b){return a.indexOf(b.id)<0});b.ui.dialogs.select({title:b.ui.texts.get("configAdminUserAddGroupTitle"),message:b.ui.texts.get("configAdminUserAddGroupMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersGroupNameTitle")},{id:"description",title:b.ui.texts.get("configAdminGroupsDescriptionTitle")}],list:d,onSelect:function(a){b.service.post("configuration/users/"+c.id+"/groups/",b.helpers.extractValue(a,"id")).done(m)}})};i=new b.view.ConfigListView(d.find(".mollify-config-admin-userdetails-folders"),{title:b.ui.texts.get("configAdminUsersFoldersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:o},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.service.del("configuration/users/"+c.id+"/folders/",{ids:b.helpers.extractValue(a,"id")}).done(n)}}],table:{id:"config-admin-userfolders",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersFolderNameTitle"),formatter:function(a){var c=a.name;return c&&c.length>0?c:b.ui.texts.get("configAdminUsersFolderDefaultName",a.default_name)}},{id:"path",title:b.ui.texts.get("configAdminFoldersPathTitle")},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"remove"==a&&b.service.del("configuration/users/"+c.id+"/folders/"+d.id).done(n)}}}),j=new b.view.ConfigListView(d.find(".mollify-config-admin-userdetails-groups"),{title:b.ui.texts.get("configAdminUsersGroupsTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:p},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.service.del("configuration/users/"+c.id+"/groups/",{ids:b.helpers.extractValue(a,"id")}).done(m)}}],table:{id:"config-admin-usergroups",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersGroupNameTitle")},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"remove"==a&&b.service.del("configuration/users/"+c.id+"/groups/"+d.id).done(m)}}}),b.plugins.get("plugin-permissions").getUserConfigPermissionsListView(d.find(".mollify-config-admin-userdetails-permissions"),b.ui.texts.get("configAdminUsersPermissionsTitle"),c),m(),n()},this._generatePassword=function(){for(var a,b=8,d="",e=0;b>e;e++){for(;;)if(a=parseInt(1e3*Math.random(),10)%94+33,c._isValidPasswordChar(a))break;d+=String.fromCharCode(a)}return d},this._isValidPasswordChar=function(a){return a>=33&&47>=a?!1:a>=58&&64>=a?!1:a>=91&&96>=a?!1:a>=123&&126>=a?!1:!0},this._removeUsers=function(a){return b.service.del("configuration/users",{ids:b.helpers.extractValue(a,"id")})},this.onAddEditUser=function(d,e){var f=!1,g=!1,h=!1,i=!1,j=!1,k=!1,l=!1,m=!1,n=b.settings.language.options&&b.settings.language.options.length>1;b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:b.ui.texts.get(d?"configAdminUsersUserDialogEditTitle":"configAdminUsersUserDialogAddTitle"),content:b.dom.template("mollify-tmpl-config-admin-userdialog",{user:d,showLanguages:n}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,c){if("no"==a.id)return void c.close();var f=g.val(),o=h.val(),p=j.selected(),q=b.helpers.formatInternalTime(m.get()),r=k.selected();if(f&&0!==f.length){var s=null;n&&(s=l.selected());var t={name:f,email:o,user_type:p,expiration:q,auth:r,lang:s};if(d)b.service.put("configuration/users/"+d.id,t).done(c.close).done(e);else{var u=i.val();if(!u||0===u.length)return;t.password=window.Base64.encode(u),b.service.post("configuration/users",t).done(c.close).done(e)}}},"on-show":function(e,o){f=o.find("#mollify-config-admin-userdialog-content"),g=o.find("#usernameField"),h=o.find("#emailField"),i=o.find("#passwordField"),a("#generatePasswordBtn").click(function(){return i.val(c._generatePassword()),!1}),j=b.ui.controls.select("typeField",{values:["a"],none:b.ui.texts.get("configAdminUsersTypeNormal"),formatter:function(a){return b.ui.texts.get("configAdminUsersType_"+a)}}),k=b.ui.controls.select("authenticationField",{values:c._authenticationOptions,none:b.ui.texts.get("configAdminUsersUserDialogAuthDefault",c._defaultAuthMethod),formatter:c._authFormatter}),n&&(l=b.ui.controls.select("languageField",{values:b.settings.language.options,none:b.ui.texts.get("configAdminUsersUserDialogLangDefault",b.settings.language["default"]||"en"),formatter:c._langFormatter})),m=b.ui.controls.datepicker("expirationField",{format:b.ui.texts.get("shortDateTimeFormat"),time:!0}),d?(g.val(d.name),h.val(d.email||""),j.select(d.user_type?d.user_type.toLowerCase():null),k.select(d.auth?d.auth.toLowerCase():null),m.set(b.helpers.parseInternalTime(d.expiration)),n&&d.lang&&l.select(d.lang)):j.select(null),g.focus(),e.center()}})}},b.view.config.admin.GroupsView=function(){var c=this;this.viewId="groups",this.init=function(a,d){c._cv=d,c.title=b.ui.texts.get("configAdminGroupsNavTitle")},this.onActivate=function(d){var e=!1,f=!1;c._details=b.ui.controls.slidePanel(a("#mollify-mainview-viewcontent"),{resizable:!0});var g=function(){c._details.hide(),c._cv.showLoading(!0),b.service.get("configuration/usergroups/").done(function(a){c._cv.showLoading(!1),e=a,f.table.set(e)})};f=new b.view.ConfigListView(d,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){c.onAddEditGroup(!1,g)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminGroupsRemoveGroupsConfirmationTitle"),message:b.ui.texts.get("configAdminGroupsRemoveGroupsConfirmationMessage",[a.length]),callback:function(){c._removeGroups(a).done(g)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:g}],table:{id:"config-admin-groups",key:"id",narrow:!0,hilight:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-user"></i>'},{id:"name",title:b.ui.texts.get("configAdminUsersNameTitle")},{id:"description",title:b.ui.texts.get("configAdminGroupsDescriptionTitle")},{id:"edit",title:b.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"edit"==a?c.onAddEditGroup(d,g):"remove"==a&&b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminGroupsRemoveGroupConfirmationTitle"),message:b.ui.texts.get("configAdminGroupsRemoveGroupConfirmationMessage",[d.name]),callback:function(){b.service.del("configuration/usergroups/"+d.id).done(g)}})},onHilight:function(a){a?(c._showGroupDetails(a,c._details.getContentElement().empty(),c._allUsers,c._allFolders),c._details.show(!1,400)):c._details.hide()}}}),g(),c._cv.showLoading(!0);var h=b.service.get("configuration/users").done(function(a){c._allUsers=a}),i=b.service.get("configuration/folders").done(function(a){c._allFolders=a});a.when(h,i).done(function(){c._cv.showLoading(!1)})},this.onDeactivate=function(){c._details.remove()},this._showGroupDetails=function(c,d,e,f){b.dom.template("mollify-tmpl-config-admin-groupdetails",{group:c}).appendTo(d),b.ui.process(d,["localize"]);var g=d.find(".mollify-config-admin-groupdetails-users"),h=d.find(".mollify-config-admin-groupdetails-folders"),i=!1,j=!1,k=!1,l=!1,m=function(){g.addClass("loading"),b.service.get("configuration/usergroups/"+c.id+"/users/").done(function(a){g.removeClass("loading"),l=a,j.table.set(l)})},n=function(){h.addClass("loading"),b.service.get("configuration/users/"+c.id+"/folders/").done(function(a){h.removeClass("loading"),k=a,i.table.set(k)})},o=function(){var a=b.helpers.extractValue(l,"id"),d=b.helpers.filter(e,function(b){return a.indexOf(b.id)<0});b.ui.dialogs.select({title:b.ui.texts.get("configAdminGroupAddUserTitle"),message:b.ui.texts.get("configAdminGroupAddUserMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersNameTitle")}],list:d,onSelect:function(a){b.service.post("configuration/usergroups/"+c.id+"/users/",b.helpers.extractValue(a,"id")).done(m)}})},p=function(){var d=b.helpers.extractValue(k,"id"),e=b.helpers.filter(f,function(a){return d.indexOf(a.id)<0});b.ui.dialogs.select({title:b.ui.texts.get("configAdminGroupAddFolderTitle"),message:b.ui.texts.get("configAdminGroupAddFolderMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersFolderDefaultNameTitle")},{id:"user_name",title:b.ui.texts.get("configAdminUsersFolderNameTitle"),type:"input"},{id:"path",title:b.ui.texts.get("configAdminFoldersPathTitle")}],list:e,onSelect:function(d,e){var f=[];a.each(d,function(a,b){var c={id:b.id},d=e[b.id]?e[b.id].user_name:!1;d&&b.name!=d&&(c.name=d),f.push(c)}),b.service.post("configuration/users/"+c.id+"/folders/",f).done(n)}})};i=new b.view.ConfigListView(h,{title:b.ui.texts.get("configAdminGroupsFoldersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:p},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.service.del("configuration/users/"+c.id+"/folders/",{ids:b.helpers.extractValue(a,"id")}).done(n)}}],table:{id:"config-admin-groupfolders",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder"></i>'},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersFolderNameTitle"),valueMapper:function(a){var c=a.name;return c&&c.length>0?c:b.ui.texts.get("configAdminUsersFolderDefaultName",a.default_name)}},{id:"path",title:b.ui.texts.get("configAdminFoldersPathTitle")},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"remove"==a&&b.service.del("configuration/users/"+c.id+"/folders/"+d.id).done(n)}}}),j=new b.view.ConfigListView(g,{title:b.ui.texts.get("configAdminGroupsUsersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:o},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.service.post("configuration/usergroups/"+c.id+"/remove_users/",b.helpers.extractValue(a,"id")).done(m)}}],table:{id:"config-admin-groupusers",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUsersNameTitle")},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"remove"==a&&b.service.post("configuration/usergroups/"+c.id+"/remove_users/",[d.id]).done(m)}}}),b.plugins.get("plugin-permissions").getUserConfigPermissionsListView(d.find(".mollify-config-admin-groupdetails-permissions"),b.ui.texts.get("configAdminGroupsPermissionsTitle"),c),m(),n()},this._removeGroups=function(a){return b.service.del("configuration/usergroups",{ids:b.helpers.extractValue(a,"id")})},this.onAddEditGroup=function(a,c){var d=!1,e=!1,f=!1;b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:b.ui.texts.get(a?"configAdminGroupsDialogEditTitle":"configAdminGroupsDialogAddTitle"),content:b.dom.template("mollify-tmpl-config-admin-groupdialog",{group:a}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(d,g){if("no"==d.id)return void g.close();var h=e.val();if(h&&0!==h.length){var i=f.val(),j={name:h,description:i};a?b.service.put("configuration/usergroups/"+a.id,j).done(g.close).done(c):b.service.post("configuration/usergroups",j).done(g.close).done(c)}},"on-show":function(b,c){d=c.find("#mollify-config-admin-groupdialog-content"),e=c.find("#nameField"),f=c.find("#descriptionField"),a&&(e.val(a.name),f.val(a.description||"")),e.focus(),b.center()}})}},b.view.config.admin.FoldersView=function(){var c=this;this.viewId="folders",this.init=function(a,d){c._cv=d,c._settings=a,c.title=b.ui.texts.get("configAdminFoldersNavTitle")},this.onActivate=function(d){var e=!1,f=!1;c._details=b.ui.controls.slidePanel(a("#mollify-mainview-viewcontent"),{resizable:!0});var g=function(){c._cv.showLoading(!0),b.service.get("configuration/folders/").done(function(a){c._cv.showLoading(!1),e=a,f.table.set(e)})};f=new b.view.ConfigListView(d,{actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:function(){c.onAddEditFolder(!1,g)}},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminFoldersRemoveFoldersConfirmationTitle"),message:b.ui.texts.get("configAdminFoldersRemoveFoldersConfirmationMessage",[a.length]),callback:function(){c._removeFolders(a).done(g)}})}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:g}],table:{id:"config-admin-folders",key:"id",narrow:!0,hilight:!0,columns:[{type:"selectrow"},{id:"icon",title:"",type:"static",content:'<i class="icon-folder-close"></i>'},{id:"name",title:b.ui.texts.get("configAdminFoldersNameTitle")},{id:"path",title:b.ui.texts.get("configAdminFoldersPathTitle")},{id:"edit",title:b.ui.texts.get("configAdminActionEditTitle"),type:"action",content:'<i class="icon-edit"></i>'},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(a,d){"edit"==a?c.onAddEditFolder(d,g):"remove"==a&&b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminFoldersRemoveFolderConfirmationTitle"),message:b.ui.texts.get("configAdminFoldersRemoveFolderConfirmationMessage",[d.name]),callback:function(){b.service.del("configuration/folders/"+d.id).done(g)}})},onHilight:function(a){a?(c._showFolderDetails(a,c._details.getContentElement().empty(),c._allGroups,c._allUsers),c._details.show(!1,400)):c._details.hide()}}}),g(),c._cv.showLoading(!0);b.service.get("configuration/usersgroups").done(function(a){c._allUsers=a.users,c._allGroups=a.groups,c._cv.showLoading(!1)})},this.onDeactivate=function(){c._details.remove()},this._showFolderDetails=function(a,c,d,e){b.dom.template("mollify-tmpl-config-admin-folderdetails",{folder:a}).appendTo(c),b.ui.process(c,["localize"]);var f=c.find(".mollify-config-admin-folderdetails-usersandgroups"),g=!1,h=!1,i=d.concat(e),j=function(){f.addClass("loading"),b.service.get("configuration/folders/"+a.id+"/users/").done(function(a){f.removeClass("loading"),h=a,g.table.set(a)})},k=function(){var c=b.helpers.extractValue(h,"id"),d=b.helpers.filter(i,function(a){return c.indexOf(a.id)<0});b.ui.dialogs.select({title:b.ui.texts.get("configAdminFolderAddUserTitle"),message:b.ui.texts.get("configAdminFolderAddUserMessage"),key:"id",initSize:[600,400],columns:[{id:"icon",title:"",valueMapper:function(a){return 1==a.is_group?"<i class='icon-user'></i><i class='icon-user'></i>":"<i class='icon-user'></i>"}},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUserDialogUsernameTitle")}],list:d,onSelect:function(c){b.service.post("configuration/folders/"+a.id+"/users/",b.helpers.extractValue(c,"id")).done(j)}})};g=new b.view.ConfigListView(f,{title:b.ui.texts.get("configAdminFolderUsersTitle"),actions:[{id:"action-add",content:'<i class="icon-plus"></i>',callback:k},{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(c){b.service.post("configuration/folders/"+a.id+"/remove_users/",b.helpers.extractValue(c,"id")).done(j)}}],table:{id:"config-admin-folderusers",key:"id",narrow:!0,columns:[{type:"selectrow"},{id:"icon",title:"",valueMapper:function(a){return 1==a.is_group?"<i class='icon-user'></i><i class='icon-user'></i>":"<i class='icon-user'></i>"}},{id:"id",title:b.ui.texts.get("configAdminTableIdTitle")},{id:"name",title:b.ui.texts.get("configAdminUserDialogUsernameTitle")},{id:"remove",title:b.ui.texts.get("configAdminActionRemoveTitle"),type:"action",content:'<i class="icon-trash"></i>'}],onRowAction:function(c,d){"remove"==c&&b.service.post("configuration/folders/"+a.id+"/remove_users/",[d.id]).done(j)}}}),j()},this._removeFolders=function(a){return b.service.del("configuration/folders",{ids:b.helpers.extractValue(a,"id")})},this._isValidPath=function(a){return a?a.indexOf("..")>=0?!1:!c._settings.published_folders_root||0!==a.indexOf("/")&&0!==a.indexOf(":\\")?!0:!1:!1},this.onAddEditFolder=function(a,d){var e=!1,f=!1,g=!1;b.ui.dialogs.custom({resizable:!0,initSize:[500,300],title:b.ui.texts.get(a?"configAdminFoldersFolderDialogEditTitle":"configAdminFoldersFolderDialogAddTitle"),content:b.dom.template("mollify-tmpl-config-admin-folderdialog",{folder:a}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(h,i){if("no"==h.id)return void i.close();e.find(".control-group").removeClass("error");var j=f.val();j||f.closest(".control-group").addClass("error");var k=g.val(),l=c._isValidPath(k);if(l||g.closest(".control-group").addClass("error"),!j)return void f.focus();if(!l)return void g.focus();var m={name:j,path:k},n=function(c){105==c.code&&(this.handled=!0,b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminFoldersFolderDialogAddTitle"),message:b.ui.texts.get("configAdminFoldersFolderDialogAddFolderDoesNotExist"),callback:function(){m.create=!0,a?b.service.put("configuration/folders/"+a.id,m).done(i.close).done(d):b.service.post("configuration/folders",m).done(i.close).done(d)}}))};a?b.service.put("configuration/folders/"+a.id,m).done(i.close).done(d).fail(n):b.service.post("configuration/folders",m).done(i.close).done(d).fail(n)},"on-show":function(b,c){e=c.find("#mollify-config-admin-folderdialog-content"),f=c.find("#nameField"),g=c.find("#pathField"),a&&(f.val(a.name),g.val(a.path)),f.focus(),b.center()}})}}}(window.jQuery,window.mollify);var mollifyDefaults={language:{"default":"en",options:["en"]},"view-url":!1,"app-element-id":"mollify","service-path":"backend/","limited-http-methods":!1,"file-view":{"default-view-mode":!1,"list-view-columns":{name:{width:250},size:{},"file-modified":{width:150}},actions:!1},"html5-uploader":{maxChunkSize:0},dnd:{dragimages:{"filesystemitem-file":"css/images/mimetypes64/empty.png","filesystemitem-folder":"css/images/mimetypes64/folder.png","filesystemitem-many":"css/images/mimetypes64/application_x_cpio.png"}}};!function(a){"use strict";var b={App:{},view:{},ui:{},events:{},service:{},filesystem:{},plugins:{},features:{},dom:{},templates:{}};b._time=(new Date).getTime(),b._hiddenInd=0,b.settings=!1,b.session=!1,b.App.init=function(c,d){if(window.Modernizr.testProp("touch"),b.App._initialized=!1,b.App._views={},b.App.pageUrl=b.request.getBaseUrl(window.location.href),b.App.pageParams=b.request.getParams(window.location.href),b.App.mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),b.settings=a.extend(!0,{},mollifyDefaults,c),b.service.init(b.settings["limited-http-methods"]),b.plugins.register(new b.plugin.Core),b.plugins.register(new b.plugin.PermissionsPlugin),d)for(var e=0,f=d.length;f>e;e++)b.plugins.register(d[e]);b.events.addEventHandler(function(a){"session/start"==a.type?b.App._onSessionStart(a.payload):"session/end"==a.type&&(b.session={},b.filesystem.init([]),g())});var g=function(){b.service.get("session/info/").fail(function(){new b.ui.FullErrorView("Failed to initialize Mollify").show()}).done(function(a){b.events.dispatch("session/start",a)})},h=function(){new b.ui.FullErrorView("Failed to initialize Mollify").show()};b.ui.initialize().done(function(){b.plugins.initialize().done(function(){b.App._initialized=!0,g()}).fail(h)}).fail(h),b.settings["view-url"]&&(window.onpopstate=function(a){b.App.onRestoreState(document.location.href,a.state)})},b.App.getElement=function(){return a("#"+b.settings["app-element-id"])},b.App._onSessionStart=function(a){var c=a.authenticated?{id:a.user_id,name:a.username,type:a.user_type,lang:a.lang,admin:"a"==a.user_type,permissions:a.permissions,hasPermission:function(c,d){return b.helpers.hasPermission(a.permissions,c,d)}}:null;b.session={id:a.session_id,user:c,features:a.features,plugins:a.plugins,data:a},b.filesystem.init(b.session.data.folders,b.session.user&&b.session.user.admin?b.session.data.roots:!1),b.ui.initializeLang().done(b.App._doStart).fail(function(){new b.ui.FullErrorView("Failed to initialize Mollify").show()
})},b.App._doStart=function(){b.App.activeView=!1,b.App.activeViewId=null,b.App.openView(b.App.pageParams.v||"/files/")},b.App.openView=function(a){var c=a.split("/"),d=function(a){a?(b.App.activeView=a,b.App.activeViewId=c[0]):b.session.user?(b.App.activeView=new b.view.MainView,b.App.activeViewId="main"):(b.App.activeView=new b.view.LoginView,b.App.activeViewId="login"),b.App.activeView.init(b.App.getElement(),c)};if(c){var e=!!b.App._views[c[0]],f=e&&b.App.activeViewId==c[0]||!e&&"main"==b.App.activeViewId;f?b.App.activeView.onRestoreView(c):b.App._getView(c,d)}else d()},b.App._getView=function(a,c){var d=b.App._views[a[0]];if(d&&d.getView){var e=d.getView(a,b.App.pageParams);e&&e.done?e.done(c):c(e)}else c(!1)},b.App.onRestoreState=function(a,c){if(b.settings["view-url"]&&b.App.activeView&&c&&c.user_id&&b.session.user&&b.session.user.id==c.user_id){var d=b.request.getParams(a);!d.v||d.v.length<1||b.App.openView(d.v)}},b.App.storeView=function(a){if(b.settings["view-url"]){var c={user_id:b.session.user?b.session.user.id:null};window.history&&window.history.pushState(c,"","?v="+a)}},b.App.registerView=function(a,c){b.App._views[a]=c},b.App.openPage=function(a){window.location=b.App.getPageUrl(a)},b.App.getPageUrl=function(a){return b.App.pageUrl+"?v="+a},b.getItemDownloadInfo=function(a){if(!a)return!1;var c=!1;return window.isArray(a)?0===a.length&&(c=a[0]):c=a,c&&c.is_file?{name:c.name,url:b.filesystem.getDownloadUrl(c)}:c?b.plugins.exists("plugin-archiver")?{name:c.name+".zip",url:b.plugins.get("plugin-archiver").getDownloadCompressedUrl(a)}:!1:!1},b.resourceUrl=function(a){if(!b.settings["resource-map"])return a;var c=b.helpers.breakUrl(a);if(!c)return a;var d=b.settings["resource-map"][c.path];return void 0===d?a:d===!1?!1:d+c.paramsString},b.request={getParam:function(a){return(a=new RegExp("[?&]"+encodeURIComponent(a)+"=([^&]*)").exec(location.search))?decodeURIComponent(a[1]):void 0},getParams:function(){return b.helpers.getUrlParams(location.search)},getBaseUrl:function(a){var b=a.lastIndexOf("?");b>=0&&(a=a.substring(0,b+1));var c=a.lastIndexOf("/");return a.substring(0,c+1)}};var c=b.events;c._handlers=[],c._handlerTypes={},c.addEventHandler=function(a,b){c._handlers.push(a),b&&(c._handlerTypes[a]=b)},c.dispatch=function(b,d){var e={type:b,payload:d};a.each(c._handlers,function(a,d){c._handlerTypes[d]&&b!=c._handlerTypes[d]||d(e)})};var d=b.service;d.init=function(a){d._limitedHttpMethods=!!a},d.url=function(a,c){if(a.startsWith("http"))return a;var d=b.settings["service-path"]+"r.php/"+a;return c?b.App.pageUrl+d:d},d.get=function(a){return d._do("GET",a,null)},d.post=function(a,b){return d._do("POST",a,b)},d.put=function(a,b){return d._do("PUT",a,b)},d.del=function(a,b){return d._do("DELETE",a,b)},d._do=function(c,e,f){var g=c,h=d._limitedHttpMethods&&("PUT"==g||"DELETE"==g);return h&&(g="POST"),function(i){return a.ajax({type:g,url:d.url(e),processData:!1,data:f?JSON.stringify(f):null,contentType:"application/json",dataType:"json",beforeSend:function(a){b.session&&b.session.id&&a.setRequestHeader("mollify-session-id",b.session.id),(d._limitedHttpMethods||h)&&a.setRequestHeader("mollify-http-method",c)}}).pipe(function(b){return b?b.result:a.Deferred().reject({code:999})},function(c){var d=a.Deferred();if(b.session.id!=i)return d;var e=!1;c.responseText&&c.responseText.startsWith("{")&&(e=JSON.parse(a.trim(c.responseText))),e||(e={code:999});var f={handled:!1};return 100==e.code&&b.session.user&&(b.events.dispatch("session/end"),f.handled=!0),setTimeout(function(){d.fail(function(a){f.handled||b.ui.dialogs.showError(a)})},0),d.rejectWith(f,[e])}).promise()}(b.session.id)};var e=b.filesystem;e.init=function(a,c){if(b.filesystem.permissionCache={},b.filesystem.roots=[],b.filesystem.allRoots=!1,b.filesystem.rootsById={},a&&b.session.user){b.filesystem.roots=a;for(var d=0,e=a.length;e>d;d++)b.filesystem.rootsById[a[d].id]=a[d];if(c){b.filesystem.allRoots=c;for(var f=0,g=c.length;g>f;f++)b.filesystem.rootsById[c[f].id]||(b.filesystem.rootsById[c[f].id]=c[f])}}},e.getDownloadUrl=function(a){if(!a.is_file)return!1;var c=b.service.url("filesystem/"+a.id,!0);return b.App.mobile&&(c=c+(c.indexOf("?")>=0?"&":"?")+"m=1"),c},e.getUploadUrl=function(a){return!a||a.is_file?null:b.service.url("filesystem/"+a.id+"/files/")+"?format=binary"},e.itemDetails=function(a,c){return b.service.post("filesystem/"+a.id+"/details/",{data:c}).done(function(c){b.filesystem.permissionCache[a.id]=c.permissions,a.parent_id&&c.parent_permissions&&(b.filesystem.permissionCache[a.parent_id]=c.parent_permissions)})},e.folderInfo=function(a,c,d){return b.service.post("filesystem/"+(a?a:"roots")+"/info/"+(c?"?h=1":""),{data:d}).done(function(c){b.filesystem.permissionCache[a]=c.permissions})},e.findFolder=function(a,c){return b.service.post("filesystem/find/",{folder:a,data:c})},e.hasPermission=function(a,c,d){return b.session.user?b.session.user.admin?!0:b.helpers.hasPermission(b.filesystem.permissionCache["string"==typeof a?a:a.id],c,d):!1},e.items=function(c,d){if(null==c){var f=a.Deferred();return f.resolve({folders:e.roots,files:[]}),f.promise()}return b.service.get("filesystem/"+c.id+"/items/?files="+(d?"1":"0"))},e.copy=function(c,d){if(c){if(window.isArray(c)&&c.length>1){if(d)return e._copyMany(c,d);var f=a.Deferred();return b.ui.dialogs.folderSelector({title:b.ui.texts.get("copyMultipleFileDialogTitle"),message:b.ui.texts.get("copyMultipleFileMessage",[c.length]),actionTitle:b.ui.texts.get("copyFileDialogAction"),handler:{onSelect:function(b){a.when(e._copyMany(c,b)).then(f.resolve,f.reject)},canSelect:function(a){return e.canCopyTo(c,a)}}}),f.promise()}if(window.isArray(c)&&(c=c[0]),d)return e._copy(c,d);var g=a.Deferred();return b.ui.dialogs.folderSelector({title:b.ui.texts.get("copyFileDialogTitle"),message:b.ui.texts.get("copyFileMessage",[c.name]),actionTitle:b.ui.texts.get("copyFileDialogAction"),handler:{onSelect:function(b){a.when(e._copy(c,b)).then(g.resolve,g.reject)},canSelect:function(a){return e.canCopyTo(c,a)}}}),g.promise()}},e.copyHere=function(c,d){if(c){if(d)return e._copyHere(c,d);var f=a.Deferred();return b.ui.dialogs.input({title:b.ui.texts.get("copyHereDialogTitle"),message:b.ui.texts.get("copyHereDialogMessage"),defaultValue:c.name,yesTitle:b.ui.texts.get("copyFileDialogAction"),noTitle:b.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(a){return!!a&&a.length>0&&a!=c.name},onInput:function(b){a.when(e._copyHere(c,b)).then(f.resolve,f.reject)}}}),f.promise()}},e.canCopyTo=function(a,b){if(window.isArray(a)){for(var c=0,d=a.length;d>c;c++)if(!e.canCopyTo(a[c],b))return!1;return!0}return b.is_file?!1:a.id==b.id?!1:a.parent_id==b.id?!1:!0},e.canMoveTo=function(a,b){if(window.isArray(a)){for(var c=0,d=a.length;d>c;c++)if(!e.canMoveTo(a[c],b))return!1;return!0}return b.is_file?!1:!b.is_file&&a.root_id==b.root_id&&b.path.startsWith(a.path)?!1:a.id==b.id?!1:a.parent_id==b.id?!1:!0},e._copyHere=function(a,c){return b.service.post("filesystem/"+a.id+"/copy/",{name:c}).done(function(){b.events.dispatch("filesystem/copy",{items:[a],name:c})})},e._copy=function(a,c){return b.service.post("filesystem/"+a.id+"/copy/",{folder:c.id}).done(function(){b.events.dispatch("filesystem/copy",{items:[a],to:c})})},e._copyMany=function(a,c){return b.service.post("filesystem/items/",{action:"copy",items:a,to:c}).done(function(){b.events.dispatch("filesystem/copy",{items:a,to:c})})},e.move=function(c,d){if(c){if(window.isArray(c)&&c.length>1){if(d)return e._moveMany(c,d);var f=a.Deferred();return b.ui.dialogs.folderSelector({title:b.ui.texts.get("moveMultipleFileDialogTitle"),message:b.ui.texts.get("moveMultipleFileMessage",[c.length]),actionTitle:b.ui.texts.get("moveFileDialogAction"),handler:{onSelect:function(b){a.when(e._moveMany(c,b)).then(f.resolve,f.reject)},canSelect:function(a){return e.canMoveTo(c,a)}}}),f.promise()}if(window.isArray(c)&&(c=c[0]),d)return e._move(c,d);var g=a.Deferred();return b.ui.dialogs.folderSelector({title:b.ui.texts.get("moveFileDialogTitle"),message:b.ui.texts.get("moveFileMessage",[c.name]),actionTitle:b.ui.texts.get("moveFileDialogAction"),handler:{onSelect:function(b){a.when(e._move(c,b)).then(g.resolve,g.reject)},canSelect:function(a){return e.canMoveTo(c,a)}}}),g.promise()}},e._move=function(a,c){return b.service.post("filesystem/"+a.id+"/move/",{id:c.id}).done(function(){b.events.dispatch("filesystem/move",{items:[a],to:c})})},e._moveMany=function(a,c){return b.service.post("filesystem/items/",{action:"move",items:a,to:c}).done(function(){b.events.dispatch("filesystem/move",{items:a,to:c})})},e.rename=function(c,d){if(d&&0!==d.length)return e._rename(c,d);var f=a.Deferred();return b.ui.dialogs.input({title:b.ui.texts.get(c.is_file?"renameDialogTitleFile":"renameDialogTitleFolder"),message:b.ui.texts.get("renameDialogNewName"),defaultValue:c.name,yesTitle:b.ui.texts.get("renameDialogRenameButton"),noTitle:b.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(a){return!!a&&a.length>0&&a!=c.name},onInput:function(b){a.when(e._rename(c,b)).then(f.resolve,f.reject)}}}),f.promise()},e._rename=function(a,c){return b.service.put("filesystem/"+a.id+"/name/",{name:c}).done(function(){b.events.dispatch("filesystem/rename",{items:[a],name:c})})},e._handleDenied=function(c,d,e,f,g){var h=a.Deferred(),i=[],j=function(a){if(!window.isArray(e.target))return e.target;for(var b=0,c=e.target.length;c>b;b++)if(e.target[b].id==a)return e.target[b];return null};for(var k in e.items){var l=b.plugins.get(k);if(!l||!l.actionValidationHandler)return!1;var m=l.actionValidationHandler();i.push(m);for(var n=e.items[k],o=0,p=n.length;p>o;o++){var q=n[o];q.item=j(q.item)}}for(var r=[],s=[],t=[],u=0,v=i.length;v>u;u++)for(var w=i[u].getValidationMessages(c,e.items[k],e),x=0,y=w.length;y>x;x++){var z=w[x];t.push(z.acceptKey),r.push(z.message),z.acceptable||s.push(z.message)}return 0===s.length?b.ui.dialogs.confirmActionAccept(g,r,function(){h.resolve(t)},h.reject):(b.ui.dialogs.showActionDeniedMessage(f,s),h.reject()),h},e.del=function(c){if(c){var d=a.Deferred();return window.isArray(c)&&c.length>1?(e._delMany(c).done(d.resolve).fail(function(a){109==a.code&&a.data&&a.data.items?(this.handled=!0,e._handleDenied("delete",c,a.data,b.ui.texts.get("actionDeniedDeleteMany"),b.ui.texts.get("actionAcceptDeleteMany",c.length)).done(function(a){e._delMany(c,a).done(d.resolve).fail(d.reject)}).fail(function(){d.reject(a)})):d.reject(a)}),d.promise()):(window.isArray(c)&&(c=c[0]),e._del(c).done(d.resolve).fail(function(a){109==a.code&&a.data&&a.data.items?(this.handled=!0,e._handleDenied("delete",c,a.data,b.ui.texts.get("actionDeniedDelete",c.name),b.ui.texts.get("actionAcceptDelete",c.name)).done(function(a){e._del(c,a).done(d.resolve).fail(d.reject)}).fail(function(){d.reject(a)})):d.reject(a)}),d.promise())}},e._del=function(a,c){return b.service.del("filesystem/"+a.id,c?{acceptKeys:c}:null).done(function(){b.events.dispatch("filesystem/delete",{items:[a]})})},e._delMany=function(a,c){return b.service.post("filesystem/items/",{action:"delete",items:a,acceptKeys:c?c:null}).done(function(){b.events.dispatch("filesystem/delete",{items:a})})},e.createFolder=function(a,c){return b.service.post("filesystem/"+a.id+"/folders/",{name:c}).done(function(){b.events.dispatch("filesystem/createfolder",{items:[a],name:c})})};var f=b.plugins;f._list={},f.register=function(a){var b=a.id;b&&(f._list[b]=a)},f.initialize=function(){var c=a.Deferred(),d=[];for(var e in f._list){var g=f._list[e];if(g.initialize&&g.initialize(),g.resources){var h=g.backendPluginId||e;g.resources.texts&&d.push(b.settings.texts_js?b.dom.importScript(b.plugins.getJsLocalizationUrl(h)):b.ui.texts.loadPlugin(h)),g.resources.css&&b.dom.importCss(b.plugins.getStyleUrl(h))}}return 0===d.length?c.resolve().promise():(a.when.apply(a,d).done(c.resolve).fail(c.reject),c.promise())},f.get=function(a){return window.def(a)?f._list[a]:f._list},f.exists=function(a){return!!f._list[a]},f.url=function(a,c,d){var e=b.settings["service-path"]+"plugin/"+a;return c?e+(d?"/admin/":"/client/")+c:e},f.adminUrl=function(a,b){return f.url(a)+"/admin/"+b},f.getLocalizationUrl=function(a){return b.settings["service-path"]+"plugin/"+a+"/localization/texts_"+b.ui.texts.locale+".json"},f.getStyleUrl=function(a,b){return f.url(a,"style.css",b)},f.getItemContextRequestData=function(a){var b={};for(var c in f._list){var d=f._list[c];if(d.itemContextRequestData){var e=d.itemContextRequestData(a);e&&(b[c]=e)}}return b},f.getItemContextPlugins=function(a,b){var c={};if(!b)return c;var d=b.details;if(!d||!d.plugins)return c;for(var e in f._list){var g=f._list[e];if(g.itemContextHandler){var h=g.itemContextHandler(a,b,d.plugins[e]);h&&(c[e]=h)}}return c},f.getItemCollectionPlugins=function(a,b){var c={};if(!a||!window.isArray(a)||a.length<1)return c;for(var d in f._list){var e=f._list[d];if(e.itemCollectionHandler){var g=e.itemCollectionHandler(a,b);g&&(c[d]=g)}}return c},f.getMainViewPlugins=function(){var a=[];for(var b in f._list){var c=f._list[b];c.mainViewHandler&&a.push(c)}return a},f.getFileViewPlugins=function(){var a=[];for(var b in f._list){var c=f._list[b];c.fileViewHandler&&a.push(c)}return a},f.getConfigViewPlugins=function(){var a=[];for(var b in f._list){var c=f._list[b];c.configViewHandler&&a.push(c)}return a};var g=b.features;g.hasFeature=function(a){return b.session.features&&b.session.features[a]};var h=b.templates;h._loaded=[],h.url=function(a){var c=b.settings["template-url"]||"templates/";return b.helpers.noncachedUrl(b.resourceUrl(c+a))},h.load=function(c,d){var e=a.Deferred();return h._loaded.indexOf(c)>=0?e.resolve():(a.get(d?b.resourceUrl(d):h.url(c)).done(function(b){h._loaded.push(c),a("body").append(b),e.resolve()}).fail(function(){e.reject()}),e)};var i=b.dom;i._hiddenLoaded=[],i.importScript=function(c){var d=b.resourceUrl(c);if(!d)return a.Deferred().resolve().promise();var e=a.Deferred();return a.getScript(d,e.resolve).fail(function(){new b.ui.FullErrorView("Failed to load script ","<code>"+d+"</code>").show()}),e.promise()},i.importCss=function(c){var d=b.resourceUrl(c);if(d){var e=a("<link>");e.attr({type:"text/css",rel:"stylesheet",href:b.helpers.noncachedUrl(d)}),a("head").append(e)}},i.loadContent=function(c,d,e){if(i._hiddenLoaded.indexOf(c)>=0)return void(e&&e());var f=b.resourceUrl(d);if(!f)return void(e&&e());var g="mollify-tmp-"+b._hiddenInd++;a('<div id="'+g+'" style="display:none"/>').appendTo(a("body")).load(b.helpers.noncachedUrl(f),function(){i._hiddenLoaded.push(c),e&&e()})},i.loadContentInto=function(a,c,d,e){var f=b.resourceUrl(c);f&&a.load(b.helpers.noncachedUrl(f),function(){e&&b.ui.process(a,e,d),"function"==typeof d?d():d.onLoad&&d.onLoad(a)})},i.template=function(c,d,e){var f=c;return b.settings["resource-map"]&&b.settings["resource-map"]["template:"+c]&&(f=b.settings["resource-map"]["template:"+c]),a("#"+f).tmpl(d,e)},b.helpers={getPluginActions:function(b){var c=[];if(b)for(var d in b){var e=b[d];e.actions&&(c.push({title:"-",type:"separator"}),a.merge(c,e.actions))}for(var f=[],g=-1,h=0,i=c.length;i>h;h++){var j=c[h];"download"==j.group&&(0>g&&(g=h),f.push(j))}if(f.length>1){for(var k=1,l=f.length;l>k;k++)c.remove(f[k]);c[g]={type:"submenu",items:f,title:f[0].title,group:f[0].group,primary:f[0]}}return c},getPrimaryActions:function(a){if(!a)return[];var b=[],c=function(a){for(var c=0,d=a.length;d>c;c++){var e=a[c];("primary"==e.type||"download"==e.group)&&b.push(e)}};return c(a),b},getSecondaryActions:function(a){if(!a)return[];for(var c=[],d=0,e=a.length;e>d;d++){var f=a[d];"download"!=f.id&&"primary"!=f.type&&c.push(f)}return b.helpers.cleanupActions(c)},cleanupActions:function(a){if(!a)return[];for(var b=-1,c=a.length-1,d=0;c>=d;c--){var e=a[c];if("separator"!=e.type&&"-"!=e.title){b=c;break}}if(0>b)return[];for(var f=-1,g=0;b>=g;g++){var h=a[g];if("separator"!=h.type&&"-"!=h.title){f=g;break}}a=a.splice(f,b-f+1);for(var i=!1,j=a.length-1,k=0;j>=k;j--){var l=a[j],m="separator"==l.type||"-"==l.title;m&&i&&a.splice(j,1),i=m}return a},breakUrl:function(a){var c=a.split("?");return{path:c[0],params:b.helpers.getUrlParams(a),paramsString:c.length>1?"?"+c[1]:""}},getUrlParams:function(b){var c={};return a.each(b.substring(1).split("&"),function(a,b){var d=b.split("=");!d||d.length<2||(c[decodeURIComponent(d[0])]=decodeURIComponent(d[1]))}),c},urlWithParam:function(a,b,c){var d=b;return c&&(d=b+"="+encodeURIComponent(c)),a+(window.strpos(a,"?")?"&":"?")+d},noncachedUrl:function(a){return b.helpers.urlWithParam(a,"_="+b._time)},hasPermission:function(a,c,d){if(!a||void 0===a[c])return!1;var e=a[c],f=b.session.data.permission_types.values[c];if(!d||!f)return"1"==e;var g=f.indexOf(e),h=f.indexOf(d);return g>=h},formatDateTime:function(a,b){var c=a.toString(b);return c},parseInternalTime:function(a){if(!a||null==a||"string"!=typeof a||14!=a.length)return null;var b=new Date;return b.setYear(a.substring(0,4)),b.setMonth(a.substring(4,6)-1),b.setDate(a.substring(6,8)),b.setHours(a.substring(8,10)),b.setMinutes(a.substring(10,12)),b.setSeconds(a.substring(12,14)),b},formatInternalTime:function(a){return a?b.helpers.formatDateTime(a,"yyyyMMddHHmmss"):null},mapByKey:function(a,b,c){var d={};if(!a)return d;for(var e=0,f=a.length;f>e;e++){var g=a[e];if(window.def(g)){var h=g[b];window.def(h)&&(d[h]=window.def(c)&&g[c]?g[c]:g)}}return d},getKeys:function(a){var b=[];if(a)for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},extractValue:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=a[d];c.push(f[b])}return c},filter:function(b,c){var d=[];return a.each(b,function(a,b){c(b)&&d.push(b)}),d},arrayize:function(a){var b=[];return window.isArray(a)?a:(b.push(a),b)}},window.mollify=b,window.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return a&&0!==a.length?this.substring(0,a.length)==a:!1}),"function"!=typeof String.prototype.count&&(String.prototype.count=function(a){var b=this.match(new RegExp(a.toString().replace(/(?=[.\\+*?\[\^\]$(){}\|])/g,"\\"),"g"));return b?b.length:0}),window.def=function(a){return"undefined"!=typeof a},Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){for(var c=b||0,d=this.length;d>c;c++)if(this[c]===a)return c;return-1}),Array.prototype.remove||(Array.prototype.remove=function(a,b){if("undefined"==typeof b&&"object"==typeof a&&(a=this.indexOf(a)),!(0>a)){var c=this.slice((b||a)+1||this.length);return this.length=0>a?this.length+a:a,this.push.apply(this,c)}}),window.strpos=function(a,b,c){var d=(a+"").indexOf(b,c||0);return-1===d?!1:d};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=window.Base64._utf8_encode(a);j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)e=this._keyStr.indexOf(a.charAt(j++)),f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,i+=String.fromCharCode(b),64!=g&&(i+=String.fromCharCode(c)),64!=h&&(i+=String.fromCharCode(d));return i=window.Base64._utf8_decode(i)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=0,e=0;c<a.length;)if(d=a.charCodeAt(c),128>d)b+=String.fromCharCode(d),c++;else if(d>191&&224>d)e=a.charCodeAt(c+1),b+=String.fromCharCode((31&d)<<6|63&e),c+=2;else{e=a.charCodeAt(c+1);var f=a.charCodeAt(c+2);b+=String.fromCharCode((15&d)<<12|(63&e)<<6|63&f),c+=3}return b}}}(window.jQuery),!function(a,b){"use strict";b.view.LoginView=function(){var c=this;c.init=function(a){b.dom.loadContentInto(a,b.templates.url("loginview.html"),c,["localize","bubble"])},c.onLoad=function(){b.features.hasFeature("lost_password")&&a("#mollify-login-forgot-password").show(),b.features.hasFeature("registration")&&b.plugins.exists("plugin-registration")&&a("#mollify-login-register").click(function(){b.plugins.get("plugin-registration").show()}).show(),a("#mollify-login-name, #mollify-login-password").bind("keypress",function(a){13==(a.keyCode||a.which)&&c.onLogin()}),a("#mollify-login-button").click(c.onLogin),a("#mollify-login-name").focus()},c.onRenderBubble=function(){},c.onShowBubble=function(d,e){"mollify-login-forgot-password"===d&&(a("#mollify-login-forgot-button").click(function(){var d=a("#mollify-login-forgot-email").val();d&&(e.hide(),c.wait=b.ui.dialogs.wait({target:"mollify-login-main"}),c.onResetPassword(d))}),a("#mollify-login-forgot-email").val("").focus())},c.onLogin=function(){var d=a("#mollify-login-name").val(),e=a("#mollify-login-password").val(),f=a("#mollify-login-remember-cb").is(":checked");return!d||d.length<1?void a("#mollify-login-name").focus():!e||e.length<1?void a("#mollify-login-password").focus():(c.wait=b.ui.dialogs.wait({target:"mollify-login-main"}),void b.service.post("session/authenticate",{username:d,password:window.Base64.encode(e),remember:f}).done(function(a){b.events.dispatch("session/start",a)}).fail(function(a){107==a.code&&(this.handled=!0),c.showLoginError()}))},c.onResetPassword=function(a){b.service.post("lostpassword",{email:a}).done(function(){c.wait.close(),b.ui.dialogs.notification({message:b.ui.texts.get("resetPasswordPopupResetSuccess")})}).fail(function(){this.handled=!0,c.wait.close(),b.ui.dialogs.info({message:b.ui.texts.get("resetPasswordPopupResetFailed")})})},c.showLoginError=function(){c.wait.close(),b.ui.dialogs.notification({message:b.ui.texts.get("loginDialogLoginFailedMessage")})}}}(window.jQuery,window.mollify),!function(a,b){"use strict";b.view.MainView=function(){var c=this;this._mainFileView=!1,this._mainConfigView=!1,this._views=[],this._currentView=!1,this.init=function(d,e){c._mainFileView=new b.view.MainViewFileView,c._mainConfigView=new b.view.MainViewConfigView,c._views=[this._mainFileView,this._mainConfigView],a.each(b.plugins.getMainViewPlugins(),function(a,b){if(b.mainViewHandler){var d=b.mainViewHandler();c._views.push(d)}}),c.itemContext=new b.ui.itemContext,b.dom.loadContentInto(d,b.templates.url("mainview.html"),function(){c.onLoad(e)},["localize"])},this.onLoad=function(d){a(window).resize(c.onResize),c.onResize(),b.dom.template("mollify-tmpl-main-username",b.session).appendTo("#mollify-mainview-user"),b.session.user&&b.ui.controls.dropdown({element:a("#mollify-username-dropdown"),items:c.getSessionActions()});var e=[];a.each(c._views,function(a,b){b.init(c),e.push({icon:b.icon,title:b.title})});var f=a("#mollify-mainview-menu"),g=b.dom.template("mollify-tmpl-main-menubar",e).appendTo(f);if(g.click(function(){var b=g.index(a(this));c.activateView(c._views[b])}),c._views.length>0){var h=!1;d&&(h=c._findView(d[0]),d=d.slice(1),(0===d.length||1==d.length&&""===d[0])&&(d=!1)),h||(h=c._views[0],d=!1),c.activateView(h,d)}},this._findView=function(b){var d=!1;return a.each(c._views,function(a,c){return c.viewId==b?(d=c,!1):void 0}),d},this.onRestoreView=function(a){var b=a[0];if(c._currentView&&c._currentView.viewId==b)c._currentView.onRestoreView(a.slice(1));else{var d=c._findView(b);d&&(b=a.slice(1),(0===b.length||1==b.length&&""===b[0])&&(b=!1),c.activateView(d,b))}},this.activateView=function(d,e){b.ui.hideActivePopup(),c._currentView&&c._currentView.onDeactivate&&c._currentView.onDeactivate(),a("#mollify-mainview-navlist-parent").empty(),c._currentView=d,a("#mollify-mainview-navbar").empty(),d.onActivate({id:e,content:a("#mollify-mainview-viewcontent").empty(),tools:a("#mollify-mainview-viewtools").empty(),addNavBar:c.addNavBar,mainview:c,fileview:c._mainFileView});var f=a("#mollify-mainview-menu"),g=f.find(".mollify-mainview-menubar-item").removeClass("active"),h=c._views.indexOf(d);a(g.get(h)).addClass("active")},this.onNotification=function(c){var d=c&&c.target?"string"==typeof c.target?a("#"+c.target):c.target:a("#mollify-mainview-content"),e=b.dom.template("mollify-tmpl-main-notification",c).hide().appendTo(d).fadeIn(300);return setTimeout(function(){e.fadeOut(300),setTimeout(e.remove,300),c["on-finish"]&&c["on-finish"]()},3e3|c.time),!0},this.getActiveView=function(){return c._currentView},this.addNavBar=function(c){var d=b.dom.template("mollify-tmpl-main-navbar",c).appendTo(a("#mollify-mainview-navlist-parent")),e=c.items,f=function(){var f=d.find(".mollify-mainview-navbar-item");c.classes&&f.addClass(c.classes),c.dropdown&&f.each(function(d,g){var h=e[f.index(this)],i=a('<li class="mollify-mainview-navbar-dropdown"><a href="#" class="dropdown-toggle"><i class="icon-cog"></i></a></li>').appendTo(a(g)),j=[];"function"!=typeof c.dropdown.items&&(j=c.dropdown.items),b.ui.controls.dropdown({element:i,items:j,onShow:function(a,b){b.length>0||"function"==typeof c.dropdown.items&&a.items(c.dropdown.items(h.obj))}})}),f.click(function(){var a=e[f.index(this)];a.callback&&a.callback()}),c.onRender&&c.onRender(d,f,function(a){var b=f.index(a);return e[b].obj})};return f(),{element:d,setActive:function(b){var c=d.find(".mollify-mainview-navbar-item");c.removeClass("active"),b&&a.each(c,function(c,d){var f=e[c].obj;if(f){var g=window.def(b.id)?b.id==f.id:b==f;return g?(a(d).addClass("active"),!1):void 0}})},update:function(a){e=a,d.find(".mollify-mainview-navbar-item").remove(),b.dom.template("mollify-tmpl-main-navbar-item",e).appendTo(d),f()}}},this.onResize=function(){c._currentView&&c._currentView.onResize()},this.getSessionActions=function(){var a=[];return b.features.hasFeature("change_password")&&b.session.user.hasPermission("change_password")&&(a.push({"title-key":"mainViewChangePasswordTitle",callback:c.changePassword}),a.push({title:"-"})),a.push({"title-key":"mainViewLogoutTitle",callback:c.onLogout}),a},this.onLogout=function(){b.service.post("session/logout").done(function(){b.events.dispatch("session/end")})},this.changePassword=function(){var c=!1,d=!1,e=!1,f=!1,g=b.ui.texts.get("mainviewChangePasswordErrorValueMissing"),h=b.ui.texts.get("mainviewChangePasswordErrorConfirm"),i=function(a,d,e){b.service.put("configuration/users/current/password/",{old:window.Base64.encode(a),"new":window.Base64.encode(d)}).done(function(){e(),b.ui.dialogs.notification({message:b.ui.texts.get("mainviewChangePasswordSuccess")})}).fail(function(a){this.handled=!0,107==a.code?b.ui.dialogs.notification({message:b.ui.texts.get("mainviewChangePasswordError"),type:"error",cls:"full",target:c.find(".modal-footer")}):this.handled=!1})};b.ui.dialogs.custom({title:b.ui.texts.get("mainviewChangePasswordTitle"),content:a("#mollify-tmpl-main-changepassword").tmpl({message:b.ui.texts.get("mainviewChangePasswordMessage")}),buttons:[{id:"yes",title:b.ui.texts.get("mainviewChangePasswordAction"),cls:"btn-primary"},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,b){var j=!1,k=!1,l=!1;("yes"!==a.id||(c.find(".control-group").removeClass("error"),c.find(".help-inline").text(""),j=d.find("input").val(),k=e.find("input").val(),l=f.find("input").val(),j||(d.addClass("error"),d.find(".help-inline").text(g)),k||(e.addClass("error"),e.find(".help-inline").text(g)),l||(f.addClass("error"),f.find(".help-inline").text(g)),k&&l&&k!=l&&(e.addClass("error"),f.addClass("error"),e.find(".help-inline").text(h),f.find(".help-inline").text(h)),j&&k&&l&&k==l))&&("yes"===a.id?i(j,k,b.close):b.close())},"on-show":function(b,g){c=g,d=a("#mollify-mainview-changepassword-old"),e=a("#mollify-mainview-changepassword-new1"),f=a("#mollify-mainview-changepassword-new2"),d.find("input").focus()}})}},b.view.MainViewFileView=function(){var f=this;this.viewId="files",this._currentFolder=!1,this._currentFolderData=!1,this._viewStyle=0,this._selected=[],this._customFolderTypes={},this._selectedItems=[],this._formatters={byteSize:new b.ui.formatters.ByteSize(new b.ui.formatters.Number(2,!1,b.ui.texts.get("decimalSeparator"))),timestamp:new b.ui.formatters.Timestamp(b.ui.texts.get("shortDateTimeFormat")),uploadSpeed:new b.ui.formatters.Number(1,b.ui.texts.get("dataRateKbps"),b.ui.texts.get("decimalSeparator"))},this._filelist={columns:[],addColumn:function(a){f._filelist.columns[a.id]=a}},this._filelist.addColumn({id:"name","title-key":"fileListColumnTitleName",sort:function(a,b,c){return a.name.toLowerCase().localeCompare(b.name.toLowerCase())*c},content:function(a){return a.name}}),this._filelist.addColumn({id:"path","title-key":"fileListColumnTitlePath",sort:function(a,c,d){var e=b.filesystem.rootsById[a.root_id].name+a.path,f=b.filesystem.rootsById[c.root_id].name+c.path;return e.toLowerCase().localeCompare(f.toLowerCase())*d},content:function(a){return'<span class="item-path-root">'+b.filesystem.rootsById[a.root_id].name+'</span>: <span class="item-path-val">'+a.path+"</span>"}}),this._filelist.addColumn({id:"type","title-key":"fileListColumnTitleType",sort:function(a,b,c){var d=a.is_file?a.extension||"":"",e=b.is_file?b.extension||"":"";return d.toLowerCase().localeCompare(e.toLowerCase())*c},content:function(a){return a.is_file?a.extension||"":""}}),this._filelist.addColumn({id:"size","title-key":"fileListColumnTitleSize","min-width":75,sort:function(a,b,c){var d=a.is_file?parseInt(a.size,10):0,e=b.is_file?parseInt(b.size,10):0;return(d-e)*c},content:function(a){return a.is_file?f._formatters.byteSize.format(a.size):""}}),this._filelist.addColumn({id:"file-modified","request-id":"core-file-modified","title-key":"fileListColumnTitleLastModified",width:180,sort:function(a,b,c,d){if(!a.is_file&&!b.is_file)return 0;if(!d||!d["core-file-modified"])return 0;var e=d["core-file-modified"][a.id]?1*d["core-file-modified"][a.id]:0,f=d["core-file-modified"][b.id]?1*d["core-file-modified"][b.id]:0;return(e>f?1:-1)*c},content:function(a,c){return a.id&&a.is_file&&c&&c["core-file-modified"]&&c["core-file-modified"][a.id]?f._formatters.timestamp.format(b.helpers.parseInternalTime(c["core-file-modified"][a.id])):""}}),this._filelist.addColumn({id:"item-description","request-id":"core-item-description","title-key":"fileListColumnTitleDescription",sort:function(a,b,c,d){if(!a.is_file&&!b.is_file)return 0;if(!d||!d["core-item-description"])return 0;var e=d["core-item-description"][a.id]?d["core-item-description"][a.id]:"",f=d["core-item-description"][b.id]?d["core-item-description"][b.id]:"";return(e>f?1:-1)*c},content:function(a,b){if(!(a.id&&b&&b["core-item-description"]&&b["core-item-description"][a.id]))return"";var c=b["core-item-description"][a.id],d=c.replace(/<\/?[^>]+(>|$)/g,"");return'<div class="item-description-container" title="'+d+'">'+c+"</div>"}}),this._filelist.addColumn({id:"go-into-folder",title:"",width:25,sort:function(){return 0},content:function(a){return a.is_file?"":'<div class="go-into-folder"><i class="icon-level-down"></i></div>'},"on-init":function(b){b.$i.delegate(".go-into-folder","click",function(){var c=b.getItemForElement(a(this));if(c&&!c.is_file)return f.changeToFolder(c),!1})}}),this.init=function(){f.title=b.ui.texts.get("mainviewMenuTitle"),f.icon="icon-file-alt",f._viewStyle=0,"small-icon"==b.settings["file-view"]["default-view-mode"]&&(f._viewStyle=1),"large-icon"==b.settings["file-view"]["default-view-mode"]&&(f._viewStyle=2),b.events.addEventHandler(f.onEvent),f.addCustomFolderType("search",{onSelectFolder:function(c){var d=a.Deferred();if(!c)return d.resolve({type:"search",id:""},{items:[],info:[]});var e=decodeURIComponent(c);return b.service.post("filesystem/search",{text:e,rq_data:f.getDataRequest()}).done(function(a){var b=[];
for(var f in a.matches)b.push(a.matches[f].item);var g={id:c,type:"search"},h={text:e,items:b,data:a.data,info:a};d.resolve(g,h)}),d.promise()},onRenderFolderView:function(c,d,e){b.dom.template("mollify-tmpl-main-searchresults",{folder:c,info:d}).appendTo(e),a("#mollify-searchresults-title-text").text(b.ui.texts.get("mainViewSearchResultsTitle",[""+d.info.count])),a("#mollify-searchresults-desc-text").text(b.ui.texts.get("mainViewSearchResultsDesc",[d.text]));var g=a("#mollify-fileview-folder-actions");f.addCommonFileviewActions(g)},onItemListRendered:function(c,d){var e=function(b){var c="",d=!0;return a.each(b,function(a,b){d||(c+=", "),c+=b.type,d=!1}),c},f=b.ui.texts.get("mainViewSearchResultTooltipMatches");a(".mollify-filelist-item").each(function(){var c=a(this),g=c.tmplItem().data,h=b.filesystem.rootsById[g.root_id].name+"/"+g.path+", "+f+e(d.info.matches[g.id].matches);b.ui.controls.tooltip(c,{title:h})})}}),a.each(b.plugins.getFileViewPlugins(),function(a,b){if(b.fileViewHandler.onInit&&b.fileViewHandler.onInit(f),b.fileViewHandler.filelistColumns){var c=b.fileViewHandler.filelistColumns();if(c)for(var d=0;d<c.length;d++)f._filelist.addColumn(c[d])}}),f.itemContext=new b.ui.itemContext},this.addCustomFolderType=function(a,b){this._customFolderTypes[a]=b},this.onResize=function(){},this.onActivate=function(d){b.dom.template("mollify-tmpl-fileview").appendTo(d.content),f.showProgress();var e=[];if(a.each(b.filesystem.roots,function(a,b){e.push({title:b.name,obj:b,callback:function(){f.changeToFolder(b)}})}),f.rootNav=d.addNavBar({title:b.ui.texts.get("mainViewRootsTitle"),items:e,onRender:b.ui.draganddrop?function(a,c,d){b.ui.draganddrop.enableDrop(c,{canDrop:function(a,b,c){if(!c||"filesystemitem"!=c.type)return!1;var e=c.payload,g=d(a);return f.canDragAndDrop(g,e)},dropType:function(a,b,c){if(!c||"filesystemitem"!=c.type)return!1;var e=c.payload,g=d(a);return f.dropType(g,e)},onDrop:function(a,b,c){if(c&&"filesystemitem"==c.type){var e=c.payload,g=d(a);f.onDragAndDrop(g,e)}}})}:!1}),f.initViewTools(d.tools),f.initList(),f.uploadProgress=new c(a("#mollify-mainview-progress")),f._dndUploader=!1,b.ui.uploader&&b.ui.uploader.initDragAndDropUploader&&(f._dndUploader=b.ui.uploader.initDragAndDropUploader({container:b.App.getElement(),dropElement:a("#mollify-folderview"),handler:f._getUploadHandler()})),f._scrollOutThreshold=1e5,f._scrollInThreshold=0,a(window).bind("scroll",f._updateScroll),a.each(b.plugins.getFileViewPlugins(),function(a,c){c.fileViewHandler.onActivate&&c.fileViewHandler.onActivate(b.App.getElement(),d)}),0===b.filesystem.roots.length)return void f.showNoRoots();var g=b.request.getParams();return g.path?void b.filesystem.findFolder({path:g.path},f.getDataRequest()).done(function(a){var b=a.folder;f.changeToFolder(b)}).fail(function(a){203==a.code&&(b.ui.dialogs.error({message:b.ui.texts.get("mainviewFolderNotFound",g.path)}),this.handled=!0),f.hideProgress(),f.openInitialFolder()}):void(d.id?f.changeToFolder(d.id.join("/")).fail(function(){this.handled=!0,f.hideProgress(),f.openInitialFolder()}):f.openInitialFolder())},this.onRestoreView=function(a){f.changeToFolder(a.join("/"),!0)},this._getUploadHandler=function(c){return{isUploadAllowed:function(c){if(!c)return!1;var d=!0;return a.each(c,function(a){var e=c[a].name;if(e){var f=e.split(".").pop();f&&(f=f.toLowerCase(),b.session.data.filesystem.forbidden_file_upload_types.length>0&&b.session.data.filesystem.forbidden_file_upload_types.indexOf(f)>=0&&(d=!1),b.session.data.filesystem.allowed_file_upload_types.length>0&&b.session.data.filesystem.allowed_file_upload_types.indexOf(f)<0&&(d=!1))}}),d||b.ui.dialogs.notification({message:b.ui.texts.get("mainviewFileUploadNotAllowed"),type:"warning"}),d},start:function(a,c){f.uploadProgress.show(b.ui.texts.get(a.length>1?"mainviewUploadProgressManyMessage":"mainviewUploadProgressOneMessage",a.length),function(){c()})},progress:function(a,b){var c="";b&&(c=f._formatters.uploadSpeed.format(b/1024)),f.uploadProgress.set(a,c)},finished:function(){c&&c.close(),f.uploadProgress.hide(),b.ui.dialogs.notification({message:b.ui.texts.get("mainviewFileUploadComplete"),type:"success"}),f.refresh()},failed:function(){c&&c.close(),f.uploadProgress.hide(),b.ui.dialogs.notification({message:b.ui.texts.get("mainviewFileUploadFailed"),type:"error"})}}},this._updateScroll=function(){var b=a(window).scrollTop(),c=a("#mollify-folderview"),d=c.hasClass("detached"),e=!d&&b>f._scrollOutThreshold||d&&b<f._scrollInThreshold;e&&(d?a("#mollify-folderview").removeClass("detached"):a("#mollify-folderview").addClass("detached"))},this.openInitialFolder=function(){0===b.filesystem.roots.length?f.showNoRoots():f.changeToFolder(1==b.filesystem.roots.length?b.filesystem.roots[0]:null)},this.onDeactivate=function(){a(window).unbind("scroll"),f._dndUploader&&f._dndUploader.destroy(),a.each(b.plugins.getFileViewPlugins(),function(a,b){b.fileViewHandler.onDeactivate&&b.fileViewHandler.onDeactivate()})},this.initViewTools=function(c){b.dom.template("mollify-tmpl-fileview-tools").appendTo(c),b.ui.process(c,["radio"],f),f.controls["mollify-fileview-style-options"].set(f._viewStyle);var d=function(){var b=a("#mollify-fileview-search-input").val();b&&0!==b.length&&(a("#mollify-fileview-search-input").val(""),f.changeToFolder({type:"search",id:encodeURIComponent(b)}))};a("#mollify-fileview-search-input").keyup(function(a){13==a.which&&d()}),a("#mollify-fileview-search > button").click(d)},this.getDataRequest=function(){var b=f._currentFolder&&f._currentFolder.type?{}:{"core-parent-description":{}};return a.extend(b,f.itemWidget.getDataRequest?f.itemWidget.getDataRequest():{})},this.getCurrentFolder=function(){return f._currentFolder},this.onEvent=function(a){a.type.startsWith("filesystem/")&&f.refresh()},this.onRadioChanged=function(a,b,c){"mollify-fileview-style-options"==a&&f.onViewStyleChanged(b,c)},this.onViewStyleChanged=function(a,b){f._viewStyle=b,f.initList(),f.refresh()},this.showNoRoots=function(){f._currentFolder=!1,f._currentFolderData={items:b.filesystem.roots},f._updateUI()},this.showProgress=function(){a("#mollify-folderview-items").addClass("loading")},this.hideProgress=function(){a("#mollify-folderview-items").removeClass("loading")},this.changeToFolder=function(c,d){var e=c;return e?"string"!=typeof e&&(e=f._getFolderPublicId(e)):b.filesystem.roots&&(e=b.filesystem.roots[0].id),d||b.App.storeView("files/"+(e?e:"")),f._currentFolder&&f._currentFolder.type&&f._customFolderTypes[f._currentFolder.type]&&f._customFolderTypes[f._currentFolder.type].onFolderDeselect&&f._customFolderTypes[f._currentFolder.type].onFolderDeselect(f._currentFolder),window.scrollTo(0,0),f._selectedItems=[],f._currentFolder=!1,f._currentFolderData=!1,f.rootNav.setActive(!1),e?f._onSelectFolder(e):a.Deferred().resolve()},this._getFolderPublicId=function(a){return a?a.type&&f._customFolderTypes[a.type]?a.type+"/"+a.id:a.id:""},this._onSelectFolder=function(c){var d=function(){f.hideProgress()};b.ui.hideActivePopup(),f.showProgress();var e=c?c.split("/"):[];return e.length>1&&f._customFolderTypes[e[0]]?f._customFolderTypes[e[0]].onSelectFolder(e[1]).done(f._setFolder).fail(d):c&&1!=e.length?(f.hideProgress(),a.Deferred().reject()):b.filesystem.folderInfo(c?e[0]:null,!0,f.getDataRequest()).done(function(a){var b=a.folder,c=a;c.items=a.folders.slice(0).concat(a.files),f._setFolder(b,c)}).fail(d)},this.refresh=function(){f._currentFolder&&f._onSelectFolder(f._getFolderPublicId(f._currentFolder))},this._setFolder=function(a,b){f._currentFolder=a,f._currentFolderData=b,f.hideProgress(),f._updateUI()},this._canWrite=function(){return b.filesystem.hasPermission(f._currentFolder,"filesystem_item_access","rw")},this.onRetrieveUrl=function(a){f._currentFolder&&(f.showProgress(),b.service.post("filesystem/"+f._currentFolder.id+"/retrieve",{url:a}).done(function(){f.hideProgress(),f.refresh()}).fail(function(c){f.hideProgress(),301==c.code&&(this.handled=!0,b.ui.views.dialogs.error({message:b.ui.texts.get("mainviewRetrieveFileResourceNotFound",[a])}))}))},this.dropType=function(a,b){var c=!1;window.isArray(b)?0===b.length&&(c=b[0]):c=b;var d=!c||a.root_id!=c.root_id;return d?"copy":"move"},this.canDragAndDrop=function(a,c){var d=!1;if(window.isArray(c)?0===c.length&&(d=c[0]):d=c,d)return"copy"==f.dropType(a,d)?b.filesystem.canCopyTo(d,a):b.filesystem.canMoveTo(d,a);for(var e=!0,g=0;g<c.length;g++){var h=c[g];if(!("copy"==f.dropType(a,h)?b.filesystem.canCopyTo(h,a):b.filesystem.canMoveTo(h,a))){e=!1;break}}return e},this.onDragAndDrop=function(a,c){var d="copy"==f.dropType(a,c);d?b.filesystem.copy(c,a):b.filesystem.move(c,a)},this._updateUI=function(){var c={title:function(){return this.data.title?this.data.title:b.ui.texts.get(this.data["title-key"])}},d=a("#mollify-folderview-header-content").empty();if(f._currentFolder&&f._currentFolder.type)f._customFolderTypes[f._currentFolder.type]&&f._customFolderTypes[f._currentFolder.type].onRenderFolderView(f._currentFolder,f._currentFolderData,d,g);else{var e=f._currentFolderData&&f._currentFolderData.hierarchy?f._currentFolderData.hierarchy[0]:!1;f.rootNav.setActive(e),f._currentFolder?b.dom.template("mollify-tmpl-fileview-header",{canWrite:f._canWrite(),folder:f._currentFolder}).appendTo(d):b.dom.template("mollify-tmpl-main-rootfolders").appendTo(d);var g=a("#mollify-fileview-folder-tools").empty(),h=a("#mollify-fileview-folder-actions");if(f._currentFolder){f._canWrite()&&(b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-folder-close"},c).appendTo(g).click(function(){return b.ui.controls.dynamicBubble({element:a(this),content:b.dom.template("mollify-tmpl-main-createfolder-bubble"),handler:{onRenderBubble:function(c){var d=a("#mollify-mainview-createfolder-name-input"),e=function(){var a=d.val();a&&(c.hide(),b.filesystem.createFolder(f._currentFolder,a))};a("#mollify-mainview-createfolder-button").click(e),d.bind("keypress",function(a){13==(a.keyCode||a.which)&&e()}).focus()}}}),!1}),b.ui.uploader&&b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-upload-alt"},c).appendTo(g).click(function(){return b.ui.controls.dynamicBubble({element:a(this),content:b.dom.template("mollify-tmpl-main-addfile-bubble"),handler:{onRenderBubble:function(c){b.ui.uploader.initUploadWidget(a("#mollify-mainview-addfile-upload"),{url:b.filesystem.getUploadUrl(f._currentFolder),handler:f._getUploadHandler(c)}),b.features.hasFeature("retrieve_url")||a("#mollify-mainview-addfile-retrieve").remove();var d=function(){var b=a("#mollify-mainview-addfile-retrieve-url-input").val();return!b||b.length<4||0!==b.substring(0,4).toLowerCase().localeCompare("http")?!1:(c.close(),void f.onRetrieveUrl(b))};a("#mollify-mainview-addfile-retrieve-url-input").bind("keypress",function(a){13==(a.keyCode||a.which)&&d()}),a("#mollify-mainview-addfile-retrieve-button").click(d)}}}),!1}));var i=b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-cog",dropdown:!0},c).appendTo(h);b.ui.controls.dropdown({element:i,items:!1,hideDelay:0,style:"submenu",onShow:function(a,b){b||f.getItemActions(f._currentFolder,function(b){return b?void a.items(b):void a.hide()})}}),f.setupHierarchy(f._currentFolderData.hierarchy,g),f.showProgress()}f._dndUploader&&f._dndUploader.setUrl(f._canWrite()?b.filesystem.getUploadUrl(f._currentFolder):!1),f.addCommonFileviewActions(h)}b.ui.process(d,["localize"]),f._scrollOutThreshold=a("#mollify-folderview-header").outerHeight()+40,f._scrollInThreshold=f._scrollOutThreshold-60,a("#mollify-folderview-detachholder").css("height",f._scrollInThreshold+40+"px"),a("#mollify-folderview").removeClass("detached"),f.onResize(),f._updateSelect();var j=f._currentFolderData.data&&f._currentFolderData.data["core-parent-description"];j&&a("#mollify-folder-description").text(f._currentFolderData.data["core-parent-description"]);var k=a("#mollify-folder-description"),l=f._currentFolder&&!f._currentFolder.type&&k.length>0&&b.session.features.descriptions&&b.filesystem.hasPermission(f._currentFolder,"edit_description");l?b.ui.controls.editableLabel({element:k,hint:b.ui.texts.get("mainviewDescriptionHint"),onedit:function(a){b.service.put("filesystem/"+f._currentFolder.id+"/description/",{description:a})}}):j||k.hide(),f._updateList(),f.hideProgress()},this.addCommonFileviewActions=function(a){var c={title:function(){return this.data.title?this.data.title:b.ui.texts.get(this.data["title-key"])}};f._selectModeBtn=b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-check",dropdown:!0,style:"narrow",action:!0},c).appendTo(a).click(f._onToggleSelect),b.ui.controls.dropdown({element:f._selectModeBtn,items:!1,hideDelay:0,style:"submenu",onShow:function(a){f._getSelectionActions(function(b){return b?void a.items(b):void a.hide()})}}),b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-refresh"},c).appendTo(a).click(f.refresh)},this._getViewItems=function(){return f._currentFolderData.items},this._getSelectionActions=function(a){var c=[];if(f._selectMode&&f._selectedItems.length>0){var d=b.plugins.getItemCollectionPlugins(f._selectedItems);c=b.helpers.getPluginActions(d),c.length>0&&c.unshift({title:"-"})}c.unshift({"title-key":"mainViewFileViewSelectNone",callback:function(){f._updateSelect([])}}),c.unshift({"title-key":"mainViewFileViewSelectAll",callback:function(){f._updateSelect(f._getViewItems())}}),a(b.helpers.cleanupActions(c))},this._onToggleSelect=function(){f._selectMode=!f._selectMode,f._updateSelect()},this._updateSelect=function(a){void 0!==a&&(f._selectedItems=a,f._selectMode=!0),f._selectMode?f._selectModeBtn.addClass("active"):f._selectModeBtn.removeClass("active"),f.itemWidget.setSelectMode(f._selectMode),f._selectMode&&f.itemWidget.setSelection(f._selectedItems)},this._getRootItems=function(){for(var a=[],c=function(a){return function(){f.changeToFolder(a)}},d=0,e=b.filesystem.roots.length;e>d;d++){var g=b.filesystem.roots[d];a.push({title:g.name,callback:c(g)})}return a},this.setupHierarchy=function(c,d){{var e=c;d.append(b.dom.template("mollify-tmpl-fileview-folder-hierarchy",{items:e}))}b.ui.controls.dropdown({element:a("#mollify-folder-hierarchy-item-root"),items:f._getRootItems(),hideDelay:0,style:"submenu"});var g=a(".mollify-folder-hierarchy-item").click(function(){var b=a(this).tmplItem().data;f.changeToFolder(b)});b.ui.draganddrop&&b.ui.draganddrop.enableDrop(g.find("a"),{canDrop:function(a,b,c){if(!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.parent().tmplItem().data;return f.canDragAndDrop(e,d)},dropType:function(a,b,c){if(!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.tmplItem().data;return f.dropType(e,d)},onDrop:function(a,b,c){if(c&&"filesystemitem"==c.type){var d=c.payload,e=a.parent().tmplItem().data;f.onDragAndDrop(e,d)}}})},this.isListView=function(){return 0===f._viewStyle},this._handleCustomAction=function(a,c,d){if(!b.settings["file-view"]||!b.settings["file-view"].actions)return!1;var e=b.settings["file-view"].actions;if(!e[a]||"function"!=typeof e[a])return!1;var g=f._getCtxObj(c,d),h=e[a](c,g);return h?("string"==typeof h&&("open_popup"==h?f.itemContext.open(g):"open_menu"==h?f.showActionMenu(c,g.element):c.is_file||"go_into_folder"!=h||f.changeToFolder(c)),!0):!1},this._getCtxObj=function(c,d){return{item:c,viewtype:f.isListView()?"list":"icon",target:d,element:f.itemWidget.getItemContextElement(c),viewport:f.itemWidget.getContainerElement(),container:a("#mollify-folderview-items"),folder:f._currentFolder,folder_writable:f._currentFolder?b.filesystem.hasPermission(f._currentFolder,"filesystem_item_access","rw"):!1}},this.initList=function(){var c=a("#mollify-folderview-header-items").empty();if(f.isListView()){var g=b.settings["file-view"]["list-view-columns"];f.itemWidget=new e("mollify-folderview-items",c,"main",this._filelist,g)}else{var h=!!b.session.features.thumbnails;f.itemWidget=new d("mollify-folderview-items",c,"main",1==f._viewStyle?"iconview-small":"iconview-large",h)}f.itemWidget.init({onFolderSelected:f.onFolderSelected,canDrop:f.canDragAndDrop,dropType:f.dropType,onDrop:f.onDragAndDrop,onClick:function(a,b){if(!f._handleCustomAction("onClick",a,b)){var c=f._getCtxObj(a,b);if(f.isListView()&&"icon"!=b){var d=f._filelist.columns[b];if(d["on-click"])return void d["on-click"](a,f._currentFolderData.data,c)}var e=!1;f.isListView()?a.is_file?("name"==b||"icon"==b)&&(e=!0):"name"==b?f.changeToFolder(a):"icon"==b&&(e=!0):"info"==b||a.is_file?e=!0:f.changeToFolder(a),e&&f.itemContext.open(c)}},onDblClick:function(a){f._handleCustomAction("onDblClick",a)||a.is_file||f.changeToFolder(a)},onRightClick:function(a,b){f._handleCustomAction("onRightClick",a,b)||f.showActionMenu(a,f.itemWidget.getItemContextElement(a))},onContentRendered:function(a){f._currentFolder&&f._currentFolder.type&&f._customFolderTypes[f._currentFolder.type]&&f._customFolderTypes[f._currentFolder.type].onItemListRendered&&f._customFolderTypes[f._currentFolder.type].onItemListRendered(f._currentFolder,f._currentFolderData,a)},getSelectedItems:function(){return f._selectMode&&0!==f._selectedItems.length?f._selectedItems:!1},onSelectUnselect:function(a){f._selectedItems.indexOf(a)>=0?f._selectedItems.remove(a):f._selectedItems.push(a),f.itemWidget.setSelection(f._selectedItems)}})},this._updateList=function(){if(f._items=f._currentFolderData.items,f._itemsById=b.helpers.mapByKey(f._items,"id"),f._selectedItems){var c=[],d={};a.each(f._selectedItems,function(a,b){var e=f._itemsById[b.id];e&&!d[b.id]&&(c.push(e),d[b.id]=!0)}),f._selectedItems=c}f.itemWidget.content(f._items,f._currentFolderData.data),f._selectMode&&f.itemWidget.setSelection(f._selectedItems)},this.showActionMenu=function(a,c){c.addClass("open");var d=b.ui.controls.popupmenu({element:c,onHide:function(){c.removeClass("open"),f.itemWidget.removeHover()}});f.getItemActions(a,function(a){return a?void d.items(a):void d.hide()})},this.getItemActions=function(a,c){b.filesystem.itemDetails(a,b.plugins.getItemContextRequestData(a)).done(function(d){if(!d)return void c([]);var e={details:d,folder:f._currentFolder,folder_writable:f._currentFolder?b.filesystem.hasPermission(f._currentFolder,"filesystem_item_access","rw"):!1};c(b.helpers.cleanupActions(b.helpers.getPluginActions(b.plugins.getItemContextPlugins(a,e))))})}};var c=function(a){var b=this;return this._h=a.height(),b._$title=a.find(".title"),b._$speed=a.find(".speed"),b._$bar=a.find(".bar"),{show:function(c,d){a.css("bottom",0-b._h+"px"),b._$title.text(c?c:""),b._$speed.text(""),b._$bar.css("width","0%"),a.show().animate({bottom:"0"},500,d)},set:function(a,c){b._$bar.css("width",a+"%"),b._$speed.text(c?c:"")},hide:function(c){setTimeout(function(){a.animate({bottom:0-b._h+"px"},500,function(){b._$bar.css("width","0%"),a.hide(),c&&c()})},1e3)}}},d=function(c,d,e,f,g){var h=this;h.$c=a("#"+c),h.viewId="mollify-iconview-"+e,this.init=function(c){h.p=c,d.append("<div class='mollify-iconview-header'></div>"),b.dom.template("mollify-tmpl-iconview",{viewId:h.viewId}).appendTo(h.$c.empty()),h.$l=a("#"+h.viewId),f&&h.$l.addClass(f)},this.content=function(c,d){h.items=c,h.data=d;var e=["jpg","png","gif","jpeg"];b.dom.template("mollify-tmpl-iconview-item",c,{showThumb:function(a){return g&&a.is_file?e.indexOf(a.extension)>=0:!1},thumbUrl:function(a){return b.service.url("filesystem/"+a.id+"/thumbnail/")},typeClass:function(a){var b=a.is_file?"item-file":"item-folder";return a.is_file&&a.extension?b+=" item-type-"+a.extension:a.is_file||a.id!=a.root_id||(b+=" item-root-folder"),b}}).appendTo(h.$l.empty());var f=h.$l.find(".mollify-iconview-item").hover(function(){a(this).addClass("hover")},function(){a(this).removeClass("hover")}).bind("contextmenu",function(b){b.preventDefault();var c=a(this);return h.p.onRightClick(c.tmplItem().data,"",c),!1}).single_double_click(function(b){var c=a(this),d=c.tmplItem().data,e=a(b.target);if(e.hasClass("mollify-iconview-item-sel-option"))return void h.p.onSelectUnselect(d);var f="";e.parent().hasClass("mollify-iconview-item-info")&&(f="info"),h.p.onClick(d,f,c)},function(){h.p.onDblClick(a(this).tmplItem().data)}).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none","-ms-user-select":"none"});b.ui.draganddrop&&(b.ui.draganddrop.enableDrag(f,{onDragStart:function(a){var b=a.tmplItem().data,c=h.p.getSelectedItems();return c?c.indexOf(b)<0&&c.push(b):c=b,{type:"filesystemitem",payload:c}}}),b.ui.draganddrop.enableDrop(h.$l.find(".mollify-iconview-item.item-folder"),{canDrop:function(a,b,c){if(!h.p.canDrop||!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.tmplItem().data;return h.p.canDrop(e,d)},dropType:function(a,b,c){if(!h.p.dropType||!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.tmplItem().data;return h.p.dropType(e,d)},onDrop:function(a,b,c){if(c&&"filesystemitem"==c.type){var d=c.payload,e=a.tmplItem().data;h.p.onDrop&&h.p.onDrop(e,d)}}})),h.p.onContentRendered(c,d)},this.getItemContextElement=function(a){return h.$l.find("#mollify-iconview-item-"+a.id)},this.getContainerElement=function(){return h.$l},this.removeHover=function(){h.$l.find(".mollify-iconview-item.hover").removeClass("hover")},this.setSelectMode=function(a){h.$l.find(".mollify-iconview-item.selected").removeClass("selected"),a?h.$l.addClass("select"):h.$l.removeClass("select")},this.setSelection=function(b){h.$l.find(".mollify-iconview-item.selected").removeClass("selected"),a.each(b,function(a,b){h.$l.find("#mollify-iconview-item-"+b.id).addClass("selected")})}},e=function(c,d,e,f,g){var h=this;h.minColWidth=25,h.$c=a("#"+c),h.$hc=d,h.listId="mollify-filelist-"+e,h.cols=[],h.sortCol=!1,h.sortOrderAsc=!0,h.colWidths={};for(var i in g){var j=f.columns[i];if(j){var k=a.extend({},j,g[i]);h.cols.push(k)}}this.init=function(c){h.p=c,b.dom.template("mollify-tmpl-filelist-header",{listId:h.listId}).appendTo(h.$hc.empty()),b.dom.template("mollify-tmpl-filelist",{listId:h.listId}).appendTo(h.$c.empty()),h.$l=a("#"+h.listId),h.$h=a("#"+h.listId+"-header-cols"),h.$i=a("#"+h.listId+"-items"),b.dom.template("mollify-tmpl-filelist-headercol",h.cols,{title:function(a){var c=a["title-key"];return c?b.ui.texts.get(c):""}}).appendTo(h.$h),h.$h.find(".mollify-filelist-col-header").each(function(b){var c=a(this),d=c.index();if(!(1>=d)){var e=h.cols[d-2],f=e["min-width"]||h.minColWidth;c.css("min-width",f),e.width&&c.css("width",e.width),c.find(".mollify-filelist-col-header-title").click(function(){h.onSortClick(e)}),b!=h.cols.length-1&&c.resizable({handles:"e",minWidth:f,start:function(){var a=h.$c.width()-h.cols.length*h.minColWidth;c.resizable("option","maxWidth",a)},stop:function(){var a=c.width();h.colWidths[e.id]=a,h.updateColWidth(e.id,a)}}),e["on-init"]&&e["on-init"](h)}}),h.items=[],h.data={},h.onSortClick(h.cols[0])},this.updateColWidths=function(){for(var a in h.colWidths)h.updateColWidth(a,h.colWidths[a])},this.updateColWidth=function(b,c){a(".mollify-filelist-col-"+b).width(c)},this.onSortClick=function(a){a.id!=h.sortCol.id?(h.sortCol=a,h.sortOrderAsc=!0):h.sortOrderAsc=!h.sortOrderAsc,h.refreshSortIndicator(),h.content(h.items,h.data)},this.sortItems=function(){var a=h.sortCol.sort;h.items.sort(function(b,c){return a(b,c,h.sortOrderAsc?1:-1,h.data)})},this.refreshSortIndicator=function(){h.$h.find(".mollify-filelist-col-header").removeClass("sort-asc").removeClass("sort-desc"),a("#mollify-filelist-col-header-"+h.sortCol.id).addClass("sort-"+(h.sortOrderAsc?"asc":"desc"))},this.getDataRequest=function(){for(var a={},b=0,c=h.cols.length;c>b;b++){var d=h.cols[b];d["request-id"]&&(a[d["request-id"]]={})}return a},this.content=function(c,d){h.items=c,h.data=d,h.sortItems(),b.dom.template("mollify-tmpl-filelist-item",c,{cols:h.cols,typeClass:function(a){var b=a.is_file?"item-file":"item-folder";return a.is_file&&a.extension?b+=" item-type-"+a.extension:a.is_file||a.id!=a.root_id||(b+=" item-root-folder"),b},col:function(a,b){return b.content(a,h.data)},itemColStyle:function(a,b){var c="min-width:"+(b["min-width"]||h.minColWidth)+"px";return b.width&&(c=c+";width:"+b.width+"px"),c}}).appendTo(h.$i.empty());for(var e=0,f=h.cols.length;f>e;e++){var g=h.cols[e];g["on-render"]&&g["on-render"](h)}var i=h.$i.find(".mollify-filelist-item");i.hover(function(){a(this).addClass("hover")},function(){a(this).removeClass("hover")}).bind("contextmenu",function(b){return b.preventDefault(),h.onItemClick(a(this),a(b.toElement||b.target),!1),!1}).single_double_click(function(b){return b.preventDefault(),b.stopPropagation(),h.onItemClick(a(this),a(b.toElement||b.target),!0),!1},function(){h.p.onDblClick(a(this).tmplItem().data)}),b.ui.draganddrop&&(b.ui.draganddrop.enableDrag(i,{onDragStart:function(a){var b=a.tmplItem().data,c=h.p.getSelectedItems();return c?c.indexOf(b)<0&&c.push(b):c=b,{type:"filesystemitem",payload:c}}}),b.ui.draganddrop.enableDrop(h.$i.find(".mollify-filelist-item.item-folder"),{canDrop:function(a,b,c){if(!h.p.canDrop||!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.tmplItem().data;return h.p.canDrop(e,d)},dropType:function(a,b,c){if(!h.p.dropType||!c||"filesystemitem"!=c.type)return!1;var d=c.payload,e=a.tmplItem().data;return h.p.dropType(e,d)},onDrop:function(a,b,c){if(c&&"filesystemitem"==c.type){var d=c.payload,e=a.tmplItem().data;h.p.onDrop&&h.p.onDrop(e,d)}}})),h.updateColWidths(),h.p.onContentRendered(c,d)},this.onItemClick=function(a,b,c){var d=a.find(".mollify-filelist-col").index(b.closest(".mollify-filelist-col"));if(!(0>d)){var e=a.tmplItem().data;if(0===d)return void h.p.onSelectUnselect(e);var f=1===d?"icon":h.cols[d-2].id;c?h.p.onClick(e,f,a):h.p.onRightClick(e,f,a)}},this.getItemContextElement=function(a){var b=h.$i.find("#mollify-filelist-item-"+a.id);return b.find(".mollify-filelist-col-name")||b},this.getItemForElement=function(a){return a.tmplItem().data},this.getContainerElement=function(){return h.$i},this.removeHover=function(){h.$i.find(".mollify-filelist-item.hover").removeClass("hover")},this.setSelectMode=function(a){h.$i.find(".mollify-filelist-item.selected").removeClass("selected"),a?(h.$l.addClass("select"),h.$h.addClass("select")):(h.$l.removeClass("select"),h.$h.removeClass("select"))},this.setSelection=function(b){h.$i.find(".mollify-filelist-item.selected").removeClass("selected"),a.each(b,function(a,b){h.$i.find("#mollify-filelist-item-"+b.id).addClass("selected")})}}}(window.jQuery,window.mollify),!function(a,b){"use strict";b.plugin={},b.plugin.Core=function(){return{id:"plugin-core",itemContextHandler:function(c){var d=c.id==c.root_id,e=!d&&b.filesystem.hasPermission(c,"filesystem_item_access","rw"),f=!d&&b.filesystem.hasPermission(c,"filesystem_item_access","rwd"),g=!d&&b.filesystem.hasPermission(c.parent_id,"filesystem_item_access","rw"),h=[];return c.is_file&&(h.push({"title-key":"actionDownloadItem",icon:"download",type:"primary",group:"download",callback:function(){b.ui.download(b.filesystem.getDownloadUrl(c))}}),h.push({title:"-"})),h.push({"title-key":"actionCopyItem",icon:"copy",callback:function(){return b.filesystem.copy(c)}}),g&&h.push({"title-key":"actionCopyItemHere",icon:"copy",callback:function(){return b.filesystem.copyHere(c)}}),e&&(h.push({"title-key":"actionMoveItem",icon:"mail-forward",callback:function(){return b.filesystem.move(c)}}),h.push({"title-key":"actionRenameItem",icon:"pencil",callback:function(){return b.filesystem.rename(c)}}),f&&h.push({"title-key":"actionDeleteItem",icon:"trash",callback:function(){var d=a.Deferred();return b.ui.dialogs.confirmation({title:b.ui.texts.get(c.is_file?"deleteFileConfirmationDialogTitle":"deleteFolderConfirmationDialogTitle"),message:b.ui.texts.get(c.is_file?"confirmFileDeleteMessage":"confirmFolderDeleteMessage",[c.name]),callback:function(){a.when(b.filesystem.del(c)).then(d.resolve,d.reject)}}),d.promise()}})),{actions:h}},itemCollectionHandler:function(c){var d=!1;a.each(c,function(a,b){var c=b.id==b.root_id;return c?(d=!0,!1):void 0});var e=[{"title-key":"actionCopyMultiple",icon:"copy",callback:function(){return b.filesystem.copy(c)}}];return d||(e.push({"title-key":"actionMoveMultiple",icon:"mail-forward",callback:function(){return b.filesystem.move(c)}}),e.push({"title-key":"actionDeleteMultiple",icon:"trash",callback:function(){return b.filesystem.del(c)}})),{actions:e}}}},b.plugin.ItemDetailsPlugin=function(a){var c=this;return c.formatters={},c.typeConfs=!1,this.initialize=function(){if(c.fileSizeFormatter=new b.ui.formatters.ByteSize(new b.ui.formatters.Number(2,!1,b.ui.texts.get("decimalSeparator"))),c.timestampFormatter=new b.ui.formatters.Timestamp(b.ui.texts.get("shortDateTimeFormat")),a){c.typeConfs={};for(var d in a)for(var e=d.split(","),f=a[d],g=0;g<e.length;g++){var h=e[g].trim();h.length>0&&(c.typeConfs[h]=f)}}},this.getApplicableSpec=function(a){var b=a.is_file&&a.extension?a.extension.toLowerCase().trim():"";return 0!==b.length&&c.typeConfs[b]||(b=a.is_file?"[file]":"[folder]",c.typeConfs[b])?c.typeConfs[b]:c.typeConfs["*"]},this.renderItemContextDetails=function(a,d,e,f){e.addClass("loading"),b.templates.load("itemdetails-content",b.helpers.noncachedUrl(b.plugins.url("ItemDetails","content.html"))).done(function(){e.removeClass("loading"),c.renderItemDetails(a,d,{element:e.empty(),data:f})})},this.renderItemDetails=function(a,d,e){for(var f=c.getApplicableSpec(d),g=c.getGroups(f,e.data),h=[],i=0,j=g.length;j>i;i++){var k=g[i];h.push({key:k,title:c.getGroupTitle(k),rows:c.getGroupRows(k,f,e.data)})}b.dom.template("itemdetails-template",{groups:h}).appendTo(e.element)},this.getGroups=function(a,b){var d=[];for(var e in a){var f=(a[e],b[e]);if(f){var g="file";("exif"==e||c.formatters[e])&&(g=e),d.indexOf(g)<0&&d.push(g)}}return d},this.getGroupTitle=function(a){if(c.formatters[a]){var d=c.formatters[a];if(d.groupTitle)return d.groupTitle;if(d["group-title-key"])return b.ui.texts.get(d["group-title-key"])}return"file"==a?b.ui.texts.get("fileItemDetailsGroupFile"):"exif"==a?b.ui.texts.get("fileItemDetailsGroupExif"):""},this.getGroupRows=function(a,b,d){if(c.formatters[a])return c.formatters[a].getGroupRows(b[a],d[a]);if("exif"==a)return c.getExifRows(b[a],d[a]);var e=[];for(var f in b)if("exif"!=f&&!c.formatters[f]){var g=(b[f],d[f]);g&&e.push({title:c.getFileRowTitle(f,b[f]),value:c.formatFileData(f,g)})}return e},this.getFileRowTitle=function(a,c){return c.title?c.title:c["title-key"]?b.ui.texts.get(c["title-key"]):"name"==a?b.ui.texts.get("fileItemContextDataName"):"size"==a?b.ui.texts.get("fileItemContextDataSize"):"path"==a?b.ui.texts.get("fileItemContextDataPath"):"extension"==a?b.ui.texts.get("fileItemContextDataExtension"):"last-modified"==a?b.ui.texts.get("fileItemContextDataLastModified"):"image-size"==a?b.ui.texts.get("fileItemContextDataImageSize"):a},this.formatFileData=function(a,d){if("size"==a)return c.fileSizeFormatter.format(d);if("last-modified"==a)return c.timestampFormatter.format(b.helpers.parseInternalTime(d));if("image-size"==a)return b.ui.texts.get("fileItemContextDataImageSizePixels",[d]);if(c.specs[a]){var e=c.specs[a];if(e.formatter)return e.formatter(d)}return d},this.getExifRows=function(a,b){var d=[];for(var e in b){var f="",g=!0,h=0;for(var i in b[e]){var j=c.formatExifValue(e,i,b[e][i]);j&&(f+='<tr id="exif-row-'+e+"-"+i+'" class="'+(g?"exif-row-section-first":"exif-row")+'"><td class="exif-key">'+i+'</td><td class="exif-value">'+j+"</td></tr>",g=!1,h++)}h>0&&d.push({title:e,value:'<table class="exif-section-'+e+'">'+f+"</table>"})}return d},this.formatExifValue=function(a,b,c){return"FILE"==a&&"SectionsFound"==b?!1:c},{id:"plugin-itemdetails",initialize:c.initialize,itemContextRequestData:function(a){if(!c.typeConfs)return!1;var b=c.getApplicableSpec(a);if(!b)return!1;var d=[];for(var e in b)d.push(e);return d},itemContextHandler:function(a,b,d){if(!d||!c.typeConfs)return!1;var e=c.getApplicableSpec(a);return e?{details:{"title-key":"pluginItemDetailsContextTitle","on-render":function(b,e){c.renderItemContextDetails(b,a,e,d)}}}:!1}}},b.plugin.ItemCollectionPlugin=function(){var c=this;
return this.initialize=function(){},this.onStore=function(d){var e=a.Deferred();return b.ui.dialogs.input({title:b.ui.texts.get("pluginItemCollectionStoreDialogTitle"),message:b.ui.texts.get("pluginItemCollectionStoreDialogMessage"),defaultValue:"",yesTitle:b.ui.texts.get("pluginItemCollectionStoreDialogAction"),noTitle:b.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(a){return!!a&&a.length>0},onInput:function(b){a.when(c._onStore(d,b)).then(e.resolve,e.reject)}}}),e.promise()},this._onStore=function(a,d){return b.service.post("itemcollections",{items:a,name:d}).done(function(a){c._updateNavBar(a)})},this.onAddItems=function(a,c){return b.service.post("itemcollections/"+a.id,{items:window.isArray(c)?c:[c]})},this._removeCollectionItem=function(a,c){return b.service.del("itemcollections/"+a.id+"/items",{items:window.isArray(c)?c:[c]})},this._showCollection=function(a){c._fileView.changeToFolder("ic/"+a.id)},this.editCollection=function(a,d){b.service.get("itemcollections/"+a.id).done(function(e){b.ui.dialogs.tableView({title:b.ui.texts.get("pluginItemCollectionsEditDialogTitle",a.name),buttons:[{id:"close",title:b.ui.texts.get("dialogClose")},{id:"remove",title:b.ui.texts.get("pluginItemCollectionsEditDialogRemove"),type:"secondary",cls:"btn-danger secondary"}],onButton:function(b,e){e.close(),"remove"==b.id&&c.removeCollection(a),d("remove"==b.id)},table:{key:"item_id",columns:[{id:"icon",title:"",renderer:function(a,b,c){c.html(a.is_file?'<i class="icon-file"></i>':'<i class="icon-folder-close-alt"></i>')}},{id:"name",title:b.ui.texts.get("fileListColumnTitleName")},{id:"remove",title:"",type:"action",content:'<i class="icon-trash"></i>'}]},onTableRowAction:function(b,d,e,f){"remove"==e&&c._removeCollectionItem(a,f).done(function(){d.remove(f)})},onRender:function(a,b,c){c.set(e.items),b.removeClass("loading")}})})},this._updateNavBar=function(b){c._list=b;var d=[],e={};a.each(b,function(a,b){e[b.id]=b,d.push({title:b.name,obj:b,callback:function(){c._showCollection(b)}})}),c._collectionsNav.update(d);var f=c._fileView.getCurrentFolder();"ic"==f.type&&c._collectionsNav.setActive(e[f.id])},this.removeCollection=function(a){return b.service.del("itemcollections/"+a.id).done(c._updateNavBar)},this._onShareNavItem=function(a){b.plugins.exists("plugin-share")&&b.plugins.get("plugin-share").openShares({id:"ic_"+a.id,name:a.name,shareTitle:b.ui.texts.get("pluginItemCollectionShareTitle")})},this._getItemActions=function(a){var d=[{"title-key":"pluginItemCollectionsNavEdit",callback:function(){c.editCollection(a,function(b){var d=c._fileView.getCurrentFolder();"ic"==d.type&&d.id==a.id&&(b?c._fileView.openInitialFolder():c._fileView.refresh())})}},{"title-key":"pluginItemCollectionsNavRemove",callback:function(){c._fileView.openInitialFolder(),c.removeCollection(a)}}];return b.plugins.exists("plugin-share")&&d.push({"title-key":"pluginItemCollectionsNavShare",callback:function(){c._onShareNavItem(a)}}),d},this._onFileViewInit=function(d){c._fileView=d,c._fileView.addCustomFolderType("ic",{onSelectFolder:function(d){var e=a.Deferred();return b.service.post("itemcollections/"+d+"/data",{rq_data:c._fileView.getDataRequest()}).done(function(a){c._collectionsNav.setActive(a.ic);var b={type:"ic",id:a.ic.id,name:a.ic.name},d={items:a.ic.items,ic:a.ic,data:a.data};e.resolve(b,d)}),e.promise()},onFolderDeselect:function(){c._collectionsNav.setActive(!1)},onRenderFolderView:function(d,e,f){b.dom.template("mollify-tmpl-fileview-header-custom",{folder:d}).appendTo(f);var g={title:function(){return this.data.title?this.data.title:b.ui.texts.get(this.data["title-key"])}},h=a("#mollify-fileview-folder-actions"),i=b.dom.template("mollify-tmpl-fileview-foldertools-action",{icon:"icon-cog",dropdown:!0},g).appendTo(h);b.ui.controls.dropdown({element:i,items:c._getItemActions(e.ic),hideDelay:0,style:"submenu"}),c._fileView.addCommonFileviewActions(h)}})},this._onFileViewActivate=function(a,d){c._collectionsNav=d.addNavBar({title:b.ui.texts.get("pluginItemCollectionsNavTitle"),classes:"ic-navbar-item",items:[],dropdown:{items:c._getItemActions},onRender:b.ui.draganddrop?function(a,d,e){b.ui.draganddrop.enableDrop(d,{canDrop:function(a,b,c){return c&&"filesystemitem"==c.type?!0:!1},dropType:function(a,b,c){return c&&"filesystemitem"==c.type?"copy":!1},onDrop:function(a,b,d){if(d&&"filesystemitem"==d.type){var f=d.payload,g=e(a);c.onAddItems(g,f)}}})}:!1}),b.service.get("itemcollections").done(c._updateNavBar)},{id:"plugin-itemcollection",initialize:c.initialize,itemCollectionHandler:function(a){return{actions:[{"title-key":"pluginItemCollectionStore",callback:function(){return c.onStore(a)}}]}},fileViewHandler:{onInit:c._onFileViewInit,onActivate:c._onFileViewActivate}}},b.plugin.ArchiverPlugin=function(){var c=this;return this.initialize=function(){},this.onCompress=function(d,e){if(d){var f="",g=!1,h=b.helpers.arrayize(d);1==h.length&&(g=d[0]);var i=a.Deferred(),j=function(d){g&&(f=g.name+".zip"),b.ui.dialogs.input({title:b.ui.texts.get("pluginArchiverCompressDialogTitle"),message:b.ui.texts.get("pluginArchiverCompressDialogMessage"),defaultValue:f,yesTitle:b.ui.texts.get("pluginArchiverCompressDialogAction"),noTitle:b.ui.texts.get("dialogCancel"),handler:{isAcceptable:function(a){return!!a&&a.length>0&&(!g||a!=g.name)},onInput:function(b){a.when(c._onCompress(h,d,b)).then(i.resolve,i.reject)}}})};return e?j(e):b.ui.dialogs.folderSelector({title:b.ui.texts.get("pluginArchiverCompressDialogTitle"),message:b.ui.texts.get("pluginArchiverCompressSelectFolderDialogMessage"),actionTitle:b.ui.texts.get("ok"),handler:{onSelect:function(a){j(a)},canSelect:function(){return!0}}}),i.promise()}},this.onDownloadCompressed=function(a){return b.service.post("archiver/download",{items:a}).done(function(a){b.ui.download(b.service.url("archiver/download/"+a.id,!0))})},this._onCompress=function(a,c,d){return b.service.post("archiver/compress",{items:a,folder:c,name:d}).done(function(){b.events.dispatch("archiver/compress",{items:a,folder:c,name:d}),b.events.dispatch("filesystem/update",{folder:c})})},this._onExtract=function(a,c){return b.service.post("archiver/extract",{item:a,folder:c}).done(function(){b.events.dispatch("archiver/extract",{item:a,folder:c}),b.events.dispatch("filesystem/update",{folder:c})})},this._isArchive=function(a){if(!a.is_file)return!1;var b=a.extension.toLowerCase();return"zip"==b},{id:"plugin-archiver",initialize:c.initialize,getDownloadCompressedUrl:function(a){var c=!1;return window.isArray(a)?1==a.length&&(c=a[0]):c=a,c?b.service.url("archiver/download?item="+c.id,!0):!1},itemContextHandler:function(a,d){var e=a.id==a.root_id,f=(!e&&b.filesystem.hasPermission(a,"filesystem_item_access","rw"),!e&&b.filesystem.hasPermission(a.parent_id,"filesystem_item_access","rw")),g=!e&&d.folder&&d.folder_writable;if(f&&c._isArchive(a))return{actions:[{"title-key":"pluginArchiverExtract",callback:function(){return c._onExtract(a)}}]};var h=[{"title-key":"pluginArchiverDownloadCompressed",icon:"archive",type:"primary",group:"download",callback:function(){c.onDownloadCompressed([a])}}];return d.folder&&g&&h.push({"title-key":"pluginArchiverCompress",icon:"archive",callback:function(){return c.onCompress(a,d.folder)}}),{actions:h}},itemCollectionHandler:function(a){return{actions:[{"title-key":"pluginArchiverCompress",icon:"archive",callback:function(){return c.onCompress(a)}},{"title-key":"pluginArchiverDownloadCompressed",icon:"archive",type:"primary",group:"download",callback:function(){return c.onDownloadCompressed(a)}}]}}}},b.plugin.FileViewerEditorPlugin=function(){var c=this;return this.initialize=function(){},this.onEdit=function(c,d){b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:b.ui.texts.get("fileViewerEditorViewEditDialogTitle"),content:'<div class="fileviewereditor-editor-content"></div>',buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,b){return"no"==a.id?void b.close():void document.getElementById("editor-frame").contentWindow.onEditorSave(function(){b.close()},function(){return b.close(),!0})},"on-show":function(b,c){var e=c.find(".fileviewereditor-editor-content"),f=a('<iframe id="editor-frame" width="100%" height:"100%" style="width:100%;height:100%;border: none;overflow: none;" />').attr("src",d.embedded);e.removeClass("loading").append(f),b.center()}})},this.onView=function(d,e,f){var g={},h=[{embedded:f.view.embedded,full:f.view.full,edit:!!f.edit,item:d}],i=h[0],j=!1;i.init=!0;var k,l,m,n,o=!1,p=!1,q=function(){m=a(window).width()-100,n=a(window).height()-100,l.css({"max-width":m+"px","max-height":n+"px"}),p&&p.css({"max-width":m+"px","max-height":n+"px"}),k.lightbox("center")};a(window).resize(q);var r=function(b){var c=b.item.id;o=b,g[c]||a.ajax({type:"GET",url:b.embedded}).done(function(b){g[c]=!0,p=a("#mollify-fileviewereditor-viewer-item-"+c);var d=p.find(".mollify-fileviewereditor-viewer-item-content");if(d.removeClass("loading").html(b.result.html),b.result.size){var e=b.result.size.split(";");a("#"+b.result.resized_element_id).css({width:e[0]+"px",height:e[1]+"px"})}var f=d.find("img:first");f.length>0?f.one("load",function(){var a=f.width();!b.result.size&&a>0&&f.css({width:a+"px",height:f.height()+"px"}),q()}):q(),j||(k.lightbox("show"),j=!0)})},s=b.dom.template("mollify-tmpl-fileviewereditor-popup",{items:h},{content:function(a){return a.content}}).appendTo(a("body")),t=function(){s.remove()};k=s.lightbox({backdrop:!0,resizeToFit:!1,show:!1,onHide:t}),b.ui.process(k,["localize"]),k.find("button.close").click(function(){k.lightbox("hide")}),l=k.find(".carousel-inner");var u=s.find(".carousel").carousel({interval:!1}).on("slid",function(){var a=s.find(".mollify-fileviewereditor-viewer-item.active");r(a.tmplItem().data)});u.find(".carousel-control").click(function(){u.carousel(a(this).hasClass("left")?"prev":"next")});var v=u.find(".mollify-fileviewereditor-viewer-tools");v.find(".mollify-fileviewereditor-viewer-item-viewinnewwindow").click(function(){k.lightbox("hide"),b.ui.window.open(o.full)}),v.find(".mollify-fileviewereditor-viewer-item-edit").click(function(){k.lightbox("hide"),c.onEdit(d,f.edit)}),r(i)},{id:"plugin-fileviewereditor",initialize:c.initialize,itemContextHandler:function(b,d,e){if(!e)return!1;var f=!!e.preview,g=!!e.view,h=!!e.edit,i={details:!1,actions:[]};return f&&(i.details={"title-key":"pluginFileViewerEditorPreview","on-render":function(b,c){c.empty().addClass("loading"),a.ajax({type:"GET",url:e.preview}).done(function(a){c.removeClass("loading").html(a.result.html)})}}),g&&i.actions.push({id:"pluginFileViewerEditorView","title-key":"pluginFileViewerEditorView",type:"primary",callback:function(){c.onView(b,[],e)}}),h&&i.actions.push({id:"pluginFileViewerEditorView","title-key":"pluginFileViewerEditorEdit",type:"primary",callback:function(){c.onEdit(b,e.edit)}}),i}}},b.plugin.CommentPlugin=function(){var c=this;return this.initialize=function(){c._timestampFormatter=new b.ui.formatters.Timestamp(b.ui.texts.get("shortDateTimeFormat")),b.dom.importCss(b.plugins.url("Comment","style.css"))},this.getListCellContent=function(a,b){if(!a.id||0===a.id.length||!b||!b["plugin-comment-count"])return"";var c=b["plugin-comment-count"];return c[a.id]?"<div id='item-comment-count-"+a.id+"' class='filelist-item-comment-count'>"+c[a.id]+"</div>":"<div id='item-comment-count-"+a.id+"' class='filelist-item-comment-count-none'></div>"},this.renderItemContextDetails=function(a,d,e,f,g){f.addClass("loading"),b.templates.load("comments-content",b.helpers.noncachedUrl(b.plugins.url("Comment","content.html"))).done(function(){f.removeClass("loading"),0===g.count?c.renderItemContextComments(a,d,e,[],{element:f.empty(),contentTemplate:"comments-template"}):c.loadComments(d,!1,function(b,d){c.renderItemContextComments(a,b,e,d,{element:f.empty(),contentTemplate:"comments-template"})})})},this.renderItemContextComments=function(a,d,e,f,g){var h=b.session.user.admin||b.filesystem.hasPermission(d,"comment_item"),i=b.dom.template(g.contentTemplate,{item:d,canAdd:h}).appendTo(g.element);h&&i.find(".comments-dialog-add").click(function(){var b=i.find(".comments-dialog-add-text").val();b&&0!==b.length&&c.onAddComment(d,b,a.close)}),c.updateComments(i.find(".comments-list"),d,f)},this.showCommentsBubble=function(a,d,e){var f=b.ui.controls.dynamicBubble({element:d,title:a.name,container:e.container});b.templates.load("comments-content",b.helpers.noncachedUrl(b.plugins.url("Comment","content.html"))).done(function(){c.loadComments(a,!0,function(a,d,e){var g=b.session.user.admin||"1"==e,h=b.dom.template("comments-template",{item:a,canAdd:g});f.content(h),g&&h.find(".comments-dialog-add").click(function(){var b=h.find(".comments-dialog-add-text").val();b&&0!==b.length&&c.onAddComment(a,b,f.close)}),c.updateComments(h.find(".comments-list"),a,d)})})},this.loadComments=function(a,d,e){b.service.get("comment/"+a.id+(d?"?p=1":"")).done(function(b){e(a,c.processComments(d?b.comments:b),d?b.permission:void 0)})},this.processComments=function(a){for(var d=b.session.user_id,e=0,f=a.length;f>e;e++)a[e].time=c._timestampFormatter.format(b.helpers.parseInternalTime(a[e].time)),a[e].comment=a[e].comment.replace(new RegExp("\n","g"),"<br/>"),a[e].remove=b.session.user.admin||d==a[e].user_id;return a},this.onAddComment=function(a,d,e){b.service.post("comment/"+a.id,{comment:d}).done(function(b){c.updateCommentCount(a,b.count),e&&e()})},this.onRemoveComment=function(a,d,e){b.service.del("comment/"+d.id+"/"+e).done(function(b){c.updateCommentCount(d,b.length),c.updateComments(a,d,c.processComments(b))})},this.updateCommentCount=function(a,b){var c=document.getElementById("item-comment-count-"+a.id);c&&(1>b?(c.innerHTML="",c.setAttribute("class","filelist-item-comment-count-none")):(c.innerHTML=b,c.setAttribute("class","filelist-item-comment-count")))},this.updateComments=function(d,e,f){return d.removeClass("loading"),0===f.length?void d.html("<span class='message'>"+b.ui.texts.get("commentsDialogNoComments")+"</span>"):(b.dom.template("comment-template",f).appendTo(d.empty()),d.find(".comment-content").hover(function(){a(this).addClass("hover")},function(){a(this).removeClass("hover")}),void d.find(".comment-remove-action").click(function(b){b.preventDefault();var f=a(this).tmplItem().data;c.onRemoveComment(d,e,f.id)}))},{id:"plugin-comment",initialize:c.initialize,fileViewHandler:{filelistColumns:function(){return[{id:"comment-count","request-id":"plugin-comment-count","title-key":"",width:50,content:c.getListCellContent,request:function(){return{}},"on-click":function(b,d,e){c.showCommentsBubble(b,a("#item-comment-count-"+b.id),e)}}]}},itemContextHandler:function(a,b,d){return{details:{"title-key":"pluginCommentContextTitle","on-render":function(b,e,f){c.renderItemContextDetails(b,a,f,e,d)}}}}}},b.plugin.PermissionsPlugin=function(){var c=this;return this._permissionTypes=!1,this.initialize=function(){b.events.addEventHandler(function(){!c._permissionTypes&&b.session.user&&(c._permissionTypes=b.session.data.permission_types)},"session/start"),c._pathFormatter=new b.ui.formatters.FilesystemItemPath},this._formatPermissionName=function(a){var d=b.ui.texts.get("permission_"+a.name);return null==a.subject&&c._permissionTypes.filesystem[a.name]?b.ui.texts.get("permission_default",d):d},this._formatPermissionValue=function(a,d){var e=c._getPermissionValues(a);return b.ui.texts.get(e?"permission_"+a+"_value_"+d:"permission_value_"+d)},this._getPermissionValues=function(a){return c._permissionTypes.values[a]},this.editItemPermissions=function(d){var e={"new":[],modified:[],removed:[]},f=[],g=!1;b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:b.ui.texts.get("pluginPermissionsEditDialogTitle",d.name),content:b.dom.template("mollify-tmpl-permission-editor",{item:d}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,c){return"no"==a.id?void c.close():void((0!==e["new"].length||0!==e.modified.length||0!==e.removed.length)&&b.service.put("permissions/list",e).done(c.close).fail(c.close))},"on-show":function(h,i){g=i.find("#mollify-pluginpermissions-editor-content");var j=g.find(".mollify-pluginpermissions-editor-subcontent").hide(),k=!1,l=0,m=!1;h.center(),b.service.get("configuration/users?g=1").done(function(g){var i=c.processUserData(g),n=c._permissionTypes.keys.filesystem,o="filesystem_item_access",p=function(){var a=e["new"].length>0||e.modified.length>0||e.removed.length>0?"<i class='icon-exclamation-sign '/>&nbsp;"+b.ui.texts.get("pluginPermissionsEditDialogUnsaved"):!1;h.setInfo(a)},q=function(a){return a.user_id+":"+a.subject+":"+a.name},r={addNew:function(a){a.isnew&&(e["new"].push(a),p())},remove:function(a){a.isnew?e["new"].remove(e["new"].indexOf(a)):e.removed.push(a),p()},update:function(a,b){if(!a.isnew){var c=q(a);f[c]||(f[c]=a.value),e.removed.remove(a);var d=e.modified.indexOf(a);f[c]==b?d>=0&&e.modified.remove(d):0>d&&e.modified.push(a)}a.value=b,p()},getNew:function(b){return a.grep(e["new"],function(a){return a.name==b})},findRemoved:function(a,b,c){for(var d=0,f=e.removed.length;f>d;d++){var g=e.removed[d];if(g.user_id==a&&g.subject==b&&g.name==c)return g}return!1}},s=function(b){var c={};a.each(b,function(a,b){c[q(b)]=b});for(var d=0,f=e.removed.length;f>d;d++){var g=e.removed[d],h=q(g);h in c&&b.remove(b.indexOf(c[h]))}for(var i=0,j=e.modified.length;j>i;i++){var k=e.modified[i],l=q(k);l in c&&(c[l].value=k.value)}},t=function(b,c,e){var f=[];a.each(b,function(a,b){return 0!==b.user_id&&b.user_id!=c.id&&c.group_ids.indexOf(b.user_id)<0?!1:void f.push(b)}),a.each(f,function(a,c){b.remove(c)});var g=[];a.each(r.getNew(e),function(a,b){b.subject==d.id&&(0===b.user_id||b.user_id==c.id||c.group_ids.indexOf(b.user_id)>=0)&&f.push(b)}),g=f.concat(b);var h=function(a){var b=0;return a.subject==d.id?b=20:null!=a.subject&&""!==a.subject&&(b=10),a.user_id==c.id?b+=2:c.group_ids.indexOf(a.user_id)>=0&&(b+=1),b};return g=g.sort(function(a,b){return h(b)-h(a)})},u=function(b){a("#mollify-pluginpermissions-editor-tab > li").removeClass("active").eq(b).addClass("active"),k=j.hide().eq(b).show(),l=b,0===b?w(k):x(k)},v=function(a){m=a,u(l)};b.ui.controls.select("mollify-pluginpermissions-editor-permission-name",{onChange:v,formatter:function(a){return b.ui.texts.get("permission_"+a)},values:n,value:o}),a("#mollify-pluginpermissions-editor-tab > li").click(function(){var b=a(this).addClass("active").index();u(b)});var w=function(a){a.addClass("loading"),c.loadPermissions(d,m).done(function(b){a.removeClass("loading");var e=b.permissions.slice(0);s(e),e=e.concat(r.getNew(m)),c.initItemPermissionEditor(r,d,m,e,i)}).fail(h.close)},x=function(e){var f=function(){a("#mollify-pluginpermissions-editor-user-related-permissions").hide(),a("#mollify-pluginpermissions-editor-user-permissions-description").html("")};f();var g=function(g){if(f(),g){if("a"==g.user_type)return void a("#mollify-pluginpermissions-editor-user-permissions-description").html(b.ui.texts.get("pluginPermissionsUserPermissionsAdmin"));e.addClass("loading"),b.service.get("permissions/user/"+g.id+"?e=1&subject="+d.id+"&name="+m).done(function(a){e.removeClass("loading");var b=a.permissions.slice(0);s(b),b=t(b,g,m),c.initUserPermissionInspector(r,g,d,m,b,a.items,i)}).fail(h.close)}};b.ui.controls.select("mollify-pluginpermissions-editor-permission-user",{onChange:g,none:b.ui.texts.get("pluginPermissionsEditNoUser"),values:i.users,title:"name"})};v(o)}).fail(h.close)}})},this.processUserData=function(a){for(var b={users:[],groups:[],all:[],usersById:{}},c=0,d=a.length;d>c;c++){var e=a[c];"0"==e.is_group?(b.users.push(e),b.all.push(e),b.usersById[e.id]=e):(b.groups.push(e),b.all.push(e),b.usersById[e.id]=e)}return b},this.loadPermissions=function(a,c,d){return b.service.get("permissions/list?subject="+a.id+(c?"&name="+c:"")+(d?"&u=1":""))},this.initUserPermissionInspector=function(d,e,f,g,h,i,j){var k=function(){var d=!1;if(h.length>0&&(d=h[0].value),d)a("#mollify-pluginpermissions-editor-user-permissions-description").html(b.ui.texts.get("pluginPermissionsEffectiveUserPermission",c._formatPermissionValue(g,d))),a("#mollify-pluginpermissions-editor-user-related-permissions").show();else{var e=c._getPermissionValues(g);a("#mollify-pluginpermissions-editor-user-permissions-description").html(b.ui.texts.get("pluginPermissionsNoEffectiveUserPermission",c._formatPermissionValue(g,e?e[0]:"0")))}};if(k(),0!==h.length){var l=function(a){return"0"!=a&&"0"!=j.usersById[a].is_group},m=b.ui.controls.table("mollify-pluginpermissions-editor-user-permission-list",{key:"user_id",onRow:function(a,b){l(b.user_id)&&a.addClass("group")},columns:[{id:"user_id",title:b.ui.texts.get("pluginPermissionsEditColUser"),renderer:function(a,c,d){return"0"!=c||""!==a.subject?"0"==c?void d.html("<em>"+b.ui.texts.get("pluginPermissionsEditDefaultPermission")+"</em>"):void d.html(j.usersById[c].name).addClass("user"):void 0}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),formatter:function(a,b){return c._formatPermissionValue(g,b)}},{id:"subject",title:b.ui.texts.get("pluginPermissionsEditColSource"),renderer:function(a,d,e){var g=i[d];if(g){if(g.id==f.id)e.html('<i class="icon-file-alt"/>&nbsp;'+b.ui.texts.get("pluginPermissionsEditColItemCurrent"));else{var h=Math.max(f.path.count("/"),f.path.count("\\"))-Math.max(g.path.count("/"),g.path.count("\\"))+1;e.html('<i class="icon-file-alt"/>&nbsp;'+b.ui.texts.get("pluginPermissionsEditColItemParent",h))}e.tooltip({placement:"bottom",html:!0,title:c._pathFormatter.format(g),trigger:"hover",container:"#mollify-pluginpermissions-editor-user-related-permissions"})}else{var k=b.ui.texts.get("permission_system_default");if("0"!=a.user_id){var l=j.usersById[a.user_id];k=b.ui.texts.get("1"==l.is_group?"permission_group_default":"permission_user_default")}e.html("<em>"+k+"</em>")}}},{id:"remove",title:"",type:"action",content:b.dom.template("mollify-tmpl-permission-editor-listremove").html()}],onRowAction:function(a,b){d.remove(b),h.remove(b),m.remove(b),k()}});m.add(h)}},this.initItemPermissionEditor=function(d,e,f,g,h){var i,j=c._getPermissionValues(f),k=function(a){return"0"!=a&&"0"!=h.usersById[a].is_group},l=function(a,b){var c=i.findByKey(a.id);if(c)d.update(c,b),i.update(c);else{var g=d.findRemoved(a.id,e.id,f);if(g)g.permission=b,d.update(g),i.add(g);else{var h={user_id:a.id,subject:e.id,name:f,value:b,isnew:!0};d.addNew(h),i.add(h)}}};i=b.ui.controls.table("mollify-pluginpermissions-editor-permission-list",{key:"user_id",onRow:function(a,b){k(b.user_id)&&a.addClass("group")},columns:[{id:"user_id",title:b.ui.texts.get("pluginPermissionsEditColUser"),renderer:function(a,c,d){var e="0"!=c?h.usersById[c].name:b.ui.texts.get("pluginPermissionsEditDefaultPermission");d.html(e).addClass("user")}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),type:"select",options:j||["0","1"],formatter:function(a,b){return c._formatPermissionValue(a.name,b)},onChange:function(a,b){d.update(a,b)},cellClass:"permission"},{id:"remove",title:"",type:"action",content:b.dom.template("mollify-tmpl-permission-editor-listremove").html()}],onRowAction:function(a,b){d.remove(b),i.remove(b)}}),i.add(g);var m=b.ui.controls.select("mollify-pluginpermissions-editor-new-user",{none:b.ui.texts.get("pluginPermissionsEditNoUser"),title:"name",onCreate:function(a,b){k(b.id)&&a.addClass("group")}});m.add({name:b.ui.texts.get("pluginPermissionsEditDefaultPermission"),id:0,is_group:0}),m.add(h.users),m.add(h.groups);var n=b.ui.controls.select("mollify-pluginpermissions-editor-new-permission",{values:j||["0","1"],none:b.ui.texts.get("pluginPermissionsEditNoPermission"),formatter:function(a){return c._formatPermissionValue(f,a)}}),o=function(){m.select(!1),n.select(!1)};o(),a("#mollify-pluginpermissions-editor-new-add").unbind("click").click(function(){var a=m.selected();if(a){var b=n.selected();b&&(l(a,b),o())}})},this.renderItemContextDetails=function(d,e,f){b.dom.template("mollify-tmpl-permission-context").appendTo(f),b.ui.process(f,["localize"]),c.loadPermissions(e,"filesystem_item_access",!0).done(function(f){var g=c.processUserData(f.users);a("#mollify-pluginpermissions-context-content").removeClass("loading");var h=b.ui.controls.table("mollify-pluginpermissions-context-permission-list",{key:"user_id",columns:[{id:"user_id",title:b.ui.texts.get("pluginPermissionsEditColUser"),formatter:function(a,c){return"0"!=c?g.usersById[c].name:b.ui.texts.get("pluginPermissionsEditDefaultPermission")}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),formatter:function(a,b){return c._formatPermissionValue(a.name,b)}}]});h.add(f.permissions),a("#mollify-pluginpermissions-context-edit").click(function(){d.close(),c.editItemPermissions(e)})}).fail(function(){d.close()})},this.onActivateConfigView=function(d,e){b.service.get("configuration/users?g=1").done(function(f){var g,h,i,j=c.processUserData(f),k=c._permissionTypes.keys.all,l=[],m=function(){var a=g.get(),b=h.get(),c=i.get(),d={};return a&&(d.name=a),b&&(d.user_id=b.id),c&&(d.subject_type=c,("filesystem_item"==c||"filesystem_child"==c)&&(t?d.subject_value=t.id:d.subject_type=null)),d},n=function(){e.showLoading(!0),p.table.refresh().done(function(){e.showLoading(!1)})},o=function(a){return b.service.del("permissions/list/",{list:a})},p=new b.view.ConfigListView(d,{actions:[{id:"action-remove",content:'<i class="icon-trash"></i>',cls:"btn-danger",depends:"table-selection",callback:function(a){b.ui.dialogs.confirmation({title:b.ui.texts.get("configAdminPermissionsRemoveConfirmationTitle"),message:b.ui.texts.get("configAdminPermissionsRemoveConfirmationMessage",[a.length]),callback:function(){o(a).done(n)}})}},{id:"action-edit-generic",content:'<i class="icon-globe"></i>',tooltip:b.ui.texts.get("pluginPermissionsEditDefaultPermissionsAction"),callback:function(){c.editGenericPermissions()}},{id:"action-refresh",content:'<i class="icon-refresh"></i>',callback:n}],table:{id:"config-permissions-list",key:"id",narrow:!0,hilight:!0,remote:{path:"permissions/query",paging:{max:50},queryParams:m,onData:function(a){l=a.items},onLoad:function(a){d.addClass("loading"),a.done(function(){d.removeClass("loading")})}},defaultSort:{id:"time",asc:!1},columns:[{type:"selectrow"},{id:"name",title:b.ui.texts.get("pluginPermissionsPermissionName"),sortable:!0,formatter:function(a){return c._formatPermissionName(a)}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),sortable:!0,formatter:function(a,b){return c._formatPermissionValue(a.name,b)}},{id:"user_id",title:b.ui.texts.get("pluginPermissionsPermissionUser"),sortable:!0,formatter:function(a,b){return b&&"0"!=b?j.usersById[b].name:""}},{id:"subject",title:b.ui.texts.get("pluginPermissionsPermissionSubject"),formatter:function(a,b){if(!b)return"";if(c._permissionTypes.keys.filesystem.indexOf(a.name)>=0&&l[b]){var d=l[b];if(d)return c._pathFormatter.format(d)}return b}},{id:"remove",title:"",type:"action",content:b.dom.template("mollify-tmpl-permission-editor-listremove").html()}],onRowAction:function(a,b){o([b]).done(n)}}}),q=d.find(".mollify-configlistview-options");b.dom.template("mollify-tmpl-permission-admin-options").appendTo(q),b.ui.process(q,["localize"]),a("#permissions-subject-any").attr("checked",!0),g=b.ui.controls.select("permissions-name",{values:k,formatter:function(a){return b.ui.texts.get("permission_"+a)},none:b.ui.texts.get("pluginPermissionsAdminAny")}),h=b.ui.controls.select("permissions-user",{values:j.all,title:"name",none:b.ui.texts.get("pluginPermissionsAdminAny")});var r=a("#permissions-subject-filesystem-item-selector"),s=a("#permissions-subject-filesystem-item-value"),t=!1,u=function(a){t=a,s.val(c._pathFormatter.format(a))};a("#permissions-subject-filesystem-item-select").click(function(){return"filesystem_item"==i.get()?b.ui.dialogs.itemSelector({title:b.ui.texts.get("pluginPermissionsSelectItemTitle"),message:b.ui.texts.get("pluginPermissionsSelectItemMsg"),actionTitle:b.ui.texts.get("ok"),handler:{onSelect:u,canSelect:function(){return!0}}}):b.ui.dialogs.folderSelector({title:b.ui.texts.get("pluginPermissionsSelectFolderTitle"),message:b.ui.texts.get("pluginPermissionsSelectFolderMsg"),actionTitle:b.ui.texts.get("ok"),handler:{onSelect:u,canSelect:function(){return!0}}}),!1}),i=b.ui.controls.select("permissions-subject",{values:["none","filesystem_item","filesystem_child"],formatter:function(a){return b.ui.texts.get("pluginPermissionsAdminOptionSubject_"+a)},none:b.ui.texts.get("pluginPermissionsAdminAny"),onChange:function(a){"filesystem_item"==a||"filesystem_child"==a?(t=!1,s.val(""),r.show()):r.hide()}})})},this.editGenericPermissions=function(d,e){var f={"new":[],modified:[],removed:[]},g=!1;b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:d?b.ui.texts.get("pluginPermissionsEditDialogTitle",d.name):b.ui.texts.get("pluginPermissionsEditDefaultDialogTitle"),content:b.dom.template("mollify-tmpl-permission-generic-editor",{user:d}),buttons:[{id:"yes",title:b.ui.texts.get("dialogSave")},{id:"no",title:b.ui.texts.get("dialogCancel")}],"on-button":function(a,c){return"no"==a.id?void c.close():void((0!==f["new"].length||0!==f.modified.length||0!==f.removed.length)&&(g.addClass("loading"),b.service.put("permissions/list",f).done(function(){c.close(),e&&e()}).fail(c.close)))},"on-show":function(e,h){g=h.find("#mollify-pluginpermissions-editor-generic-content"),e.center();var i=!1;b.service.get("permissions/user/"+(d?d.id:"0")+"/generic/").done(function(e){var h=function(h){g.removeClass("loading");var j=c._permissionTypes.keys.all,k=b.helpers.mapByKey(e.permissions,"name","value"),l=h?b.helpers.mapByKey(h.permissions,"name","value"):{},m=[];a.each(j,function(a,b){var c={name:b,value:k[b],subject:"",user_id:d?d.id:"0"};k[b]||(c.isnew=!0),m.push(c)});var n=[{id:"name",title:b.ui.texts.get("pluginPermissionsPermissionName"),formatter:function(a,e){return c._permissionTypes.keys.filesystem.indexOf(e)>=0?d?c._formatPermissionName(a)+" ("+b.ui.texts.get("1"==d.is_group?"permission_group_default":"permission_user_default")+")":c._formatPermissionName(a)+" ("+b.ui.texts.get("permission_system_default")+")":c._formatPermissionName(a)}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),type:"select",options:function(a){var b=c._permissionTypes.values[a.name];return b?b:["0","1"]},none:b.ui.texts.get("permission_value_undefined"),formatter:function(a,b){return c._formatPermissionValue(a.name,b)},onChange:function(a,b){a.value=b,f["new"].remove(a),f.modified.remove(a),f.removed.remove(a),null!=b?a.isnew?f["new"].push(a):f.modified.push(a):a.isnew||f.removed.push(a)}}];d&&n.push({id:"default",title:b.ui.texts.get("permission_system_default"),formatter:function(a){return a.name in l&&void 0!==l[a.name]?c._formatPermissionValue(a.name,l[a.name]):""}}),i=b.ui.controls.table("mollify-pluginpermissions-editor-generic-permission-list",{key:"name",columns:n}),i.add(m)};d?b.service.get("permissions/user/0/generic/").done(h):h()}).fail(e.close)}})},this.getUserConfigPermissionsListView=function(d,e,f){var g=!1,h=!1,i=!1,j=function(){d.addClass("loading"),b.service.get("permissions/user/"+f.id+"/generic/").done(function(e){b.service.get("permissions/user/0/generic/").done(function(j){d.removeClass("loading"),h=b.helpers.mapByKey(j.permissions,"name","value");var k=b.helpers.mapByKey(e.permissions,"name");g=[],a.each(c._permissionTypes.keys.all,function(a,b){var c=k[b],d=c?c:{name:b,value:void 0,subject:"",user_id:f.id};g.push(d)}),i.table.set(g)})})};return i=new b.view.ConfigListView(d,{title:e,actions:[{id:"action-edit",content:'<i class="icon-user"></i>',tooltip:b.ui.texts.get("1"==f.is_group?"pluginPermissionsEditGroupPermissionsAction":"pluginPermissionsEditUserPermissionsAction"),callback:function(){c.editGenericPermissions(f,j)}},{id:"action-edit-defaults",content:'<i class="icon-globe"></i>',tooltip:b.ui.texts.get("pluginPermissionsEditDefaultPermissionsAction"),callback:function(){c.editGenericPermissions(!1,j)
}}],table:{id:"config-admin-userpermissions",key:"id",narrow:!0,columns:[{id:"name",title:b.ui.texts.get("pluginPermissionsPermissionName"),formatter:function(a,d){return b.ui.texts.get(d in c._permissionTypes.keys.filesystem?"permission_default_"+d:"permission_"+d)}},{id:"value",title:b.ui.texts.get("pluginPermissionsPermissionValue"),formatter:function(a,b){return void 0===b?"":c._formatPermissionValue(a.name,b)}},{id:"default",title:b.ui.texts.get("permission_system_default"),formatter:function(a){return a.name in h&&void 0!==h[a.name]?c._formatPermissionValue(a.name,h[a.name]):""}}]}}),j(),{refresh:j,view:i}},{id:"plugin-permissions",initialize:c.initialize,itemContextHandler:function(a){return b.session.user.admin?{details:{"title-key":"pluginPermissionsContextTitle","on-render":function(b,d){c.renderItemContextDetails(b,a,d)}},actions:[{id:"pluginPermissions","title-key":"pluginPermissionsAction",callback:function(){c.editItemPermissions(a)}}]}:!1},configViewHandler:{views:function(){return[{viewId:"permissions",admin:!0,title:b.ui.texts.get("pluginPermissionsConfigViewNavTitle"),onActivate:c.onActivateConfigView}]}},editGenericPermissions:c.editGenericPermissions,getUserConfigPermissionsListView:c.getUserConfigPermissionsListView}},b.plugin.DropboxPlugin=function(){var c=this;return c.w=0,c.$dbE=!1,c.items=[],c.itemsByKey={},this.initialize=function(){c._pathFormatter=new b.ui.formatters.FilesystemItemPath,c.itemContext=new b.ui.itemContext,b.events.addEventHandler(function(a){"filesystem/delete"==a.type&&c.onRemoveItems(b.helpers.extractValue(a.payload.items,"id"))})},this.onFileViewActivate=function(d){b.dom.template("mollify-tmpl-mainview-dropbox").appendTo(d),a("#mollify-dropbox-handle").click(function(){c.openDropbox()}),c.$dbE=a("#mollify-dropbox"),c.w=a("#mollify-dropbox-content").outerWidth();var e=function(){var b=a("#mollify-mainview-header").height();c.$dbE.css("top",b+"px").height(a(window).height()-b)};if(a(window).resize(e),e(),b.ui.draganddrop){var f={canDrop:function(a,b,d){if(!d||"filesystemitem"!=d.type)return!1;var e=d.payload;return c.items.indexOf(e)<0},dropType:function(a,b,c){return c&&"filesystemitem"==c.type?"copy":!1},onDrop:function(a,b,d){if(d&&"filesystemitem"==d.type){var e=d.payload;c.onAddItem(e)}}};b.ui.draganddrop.enableDrop(a("#mollify-dropbox-list"),f),b.ui.draganddrop.enableDrop(a("#mollify-dropbox-handle"),f)}b.ui.controls.dropdown({element:a("#mollify-dropbox-actions"),container:a("body"),hideDelay:0,dynamic:!0,onShow:function(a){c.getActions(function(b){return b?void a.items(b):void a.hide()})},onItem:function(a,b){b?b.done(c.emptyDropbox):c.emptyDropbox()},onBlur:function(){}});c._updateButton(),c.openDropbox(!1)},this.onFileViewDeactivate=function(){a("#mollify-dropbox").remove()},this.getActions=function(a){if(0===c.items.length)return void a([]);var d=b.helpers.getPluginActions(b.plugins.getItemCollectionPlugins(c.items,{src:"dropbox"}));d.push({title:"-"}),d.push({"title-key":"dropboxEmpty"}),a(b.helpers.cleanupActions(d))},this.openDropbox=function(a){var b=c.$dbE.hasClass("opened");if(window.def(a)){if(a==b)return}else a=!b;a?c.$dbE.addClass("opened").removeClass("closed").animate({width:c.w+""},300):c.$dbE.removeClass("opened").addClass("closed").animate({width:"0"},300)},this.emptyDropbox=function(){c.items=[],c.itemsByKey={},c.refreshList()},this.onAddItem=function(b){c.openDropbox(!0);var d=b;window.isArray(b)||(d=[b]),a.each(d,function(a,b){c.items.indexOf(b)>=0||(c.items.push(b),c.itemsByKey[b.id]=b)}),c.refreshList(),c._updateButton()},this.onRemoveItem=function(a){c.items.remove(a),delete c.itemsByKey[a.id],c.refreshList(),c._updateButton()},this.onRemoveItems=function(b){var d=0;a.each(b,function(a,b){var e=c.itemsByKey[b];e&&(c.items.remove(e),delete c.itemsByKey[b],d++)}),d>0&&(c.refreshList(),c._updateButton())},this.refreshList=function(){a("#mollify-dropbox-list").empty().append(b.dom.template("mollify-tmpl-mainview-dropbox-item",c.items));var d=a("#mollify-dropbox-list .mollify-dropbox-list-item");d.click(function(d){d.preventDefault(),d.stopPropagation();var e=a(this),f=e.tmplItem().data;return e.tooltip("hide"),c.itemContext.open({item:f,element:e,container:b.App.getElement(),viewport:b.App.getElement()}),!1}).each(function(){var b=a(this),d=b.tmplItem().data;b.tooltip({placement:"bottom",html:!0,title:c._pathFormatter.format(d),trigger:"hover"})}),b.ui.draganddrop&&b.ui.draganddrop.enableDrag(d,{onDragStart:function(a){var b=a.tmplItem().data;return{type:"filesystemitem",payload:b}}}),a("#mollify-dropbox-list .mollify-dropbox-list-item > a.item-remove").click(function(){b.ui.hideActivePopup();var d=a(this);c.onRemoveItem(d.tmplItem().data)})},this._updateButton=function(){var b=a("#mollify-dropbox-actions > button");c.items.length>0?b.removeClass("disabled"):b.addClass("disabled")},{id:"plugin-dropbox",initialize:c.initialize,fileViewHandler:{onActivate:c.onFileViewActivate,onDeactivate:c.onFileViewDeactivate},itemContextHandler:function(a){return{actions:[{id:"pluginDropbox","title-key":"pluginDropboxAddTo",callback:function(){c.onAddItem(a),c.openDropbox(!0)}}]}},itemCollectionHandler:function(a,b){return b&&"dropbox"==b.src?!1:{actions:[{"title-key":"pluginDropboxAddTo",callback:function(){return c.onAddItem(a)}}]}}}},b.plugin.SharePlugin=function(){var c=this;return this.initialize=function(){c._timestampFormatter=new b.ui.formatters.Timestamp(b.ui.texts.get("shortDateTimeFormat")),b.App.registerView("share",{getView:function(d){if(2!=d.length)return!1;var e=a.Deferred(),f=d[1];return b.service.get("public/"+f+"/info/").done(function(a){if(!a||!a.type||["download","upload","prepared_download"].indexOf(a.type)<0)return void e.resolve(new b.ui.FullErrorView(b.ui.texts.get("shareViewInvalidRequest")));if("private"==a.restriction){if(!b.session||!b.session.authenticated)return void e.resolve(!1)}else if("pw"==a.restriction&&!a.auth)return void e.resolve(new c.ShareAccessPasswordView(f,a));e.resolve(c._getShareView(f,a))}).fail(function(){e.resolve(new b.ui.FullErrorView(b.ui.texts.get("shareViewInvalidRequest")))}),e.promise()}})},this._getShareView=function(a,d){var e=b.service.url("public/"+a,!0),f={get:function(a,c){var d=e;return a&&(d+=a),c&&(d=b.helpers.urlWithParam(d,c)),b.helpers.noncachedUrl(d)}};return"download"==d.type?new c.ShareDownloadView(a,f,d.name):"prepared_download"==d.type?new c.SharePreparedDownloadView(a,f,d.name):new c.ShareUploadView(a,f,d.name)},this.ShareAccessPasswordView=function(d,e){var f=this;this.init=function(c){f._$c=c,b.dom.loadContentInto(c,b.plugins.url("Share","public_share_access_password.html"),function(){a("#mollify-share-access-button").click(f._onAccess),a("#mollify-share-access-password").focus(),a("#mollify-share-access-password").bind("keypress",function(a){13==(a.keyCode||a.which)&&f._onAccess()})},["localize"])},this._onAccess=function(){var g=a("#mollify-share-access-password").val();if(g&&0!==g.length){var h=window.Base64.encode(g);b.service.post("public/"+d+"/key/",{key:h}).done(function(g){return g.result?void c._getShareView(d,e,h).init(f._$c):(b.ui.dialogs.notification({message:b.ui.texts.get("shareAccessPasswordFailed")}),void a("#mollify-share-access-password").focus())})}}},this.ShareDownloadView=function(c,d,e){this.init=function(c){b.dom.loadContentInto(c,b.plugins.url("Share","public_share_download.html"),function(){a("#mollify-share-title").text(b.ui.texts.get("shareViewDownloadTitle",e)),setTimeout(function(){b.ui.download(d.get())},1e3)},["localize"])}},this.SharePreparedDownloadView=function(c,d,e){this.init=function(c){b.dom.loadContentInto(c,b.plugins.url("Share","public_share_prepared_download.html"),function(){a("#mollify-share-download-prepare").text(b.ui.texts.get("shareViewPreparedDownloadPreparingTitle",e)),a("#mollify-share-download").text(b.ui.texts.get("shareViewPreparedDownloadDownloadingTitle",e)),a("#mollify-share-download-error").text(b.ui.texts.get("shareViewPreparedDownloadErrorTitle",e)),b.service.get(d.get("/prepare")).done(function(c){a("#mollify-share-download-prepare").hide(),a("#mollify-share-download").show(),b.ui.download(d.get(!1,"key="+c.key))}).fail(function(){this.handled=!0,a("#mollify-share-download-prepare").hide(),a("#mollify-share-download-error").show()})},["localize"])}},this.ShareUploadView=function(d,e,f){var g=this;this.init=function(d){var h=new b.ui.formatters.Number(1,b.ui.texts.get("dataRateKbps"),b.ui.texts.get("decimalSeparator"));b.dom.loadContentInto(d,b.plugins.url("Share","public_share_upload.html"),function(){a("#mollify-share-title").text(b.ui.texts.get("shareViewUploadTitle",f)),g._uploadProgress=new c.PublicUploaderProgress(a("#mollify-share-public-upload-progress")),b.ui.uploader.initUploadWidget(a("#mollify-share-public-uploader"),{url:e.get(!1,"format=binary"),dropElement:a("#mollify-share-public"),handler:{start:function(a,c){g._uploadProgress.start(b.ui.texts.get(a.length>1?"mainviewUploadProgressManyMessage":"mainviewUploadProgressOneMessage",a.length)),c()},progress:function(a,b){var c="";b&&(c=h.format(b/1024)),g._uploadProgress.update(a,c)},finished:function(){setTimeout(function(){g._uploadProgress.success(b.ui.texts.get("mainviewFileUploadComplete"))},1e3)},failed:function(a){g._uploadProgress.failure(a&&216==a.code?b.ui.texts.get("mainviewFileUploadNotAllowed"):b.ui.texts.get("mainviewFileUploadFailed"))}}})},["localize"])}},this.PublicUploaderProgress=function(a){var b=this;return b._$title=a.find(".title"),b._$speed=a.find(".speed"),b._$bar=a.find(".bar"),{start:function(c){a.removeClass("success failure"),b._$title.text(c?c:""),b._$speed.text(""),b._$bar.css("width","0%")},update:function(a,c){b._$bar.css("width",a+"%"),b._$speed.text(c?c:"")},success:function(c){a.addClass("success"),b._$bar.css("width","0%"),b._$title.text(c),b._$speed.text("")},failure:function(c){a.addClass("failure"),b._$title.text(c),b._$speed.text(""),b._$bar.css("width","0%")}}},this.renderItemContextDetails=function(a,d,e){e.addClass("loading"),b.templates.load("shares-content",b.helpers.noncachedUrl(b.plugins.url("Share","content.html"))).done(function(){e.removeClass("loading"),b.dom.template("mollify-tmpl-shares",{item:d}).appendTo(e),c.loadShares(d).done(function(a){c.initContent(d,a,e)})})},this.loadShares=function(a){return a?b.service.get("share/items/"+a.id).done(function(a){c.refreshShares(a)}):b.service.get("share/all/")},this.refreshShares=function(a){c.shares=a,c.shareIds=[];for(var b=0,d=c.shares.length;d>b;b++)c.shareIds.push(a[b].id)},this.getShare=function(a){return c.shares[c.shareIds.indexOf(a)]},this.initContent=function(d){var e=d.shareTitle?d.shareTitle:b.ui.texts.get(d.is_file?"shareDialogShareFileTitle":"shareDialogShareFolderTitle");a("#share-item-title").html(e),a("#share-item-name").html(d.name),a("#share-dialog-content").removeClass("loading"),a("#share-new").click(function(){c.onAddShare(d)}),c._context=b.ui.controls.slidePanel(a("#share-list"),{relative:!0}),c.updateShareList(d)},this.getShareLink=function(a){return b.App.getPageUrl("share/"+a.id)},this.updateShareList=function(d){if(a("#share-items").empty(),0===c.shares.length)return void a("#share-items").html('<div class="no-share-items">'+b.ui.texts.get("shareDialogNoShares")+"</div>");var e={itemClass:function(){var a="item-share";return this.data.active||(a+=" inactive"),this.data.name&&0!==this.data.name.length||(a+=" unnamed"),a},link:function(){return c.getShareLink(this.data)}};if(b.dom.template("share-template",c.shares,e).appendTo("#share-items"),b.ui.process(a("#share-list"),["localize"]),b.ui.clipboard){var f={onMouseOver:function(a,b){b.setHandCursor(!0),a.addClass("hover")},onMouseOut:function(a){a.removeClass("hover")}};a.each(a(".share-link-copy"),function(d,e){var g=a(e).tmplItem().data;b.ui.clipboard.enableCopy(a(e),c.getShareLink(g),f)})}else a(".share-link-copy").hide();a(".share-link-toggle").click(function(){var b=a(this).tmplItem().data;if(b.active){var c=a(this).parent(),d=c.parent().siblings(".share-link-content"),e=d.parent();return a(".share-link-content").not(d).hide(),a(".item-share").not(e).removeClass("active"),e.toggleClass("active"),d.slideToggle(),!1}}),a(".item-share").hover(function(){a(".item-share").removeClass("hover"),a(this).addClass("hover")},function(){}),a(".share-edit").click(function(){var b=a(this).tmplItem().data;c.onEditShare(d,b)}),a(".share-remove").click(function(){var b=a(this).tmplItem().data;c.removeShare(d,b)})},this.openContextContent=function(a,d,e){var f=c._context.getContentElement().empty();b.dom.template(d,e).appendTo(f),b.ui.process(f,["localize"]),b.ui.controls.datepicker("share-validity-expirationdate-value",{format:b.ui.texts.get("shortDateTimeFormat"),time:!0}),c._context.show(!1,280)},this.closeAddEdit=function(){c._context.hide()},this.onAddShare=function(d){c.openContextContent("add-share-title","share-context-addedit-template"),a("#share-general-name").val(""),a("#share-general-active").attr("checked",!0),a("#share-access-norestriction").attr("checked",!0),a("#share-access-public-password-value").attr("placeholder",b.ui.texts.get("shareDialogShareAccessEnterPwTitle")),a("#share-addedit-btn-ok").click(function(){a("#share-access-public-password-value").removeClass("error");var b=a("#share-general-name").val(),e=a("#share-general-active").is(":checked"),f=a("#share-validity-expirationdate-value").data("mollify-datepicker").get(),g=!1;if(a("#share-access-private-loggedin").is(":checked"))g={type:"private"};else if(a("#share-access-public-password").is(":checked")){var h=a("#share-access-public-password-value").val();if(!h||0===h.length)return void a("#share-access-public-password-value").addClass("error");g={type:"pw",value:h}}a("#share-items").empty().append('<div class="loading"/>'),c.closeAddEdit(),c.addShare(d,b||"",f,e,g)}),a("#share-addedit-btn-cancel").click(function(){c.closeAddEdit()})},this.onEditShare=function(d,e){c.openContextContent("edit-share-title","share-context-addedit-template",{edit:!0}),a("#share-general-name").val(e.name),a("#share-general-active").attr("checked",e.active);var f="pw"==e.restriction;"pw"==e.restriction?a("#share-access-public-password").attr("checked",!0):"private"==e.restriction?a("#share-access-private-loggedin").attr("checked",!0):a("#share-access-norestriction").attr("checked",!0),e.expiration&&a("#share-validity-expirationdate-value").data("mollify-datepicker").set(b.helpers.parseInternalTime(e.expiration)),f?a("#share-access-public-password-value").attr("placeholder",b.ui.texts.get("shareDialogShareAccessChangePwTitle")):a("#share-access-public-password-value").attr("placeholder",b.ui.texts.get("shareDialogShareAccessEnterPwTitle")),a("#share-addedit-btn-ok").click(function(){var b=a("#share-general-name").val(),g=a("#share-general-active").is(":checked"),h=a("#share-validity-expirationdate-value").data("mollify-datepicker").get(),i=!1;if(a("#share-access-private-loggedin").is(":checked"))i={type:"private"};else if(a("#share-access-public-password").is(":checked")){var j=a("#share-access-public-password-value").val();if(!(f||j&&0!==j.length))return void a("#share-access-public-password-value").addClass("error");i={type:"pw",value:j}}a("#share-items").empty().append('<div class="loading"/>'),c.closeAddEdit(),c.editShare(d,e.id,b||"",h,g,i)}),a("#share-addedit-btn-cancel").click(function(){c.closeAddEdit()})},this.onOpenShares=function(a){b.templates.load("shares-content",b.helpers.noncachedUrl(b.plugins.url("Share","content.html"))).done(function(){b.ui.dialogs.custom({resizable:!0,initSize:[600,470],title:a.shareTitle?a.shareTitle:b.ui.texts.get(a.is_file?"shareDialogShareFileTitle":"shareDialogShareFolderTitle"),content:b.dom.template("mollify-tmpl-shares",{item:a,bubble:!1}),buttons:[{id:"no",title:b.ui.texts.get("dialogClose")}],"on-button":function(a,b){b.close(),c.d=!1},"on-show":function(b,d){c.d=b,c.loadShares(a).done(function(b){c.initContent(a,b,d)})}})})},this.addShare=function(a,d,e,f,g){return b.service.post("share/",{item:a.id,name:d,expiration:b.helpers.formatInternalTime(e),active:f,restriction:g}).done(function(b){c.refreshShares(b),c.updateShareList(a)}).fail(c.d.close)},this.editShare=function(a,d,e,f,g,h){return b.service.put("share/"+d,{id:d,name:e,expiration:b.helpers.formatInternalTime(f),active:g,restriction:h}).done(function(){var i=c.getShare(d);i.name=e,i.active=g,i.expiration=b.helpers.formatInternalTime(f),i.restriction=h?h.type:!1,c.updateShareList(a)}).fail(c.d.close)},this.removeShare=function(a,d){return b.service.del("share/"+d.id).done(function(){var b=c.shareIds.indexOf(d.id);c.shareIds.splice(b,1),c.shares.splice(b,1),c.updateShareList(a)}).fail(c.d.close)},this.removeAllItemShares=function(a){return b.service.del("share/items/"+a.id)},this.getActionValidationMessages=function(c,d){var e=[];return a.each(d,function(a,c){var d;if("item_shared"==c.reason)d=b.ui.texts.get("pluginShareActionValidationDeleteShared",c.item.name);else{if("item_shared_others"!=c.reason)return;d=b.ui.texts.get("pluginShareActionValidationDeleteSharedOthers",c.item.name)}e.push({message:d,acceptable:c.acceptable,acceptKey:c.acceptKey})}),e},this.getListCellContent=function(a,c){if(!a.id||0===a.id.length||!c||!c["plugin-share-info"])return"";var d=c["plugin-share-info"][a.id];return d?d.own>0?"<div id='item-share-info-"+a.id+"' class='filelist-item-share-info'><i class='icon-external-link'></i>&nbsp;"+d.own+"</div>":"<div id='item-share-info-"+a.id+"' class='filelist-item-share-info others' title='"+b.ui.texts.get("pluginShareFilelistColOtherShared")+"'><i class='icon-external-link'></i></div>":"<div id='item-share-info-"+a.id+"' class='filelist-item-share-info empty'></div>"},this._updateListCellContent=function(){},this.showShareBubble=function(d,e){c.d=b.ui.controls.dynamicBubble({element:e,title:d.name,container:a("#mollify-filelist-main-items")}),b.templates.load("shares-content",b.helpers.noncachedUrl(b.plugins.url("Share","content.html"))).done(function(){c.d.content(b.dom.template("mollify-tmpl-shares",{item:d,bubble:!0})),c.loadShares(d).done(function(a){c.initContent(d,a,c.d.element()),c.d.position()})})},this.onActivateConfigView=function(a,d){var e=!1,f=!1,g=[],h=!1,i=function(){d.showLoading(!0),c.loadShares().done(function(a){e=a.shares[b.session.user.id],f=a.items,g=a.invalid,h.table.set(f),d.showLoading(!1)})},j=function(a){return 0===g.length?!0:g.indexOf(a.id)<0};h=new b.view.ConfigListView(a,{table:{key:"id",columns:[{id:"icon",title:"",valueMapper:function(a){return j(a)?'<i class="icon-file"></i>':'<i class="icon-exclamation"></i>'}},{id:"name",title:b.ui.texts.get("fileListColumnTitleName")},{id:"count",title:b.ui.texts.get("pluginShareConfigViewCountTitle"),formatter:function(a){return e[a.id].length}},{id:"edit",title:"",type:"action",formatter:function(a){return j(a)?'<i class="icon-edit"></i>':""}},{id:"remove",title:"",type:"action",content:'<i class="icon-trash"></i>'}],onRow:function(a,b){j(b)||a.addClass("error")},onRowAction:function(a,b){"edit"==a?c.onOpenShares(b):"remove"==a&&c.removeAllItemShares(b).done(i)}}}),i()},{id:"plugin-share",backendPluginId:"Share",resources:{css:!0},initialize:c.initialize,configViewHandler:{views:function(){return[{viewId:"shares",title:b.ui.texts.get("pluginShareConfigViewNavTitle"),onActivate:c.onActivateConfigView}]}},fileViewHandler:{filelistColumns:function(){return[{id:"share-info","request-id":"plugin-share-info","title-key":"",content:c.getListCellContent,request:function(){return{}},"on-click":function(b,d){if(b.id&&0!==b.id.length&&d&&d["plugin-share-info"]){var e=d["plugin-share-info"][b.id];e&&e.own>0&&c.showShareBubble(b,a("#item-share-info-"+b.id))}}}]}},itemContextHandler:function(a,b){return b.details.permissions.share_item?{actions:[{id:"pluginShare","title-key":"itemContextShareMenuTitle",icon:"external-link",callback:function(){c.onOpenShares(a)}}]}:!1},actionValidationHandler:function(){return{getValidationMessages:c.getActionValidationMessages}},openShares:c.onOpenShares}},b.plugin.SendViaEmailPlugin=function(){var b=this;return this.initialize=function(){},{id:"plugin-sendviaemail",initialize:b.initialize,itemContextHandler:function(a){return a.is_file?{actions:[{"title-key":"actionSendViaEmailSingle",callback:function(){}}]}:!1},itemCollectionHandler:function(b){var c=!1;return a.each(b,function(a,b){return b.is_file?void 0:(c=!0,!1)}),c?!1:{actions:[{"title-key":"actionSendViaEmailMultiple",callback:function(){}}]}}}},b.plugin.RegistrationPlugin=function(){var c=this;return this.initialize=function(){b.App.registerView("registration",{getView:function(a,b){return 2!=a.length?!1:"new"==a[1]?new c.NewRegistrationView(b):"confirm"==a[1]?new c.ConfirmRegistrationView(b):!1}})},this.NewRegistrationView=function(){var c=this;this.init=function(d){b.dom.loadContentInto(d,b.plugins.url("Registration","registration_create.html"),function(){a("#register-new-button").click(c.onRegister),a("#registration-new-name").focus()},["localize"])},this.onRegister=function(){a(".control-group").removeClass("error");var c=a("#registration-new-name").val(),d=a("#registration-new-pw").val(),e=a("#registration-new-pw-confirm").val(),f=a("#registration-new-email").val(),g=!0;return c&&0!==c.length||(a("#registration-new-name").closest(".control-group").addClass("error"),g=!1),d&&0!==d.length||(a("#registration-new-pw").closest(".control-group").addClass("error"),g=!1),e&&0!==e.length||(a("#registration-new-pw-confirm").closest(".control-group").addClass("error"),g=!1),f&&0!==f.length||(a("#registration-new-email").closest(".control-group").addClass("error"),g=!1),g?d!=e?(a("#registration-new-pw").closest(".control-group").addClass("error"),void a("#registration-new-pw-confirm").closest(".control-group").addClass("error")):void b.service.post("registration/create",{name:c,password:window.Base64.encode(d),email:f,data:null}).done(function(){a("#mollify-registration-form").hide(),a("#mollify-registration-main").addClass("wide"),a("#mollify-registration-success").show()}).fail(function(){this.handled=!0,b.ui.dialogs.error({message:b.ui.texts.get("registrationFailed")})}):void 0}},this.ConfirmRegistrationView=function(c){var d=this;this.init=function(e){b.dom.loadContentInto(e,b.plugins.url("Registration","registration_confirm.html"),function(){return c.email&&0!==c.email.length?(d._email=c.email,void(c.key&&c.key.length>0?d._confirm(d._email,c.key):(a("#mollify-registration-confirm-form").show(),a("#registration-confirm-email").val(d._email),a("#register-confirm-button").click(d.onConfirm),a("#registration-confirm-key").focus()))):void a("#mollify-registration-main").addClass("complete").empty().append(b.dom.template("mollify-tmpl-registration-errormessage",{message:b.ui.texts.get("registrationInvalidConfirm")}))},["localize"])},this.onConfirm=function(){a(".control-group").removeClass("error");var b=a("#registration-confirm-key").val(),c=!0;b&&0!==b.length||(a("#registration-confirm-key").closest(".control-group").addClass("error"),c=!1),c&&d._confirm(d._email,b,!0)},this._confirm=function(c,d,e){a("#mollify-registration-main").addClass("loading"),b.service.post("registration/confirm",{email:c,key:d}).done(function(b){a("#mollify-registration-confirm-form").hide(),a("#mollify-registration-main").removeClass("loading").addClass("wide"),b.require_approval?a("#mollify-registration-confirm-success-wait-approval").show():a("#mollify-registration-confirm-success").show()}).fail(function(){a("#mollify-registration-main").removeClass("loading"),this.handled=!0,e?b.ui.dialogs.error({message:b.ui.texts.get("registrationConfirmFailed")}):a("#mollify-registration-main").addClass("wide").empty().append(b.dom.template("mollify-tmpl-registration-errormessage",{message:b.ui.texts.get("registrationConfirmFailed")}))})}},{id:"plugin-registration",initialize:c.initialize,show:function(){b.App.openPage("registration/new")}}}}(window.jQuery,window.mollify),!function(a,b){"use strict";b.ui.texts={};var c=b.ui.texts;c.locale=null,c._dict={},c._pluginTextsLoaded=[],c.load=function(b){var d=a.Deferred();return c.locale?d.resolve():c._load("localization/texts_"+(b||"en")+".json",d)},c.clear=function(){c.locale=null,c._dict={},c._pluginTextsLoaded=[]},c.loadPlugin=function(d){return c._pluginTextsLoaded.indexOf(d)>=0?a.Deferred().resolve():c._load(b.plugins.getLocalizationUrl(d),a.Deferred()).done(function(){c._pluginTextsLoaded.push(d)})},c._load=function(d,e){var f=b.resourceUrl(d);return f?(a.ajax({type:"GET",dataType:"text",url:f}).done(function(a){if(!a||"string"!=typeof a)return void e.reject();var d=!1;try{d=JSON.parse(a)}catch(g){return void new b.ui.FullErrorView("<b>Localization file syntax error</b> (<code>"+f+"</code>)","<code>"+g.message+"</code>").show()}if(c.locale){if(c.locale!=d.locale)return void e.reject()}else c.locale=d.locale;c.add(d.locale,d.texts),e.resolve(d.locale)}).fail(function(a){return 404==a.status?void new b.ui.FullErrorView("Localization file missing: <code>"+f+"</code>",'Either create the file or use <a href="https://code.google.com/p/mollify/wiki/ClientResourceMap">client resource map</a> to load it from different location, or to ignore it').show():void e.reject()}),e):e.resolve()},c.add=function(a,b){if(a&&b){if(c.locale){if(a!=c.locale)return}else c.locale=a;for(var d in b)c._dict[d]=b[d]}},c.get=function(a,b){if(!a)return"";var d=c._dict[a];if(!d)return"!"+c.locale+":"+a;if(void 0!==b){window.isArray(b)||(b=[b]);for(var e=0,f=b.length;f>e;e++)d=d.replace("{"+e+"}",b[e])}return d},c.has=function(a){return!!c._dict[a]},b.ui.formatters={ByteSize:function(a){this.format=function(c){if(!window.def(c))return"";var d=c;if("string"==typeof c){if(d=parseInt(d,10),isNaN(d))return""}else if("number"!=typeof c)return"";if(1024>d)return 1==d?b.ui.texts.get("sizeOneByte"):b.ui.texts.get("sizeInBytes",a.format(d));if(1048576>d){var e=d/1024;return 1==e?b.ui.texts.get("sizeOneKilobyte"):b.ui.texts.get("sizeInKilobytes",a.format(e))}if(1073741824>d){var f=d/1048576;return b.ui.texts.get("sizeInMegabytes",a.format(f))}var g=d/1073741824;return b.ui.texts.get("sizeInGigabytes",a.format(g))}},Timestamp:function(a){this.format=function(c){return null==c?"":("string"==typeof c&&(c=b.helpers.parseInternalTime(c)),c.toString(a))}},Number:function(a,b,c){this.format=function(d){if(!window.def(d)||"number"!=typeof d)return"";var e=Math.pow(10,a),f=Math.floor(d*e)/e,g=f.toString();return c&&(g=g.replace(".",c)),b?g+" "+b:g}},FilesystemItemPath:function(){this.format=function(a){return a?b.filesystem.rootsById[a.root_id].name+(a.path.length>0?":&nbsp;"+a.path:""):""}}},b.ui.uploader=!1,b.ui.draganddrop=!1,b.ui._activePopup=!1,b.ui.initialize=function(){var c=[];c.push(b.ui.initializeLang()),a("body").append('<div style="width: 0px; height: 0px; overflow: hidden;"><iframe id="mollify-download-frame" src=""></iframe></div>'),a(window).click(function(c){if(b.ui._activePopup){if(c&&c.toElement&&b.ui._activePopup.element){var d=b.ui._activePopup.element();if(d.has(a(c.toElement)).length>0)return}b.ui.hideActivePopup()}}),c.push(b.templates.load("dialogs.html")),b.ui.draganddrop||(b.ui.draganddrop=window.Modernizr.draganddrop?new b.MollifyHTML5DragAndDrop:new b.MollifyJQueryDragAndDrop),b.ui.uploader||(b.ui.uploader=new b.MollifyHTML5Uploader),b.ui.clipboard||new b.ZeroClipboard(function(a){b.ui.clipboard=a});var d=a.Deferred();return a.when.apply(a,c).done(d.resolve).fail(d.reject),d},b.ui.initializeLang=function(){var c=a.Deferred(),d=b.session.user&&b.session.user.lang?b.session.user.lang:b.settings.language["default"]||"en";if(b.ui.texts.locale&&b.ui.texts.locale==d)return c.resolve();var e=b.ui.texts._pluginTextsLoaded;b.ui.texts.locale&&(b.App.getElement().removeClass("lang-"+b.ui.texts.locale),b.ui.texts.clear());var f=[];return f.push(b.ui.texts.load(d).done(function(c){a("html").attr("lang",c),b.App.getElement().addClass("lang-"+c)})),e&&a.each(e,function(a,c){f.push(b.ui.texts.loadPlugin(c))}),a.when.apply(a,f).done(c.resolve).fail(c.reject),c},b.ui.hideActivePopup=function(){b.ui._activePopup&&b.ui._activePopup.hide(),b.ui._activePopup=!1},b.ui.activePopup=function(a){if(void 0===a)return b.ui._activePopup;if(b.ui._activePopup){if(a.parentPopupId&&b.ui._activePopup.id==a.parentPopupId)return;b.ui._activePopup.hide()}return b.ui._activePopup=a,b.ui._activePopup.id||(b.ui._activePopup.id=(new Date).getTime()),b.ui._activePopup.id},b.ui.isActivePopup=function(a){return b.ui._activePopup&&b.ui._activePopup.id==a},b.ui.removeActivePopup=function(a){a&&b.ui.isActivePopup(a)&&(b.ui._activePopup=!1)},b.ui.download=function(c){b.App.mobile?window.open(c):a("#mollify-download-frame").attr("src",c)},b.ui.itemContext=function(){var c={};return c._activeItemContext=!1,c.open=function(d){var e=d.item,f=d.element,g=d.viewport,h=d.container,i=(d.folder,"mainview-itemcontext-"+e.id);if(!b.ui.isActivePopup(i)){var j=!1;if(c._activeItemContext&&(j=c._activeItemContext.item.id,c._activeItemContext.close(),c._activeItemContext=!1),e.id!=j){var k=h||f.parent(),l=b.dom.template("mollify-tmpl-main-itemcontext",e,{})[0].outerHTML;f.popover({title:e.name,html:!0,placement:"bottom",trigger:"manual",template:'<div class="popover mollify-itemcontext-popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>',content:l,container:k}).bind("shown",function(){var j={id:i,hide:function(){f.popover("destroy")}};j.close=j.hide,b.ui.activePopup(j);var l=a("#mollify-itemcontext-"+e.id),m=l.closest(".popover"),n=g.outerWidth(),o=m.offset().left-k.offset().left,p=m.outerWidth();0>o?o=0:o+p>n&&(o=n-p-10),m.css("left",o+"px");var q=f.offset().left-k.offset().left+f.outerWidth()/2;q=Math.max(0,q-o),m.find(".arrow").css("left",q+"px"),m.find(".popover-title").append(a('<button type="button" class="close">×</button>').click(j.close));var r=l.find(".mollify-itemcontext-content");b.filesystem.itemDetails(e,b.plugins.getItemContextRequestData(e)).done(function(a){if(!a)return void h.hide();var f={details:a,hasPermission:function(c,d){b.helpers.hasPermission(a.permissions,c,d)},hasParentPermission:function(c,d){b.helpers.hasPermission(a.parent_permissions,c,d)},folder:d.folder,folder_writable:d.folder_writable};c.renderItemContext(j,r,e,f)})}).bind("hidden",function(){f.unbind("shown").unbind("hidden"),b.ui.removeActivePopup(i)}),f.popover("show")}}},c.renderItemContext=function(c,d,e,f){var g=b.features.hasFeature("descriptions")&&f.hasPermission("edit_description"),h=g||!!f.details.description,i=b.plugins.getItemContextPlugins(e,f),j=b.helpers.getPluginActions(i),k=b.helpers.getPrimaryActions(j),l=b.helpers.getSecondaryActions(j),m={item:e,details:f.details,showDescription:h,description:f.details.description||"",session:b.session,plugins:i,primaryActions:k};if(d.removeClass("loading").empty().append(b.dom.template("mollify-tmpl-main-itemcontext-content",m,{title:function(a){var c=a;return"submenu"==c.type&&(c=c.primary),c.title?c.title:b.ui.texts.get(c["title-key"])}})),d.click(function(a){return a.preventDefault(),!1}),b.ui.process(d,["localize"]),g&&b.ui.controls.editableLabel({element:a("#mollify-itemcontext-description"),hint:b.ui.texts.get("itemcontextDescriptionHint"),onedit:function(a){b.service.put("filesystem/"+e.id+"/description/",{description:a})}}),k){var n=d.find(".mollify-itemcontext-primary-action-button");n.each(function(a,d){var e=k[a];"submenu"==e.type&&b.ui.controls.dropdown({element:d,items:e.items,hideDelay:0,style:"submenu",parentPopupId:c.id,onItem:function(){c.hide()},onBlur:function(a){a.hide()}})}),n.click(function(){var b=n.index(a(this)),d=k[b];"submenu"!=d.type&&(c.close(),d.callback())})}if(i){var o=a("#mollify-itemcontext-details-selectors"),p=a("#mollify-itemcontext-details-content"),q={},r=function(b){a(".mollify-itemcontext-details-selector").removeClass("active"),a("#mollify-itemcontext-details-selector-"+b).addClass("active"),p.find(".mollify-itemcontext-plugin-content").hide();var d=q[b]?q[b]:!1;
d||(d=a('<div class="mollify-itemcontext-plugin-content"></div>'),i[b].details["on-render"](c,d,f),q[b]=d,p.append(d)),d.show()},s=!1,t=function(){var b=a(this).tmplItem().data;r(b.id)};for(var u in i){var v=i[u];if(v.details){s||(s=u);{var w=v.details.title?v.details.title:v.details["title-key"]?b.ui.texts.get(v.details["title-key"]):u;b.dom.template("mollify-tmpl-main-itemcontext-details-selector",{id:u,title:w,data:v}).appendTo(o).click(t)}}}s&&r(s)}b.ui.controls.dropdown({element:d.find("#mollify-itemcontext-secondary-actions"),items:l,hideDelay:0,style:"submenu",parentPopupId:c.id,onItem:function(){c.hide()},onBlur:function(a){a.hide()}})},{open:c.open}},b.ui.assign=function(a,b,c){a&&b&&c&&(a.controls||(a.controls={}),a.controls[b]=c)},b.ui.process=function(c,d,e){a.each(d,function(a,d){b.ui.handlers[d]&&b.ui.handlers[d](c,e)})},b.ui.handlers={localize:function(c){c.find(".localized").each(function(){var c=a(this),d=c.attr("title-key");d&&(c.attr("title",b.ui.texts.get(d)),c.removeAttr("title-key")),d=c.attr("text-key"),d&&(c.prepend(b.ui.texts.get(d)),c.removeAttr("text-key"))}),c.find("input.hintbox").each(function(){var c=a(this),d=b.ui.texts.get(c.attr("hint-key"));c.attr("placeholder",d).removeAttr("hint-key")})},center:function(b){b.find(".center").each(function(){var b=a(this),c=(b.parent().width()-b.outerWidth(!0))/2;b.css({position:"relative",left:c})})},hover:function(b){b.find(".hoverable").hover(function(){a(this).addClass("hover")},function(){a(this).removeClass("hover")})},bubble:function(c,d){c.find(".bubble-trigger").each(function(){var c=a(this),e=b.ui.controls.bubble({element:c,handler:d});b.ui.assign(d,c.attr("id"),e)})},radio:function(c,d){c.find(".mollify-radio").each(function(){var c=a(this),e=b.ui.controls.radio(c,d);b.ui.assign(d,c.attr("id"),e)})}},b.ui.window={open:function(a){window.open(a)}},b.ui.preloadImages=function(b){a.each(b,function(){a("<img/>")[0].src=this})},b.ui.FullErrorView=function(a,c){this.show=function(){this.init(b.App.getElement())},this.init=function(d){if(b.App._initialized)b.dom.template("mollify-tmpl-fullpage-error",{title:a,message:c}).appendTo(d.empty());else{var e="<h1>"+a+"</h1><p>"+c+"</p>";d.html(e)}}};var d=function(c){a.each(c,function(a,c){return"submenu"==c.type?void d(c.items):void(c.title||c["title-key"]&&(c.title=b.ui.texts.get(c["title-key"])))})},e=function(a){var c=a||[];return d(c),b.dom.template("mollify-tmpl-popupmenu",{items:c})},f=function(b,c,d){b.find(".dropdown-item").click(function(){for(var e=a(this),f=b.find(".dropdown-menu"),g=[];;)if(e.hasClass("dropdown-menu")||g.push(e.index()),e=e.parent(),e[0]==f[0])break;var h=!1,i=c;return a.each(g.reverse(),function(a,b){h=i[b],"submenu"==h.type&&(i=h.items)}),d?d(h,h.callback?h.callback():null):h.callback&&h.callback(),!1})};b.ui.controls={dropdown:function(c){var d=a(c.element),g=!1,h=!1,i=c.items,j=function(){g&&(c.onHide&&c.onHide(),g.parent().removeClass("open"),b.ui.removeActivePopup(h))},k=function(a,b){j(),c.onItem&&c.onItem(a,b)},l={hide:j,items:function(a){g.remove(),g=e(a),d.removeClass("loading").append(g),f(d,a,k),i=a}};c.parentPopupId&&(l.parentPopupId=c.parentPopupId);var m=d.find(".dropdown-toggle");1==m.length&&(m.parent().append(e(c.items)),m.dropdown({onshow:function(d){g||(g=a(d.find(".dropdown-menu")[0])),c.parentPopupId||(h=b.ui.activePopup(l)),i||g.addClass("loading"),c.onShow&&c.onShow(l,i)},onhide:function(){j(),c.dynamic&&(i=!1)}}),f(d,c.items,k))},popupmenu:function(c){var d=!1,g=a(c.element),h=g.offset(),i=a('<div class="mollify-popupmenu" style="position: absolute; top: '+(h.top+g.outerHeight())+"px; left:"+h.left+'px;"></div>'),j=(c.items,function(){c.onHide&&c.onHide(),i.remove(),b.ui.removeActivePopup(d)}),k=function(a,b){j(),c.onItem&&c.onItem(a,b)};c.items||i.addClass("loading"),i.append(e(c.items).css("display","block")),c.style&&i.addClass(c.style),b.App.getElement().append(i);var l={hide:j,items:function(a){i.empty().removeClass("loading").append(e(a).css("display","block")),f(i,a,k)}};return c.items&&f(i,c.items,k),d=b.ui.activePopup(l),l},bubble:function(c){var d=c.element,e=d.attr("id");if(e){var f=a("#"+e+"-bubble");if(f&&0!==f.length){var g=f.html();f.remove();var h=!1,i=!1,j={hide:function(){d.popover("hide")},close:this.hide},k=a('<div class="popover mollify-bubble-popover"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>');d.popover({title:!1,html:!0,placement:"bottom",trigger:"manual",template:k,content:g}).bind("shown",function(){h=k,b.ui.activePopup(j),i||(c.handler&&c.handler.onRenderBubble&&c.handler.onRenderBubble(e,j),i=!0),c.handler&&c.handler.onShowBubble&&c.handler.onShowBubble(e,j)}).bind("hidden",function(){b.ui.removeActivePopup(j.id)}),d.click(function(a){return a.preventDefault(),d.popover("show"),!1})}}},dynamicBubble:function(c){var d=c.element,e=function(b){return b?"string"==typeof b?b:a("<div/>").append(b).html():""},f=c.content?e(c.content):'<div class="loading"></div>',g=!1,h=c.container||d.parent(),i=c.viewport||h,j=function(){var a=l.closest(".popover"),b=i.outerWidth(),c=a.offset().left-h.offset().left,e=a.outerWidth();0>c?c=0:c+e>b&&(c=b-e-10),a.css("left",c+"px");var f=d.offset().left-h.offset().left+d.outerWidth()/2-10;f=Math.max(0,f-c),a.find(".arrow").css("left",f+"px")},k={show:function(){d.popover("show")},hide:function(a){a?g.hide():d.popover("destroy")},element:function(){return g},getContent:function(){return g.find(".popover-content")},content:function(a){var b=g.find(".popover-content");"string"==typeof a?b.html(a):b.empty().append(a),j()},position:j};k.close=k.hide;var l=a('<div class="popover mollify-bubble-popover"><div class="arrow"></div>'+(c.title?'<h3 class="popover-title"></h3>':"")+'<div class="popover-content"></div></div>');return d.popover({title:c.title?c.title:!1,html:!0,placement:"bottom",trigger:"manual",template:l,content:f,container:h}).bind("shown",function(){g=l,b.ui.activePopup(k),g.click(function(a){a.stopPropagation()}),c.title&&g.find(".popover-title").append(a('<button type="button" class="close">×</button>').click(function(){k.close()})),b.ui.handlers.localize(g),c.handler&&c.handler.onRenderBubble&&c.handler.onRenderBubble(k)}).bind("hidden",function(){d.unbind("shown").unbind("hidden"),b.ui.removeActivePopup(k.id)}),d.popover("show"),k},table:function(c,d){var e=a("string"==typeof c?"#"+c:c);if(0===e.length||!d.columns)return!1;if(e.hasClass("mollify-table")){var f=a("<table></table>").insertAfter(e).attr("id",e.attr("id"));e.remove(),e=f}var g=a.Callbacks();e.addClass("mollify-table"),d.id&&e.addClass("mollify-table-"+d.id),d.onSelectionChanged&&g.add(d.onSelectionChanged),e.addClass("table"),d.narrow&&e.addClass("table-condensed"),d.hilight&&e.addClass("hilight");var h=!1,i=!1,j=d.remote&&d.remote.paging?d.remote.paging.max||50:50,k=function(){var b=i.find("ul").empty(),c=h?Math.ceil(h.total/j):0;if(!(2>c)){var d=h?Math.floor(h.start/j)+1:0,e=(d+Math.floor((c-d)/2),function(b){return a('<li class="page-btn page-nr'+(d==b?" active":"")+'"><a href="javascript:void(0);">'+b+"</a></li>")});if(b.append(a('<li class="page-btn page-prev'+(1>=d?" disabled":"")+'"><a href="javascript:void(0);">&laquo;</a></li>')),10>=c)for(var f=1;c>=f;f++)b.append(e(f));else 1!=d&&b.append(e(1)),d>2&&b.append(e(2)),d>3&&b.append("<li class='page-break'>...</li>"),d>4&&b.append(e(d-2)),d>3&&b.append(e(d-1)),b.append(e(d)),c-2>d&&b.append(e(d+1)),c-1>d&&b.append(e(d+2)),c-2>d&&b.append("<li class='page-break'>...</li>"),c-1>d&&b.append(e(c-1)),d!=c&&b.append(e(c));b.append(a('<li class="page-btn page-next'+(d>=c?" disabled":"")+'"><a href="javascript:void(0);">&raquo;</a></li>'))}};if(d.remote&&d.remote.paging){var l=d.remote.paging.controls||a("<div class='mollify-table-pager'></div>").insertAfter(e);i=a('<div class="pagination"><ul></ul></div>').appendTo(l),l.delegate(".page-btn > a","click",function(){if(h){var b=a(this),c=b.parent();if(!c.hasClass("disabled")){var d=Math.floor(h.start/j)+1,e=Math.ceil(h.total/j);c.hasClass("page-next")?d++:c.hasClass("page-prev")?d--:d=parseInt(b.text(),10),1>d||d>e||(h.start=(d-1)*j,G.refresh())}}}),k()}var m=function(b){var c=!1;return A.find("tr").each(function(){var d=a(this),e=d[0].data;return b==e?(c=d,!1):void 0}),c},n=function(){var b=[];return e.find(".mollify-tableselect:checked").each(function(c,d){var e=a(d).parent().parent()[0].data;b.push(e)}),b},o=function(a,b){var c=m(a);c.find(".mollify-tableselect").prop("checked",b),g.fire()},p=function(){var a=A.children().length,b=a>0&&n().length==a;b?e.find(".mollify-tableselect-header").prop("checked",!0):e.find(".mollify-tableselect-header").prop("checked",!1)};g.add(p);for(var q=function(a){e.find(".mollify-tableselect").prop("checked",a)},r=a("<tr></tr>").appendTo(a("<thead></thead>").appendTo(e)),s=!1,t=function(){var a=A.children().length,b=a>0&&n().length==a;q(!b),g.fire()},u=0,v=d.columns.length;v>u;u++){var w,x=d.columns[u];"selectrow"==x.type?w=a('<input class="mollify-tableselect-header" type="checkbox"></input>').click(t):(w=a("<th>"+("action"==x.type?"":x.title?x.title:"")+"</th>"),w[0].colId=x.id,x.sortable&&(w.append("<span class='mollify-tableheader-sort'></span>").addClass("sortable"),s||(s=x.id))),x.id&&w.addClass("col-"+x.id),w.appendTo(r)}var y=!1;s&&(y={id:s,asc:!0}),d.defaultSort&&(y=d.defaultSort);var z=function(){if(e.find("th.sortable > .mollify-tableheader-sort").empty(),y){var b=a("th.col-"+y.id+" > .mollify-tableheader-sort");b.html("<i class='"+(y.asc?"icon-caret-up":"icon-caret-down")+"'></i>")}};e.delegate("th.sortable","click",function(){var b=a(this),c=b[0].colId;y&&y.id==c?y.asc=!y.asc:y={id:c,asc:!0},z(),G.refresh()}),z();var A=a("<tbody></tbody>").appendTo(e),B=!1;d.emptyHint&&(B=a("<tr class='mollify-table-empty-hint'><td colspan='"+d.columns.length+"'>"+d.emptyHint+"</td></tr>")),e.delegate(".mollify-tableselect","change",function(){return g.fire(),!1}),e.delegate("a.mollify-tableaction","click",function(b){var c=a(this).parent(),e=c.parent(),f=c[0].colId,g=e[0].data;return b.stopPropagation(),d.onRowAction&&d.onRowAction(f,g),!1}),d.hilight&&e.delegate("tr","click",function(b){if(!b.target||!a(b.target).hasClass("mollify-tableselect")){var c=a(this),f=c[0].data;f&&(c.hasClass("info")?(c.removeClass("info"),c.find(".mollify-tableselect").prop("checked",!1),f=null):(e.find("tr").removeClass("info"),q(!1),c.find(".mollify-tableselect").prop("checked",!0),c.addClass("info")),g.fire(),d.onHilight&&d.onHilight(f))}});var C=function(c,e,f){c[0].colId=e.id;var g=f[e.id];if(e.cellClass&&c.addClass(e.cellClass),"selectrow"==e.type){a('<input class="mollify-tableselect" type="checkbox"></input>').appendTo(c.empty())}else if("action"==e.type){var h=e.content;e.formatter&&(h=e.formatter(f,g)),h&&a("<a class='mollify-tableaction' title='"+e.title+"'></a>").html(h).appendTo(c.empty())}else if("input"==e.type){var i=c[0].ctrl;i||(i=a('<input type="text"></input>').appendTo(c).change(function(){var a=i.val();c[0].ctrlVal=a,d.selectOnEdit&&o(f,!0),e.onChange&&e.onChange(f,a)}),c[0].ctrl=i);var j=g;e.valueMapper&&(j=e.valueMapper(f,g)),i.val(j)}else if("select"==e.type){var k=c[0].ctrl;if(!k){var l=[];"function"==typeof e.options?l=e.options(f):window.isArray(e.options)&&(l=e.options);var m;e.none&&(m="function"==typeof e.none?e.none(f):e.none);var n;e.formatter&&(n=function(a){return e.formatter(f,a)}),k=b.ui.controls.select(a("<select></select>").appendTo(c),{values:l,title:e.title,none:m,formatter:n,onChange:function(a){c[0].ctrlVal=a,d.selectOnEdit&&o(f,!0),e.onChange&&e.onChange(f,a)}}),c[0].ctrl=k}var p=g;e.valueMapper&&(p=e.valueMapper(f,g)),k.select(p)}else"static"==e.type?c.html(e.content||""):e.renderer?e.renderer(f,g,c):c.html(e.valueMapper?e.valueMapper(f,g):e.formatter?"function"==typeof e.formatter?e.formatter(f,g):e.formatter.format(g):g)},D=function(b){B&&B.detach();var c=a("<tr></tr>").appendTo(A);c[0].data=b,d.onRow&&d.onRow(c,b);for(var e=0,f=d.columns.length;f>e;e++){var g=a("<td></td>").appendTo(c);C(g,d.columns[e],b)}},E=function(b){b.find("td").each(function(){var c=a(this),e=c.index();C(c,d.columns[e],b[0].data)})},F=function(){if(B){var a=A.find("tr").length;0===a?B.appendTo(A):B.hide()}},G={findByKey:function(b){if(!d.key)return!1;var c=!1;return A.find("tr").each(function(){var e=a(this)[0].data;return e[d.key]==b?(c=e,!1):void 0}),c},onSelectionChanged:function(a){g.add(a)},getSelected:function(){return n()},getValues:function(){var b={};return A.find("td").each(function(){var c=a(this),e=c[0].ctrlVal;if(e){var f=c.parent(),g=f[0].data,h=g[d.key];b[h]||(b[h]={}),b[h][c[0].colId]=e}}),b},set:function(b){B&&B.detach(),A.empty(),a.each(b,function(a,b){D(b)}),F(),g.fire()},add:function(a){if(a){if(window.isArray(a))for(var b=0,c=a.length;c>b;b++)D(a[b]);else D(a);F()}},update:function(a){if(a){var b=m(a);b&&E(b)}},remove:function(a){if(a){var b=m(a);b&&(b.remove(),F())}},refresh:function(){var c=a.Deferred();if(!d.remote||!d.remote.path)return c.resolve();var e={count:j,start:h?h.start:0,sort:y};if(d.remote.queryParams){var f=d.remote.queryParams(h);f&&(e=a.extend(e,f))}var g=b.service.post(d.remote.path,e).done(function(a){d.remote.paging?(h={start:a.start,count:a.count,total:a.total},k()):h=!1,d.remote.onData&&d.remote.onData(a),G.set(a.data),c.resolve()}).fail(c.reject);return d.remote.onLoad&&d.remote.onLoad(g),c}};return G},select:function(b,c){var d="string"==typeof b?a("#"+b):b;if(!d||0===d.length)return!1;d.empty();var e=function(b){var e=a("<option></option>").appendTo(d);if(b==c.none)e.html(b);else if(c.renderer)c.renderer(b,e);else{var f="";c.formatter?f=c.formatter(b):c.title?f=b[c.title]:"string"==typeof b&&(f=b),e.html(f)}e[0].data=b},f=function(){var a=d.find("option:selected");if(!a||0===a.length)return null;var b=a[0].data;return b==c.none?null:b};c.onChange&&d.change(function(){c.onChange(f())});var g={add:function(a){if(a)if(window.isArray(a))for(var b=0,c=a.length;c>b;b++)e(a[b]);else e(a)},select:function(b){var e=d.find("option");if(void 0!==b&&"number"==typeof b){if(e.length>=b)return;return void a(e[b]).prop("selected",!0)}var f=b;c.none&&!f&&(f=c.none);for(var g=0,h=e.length;h>g;g++)if(e[g].data==f||e[g].text==f)return void a(e[g]).prop("selected",!0)},get:f,set:this.select,selected:f};return c.none&&g.add(c.none),c.values&&(g.add(c.values),c.value&&g.select(c.value)),g},radio:function(b,c){var d=b.addClass("btn-group").attr("id"),e=b.find("button"),f=function(a){e.removeClass("active"),a.addClass("active")};return e.click(function(){var b=a(this),g=e.index(b);f(b);var h=b.attr("id");c&&d&&c.onRadioChanged&&c.onRadioChanged(d,h,g)}),{set:function(b){f(a(e[b]))}}},datepicker:function(c,d){if(!c)return!1;d||(d={});var e="string"==typeof c?a("#"+c):c;a.fn.datetimepicker.dates.mollify||(a.fn.datetimepicker.dates.mollify={days:b.ui.texts.get("days"),daysShort:b.ui.texts.get("daysShort"),daysMin:b.ui.texts.get("daysMin"),months:b.ui.texts.get("months"),monthsShort:b.ui.texts.get("monthsShort"),today:b.ui.texts.get("today"),weekStart:b.ui.texts.get("weekStart")});var f=d.value||null,g=d.format||b.ui.texts.get("shortDateTimeFormat");g=g.replace(/\b[h]\b/,"hh"),g=g.replace(/\b[M]\b/,"MM"),g=g.replace(/\b[d]\b/,"dd"),g=g.replace("tt","PP");var h=e.datetimepicker({format:g,language:"mollify",pickTime:d.time||!0,pickSeconds:g.indexOf("s")>=0}).on("changeDate",function(a){f=a.date}),i=h.data("datetimepicker");f&&i.setDate(f);var j={get:function(){return f?new Date(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds()):f},set:function(a){f=null!=a?new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())):null,i.setDate(f)}};return h.data("mollify-datepicker",j),j},editableLabel:function(b){var c=a(b.element),d=c.attr("id"),e=b.value||c.html().trim();if(d){c.addClass("editable-label").hover(function(){c.addClass("hover")},function(){c.removeClass("hover")});var f=a("<label></label>").appendTo(c.empty()),g=a("<input></input>").appendTo(c),h={value:function(a){e=a,e||!b.hint?(c.removeClass("hint"),f.html(e)):(c.addClass("hint"),f.html(b.hint)),g.val(e)}};h.value(e);var i=function(){var a=g.val();(!b.isvalid||b.isvalid(a))&&(g.hide(),f.show(),e!=a&&(b.onedit&&b.onedit(a),h.value(a)))},j=function(){g.hide(),f.show(),h.value(e)};return g.hide().bind("blur",i).keyup(function(a){13==a.which?i():27==a.which&&j()}),f.bind("click",function(){f.hide(),g.show().focus()}),h}},slidePanel:function(c,d){if(c){var e=b.dom.template("mollify-tmpl-slidepanel").appendTo(c);d.relative&&e.addClass("relative");var f=e.find(".mollify-slidepanel-content");d.resizable&&e.resizable({handles:"n"}).bind("resize",function(){a(this).css("top","auto")});var g={getContentElement:function(){return f},show:function(a,b){a&&f.empty().append(a),f.parent().scrollTop(0),e.animate({height:b+"px"},500)},hide:function(){e.animate({height:"0px"},500)},remove:function(){e.remove()}};return e.find(".close").click(g.hide),g}},tooltip:function(b,c){b&&b.tooltip(a.extend({},{placement:"bottom",title:"",trigger:"hover"},c))}},b.ui.dialogs={};var g=b.ui.dialogs;g._dialogDefaults={title:"Mollify"},g.closeActiveDialog=function(){g._activeDialog&&g._activeDialog.close()},g.info=function(b){g.custom({title:b.title,content:a("#mollify-tmpl-dialog-info").tmpl({message:b.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(a,c){c.close(),b.callback&&b.callback()}})},g.showActionDeniedMessage=function(a,c){for(var d="<p>"+a+"</p><p><ul>",e=0,f=c.length;f>e;e++)d=d+"<li>"+c[e]+"</li>";d+="</ul></p>",b.ui.dialogs.error({title:b.ui.texts.get("errorDialogTitle"),message:d})},g.confirmActionAccept=function(a,c,d,e){for(var f="<p>"+a+"</p><p><ul>",h=0,i=c.length;i>h;h++)f=f+"<li>"+c[h]+"</li>";f+="</ul></p>",g.custom({title:b.ui.texts.get("errorDialogTitle"),content:f,buttons:[{id:"yes","title-key":"yes",cls:"btn-primary"},{id:"no","title-key":"no"}],"on-button":function(a,b){b.close(),"yes"===a.id&&(d?d():e&&e())}})},g.showError=function(c){var d="errorDialogMessage_"+c.code;b.ui.texts.has(d)||(d="errorDialogUnknownError"),b.session.user&&b.session.user.admin&&c.trace?g.custom({title:b.ui.texts.get("errorDialogTitle"),content:a("#mollify-tmpl-dialog-error-debug").tmpl({title:b.ui.texts.get("errorDialogTitle"),message:b.ui.texts.get(d),debug:c.trace.join("<br/>")}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(a,b){b.close()}}):b.ui.dialogs.error({title:b.ui.texts.get("errorDialogTitle"),message:b.ui.texts.get(d)})},g.select=function(c){var d=!1;g.custom({title:c.title,initSize:c.initSize,content:a("#mollify-tmpl-dialog-select").tmpl({message:c.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"},{id:"cancel","title-key":"dialogCancel"}],"on-button":function(a,b){var e;("ok"!=a.id||(e=d.getSelected(),e&&0!==e.length))&&(b.close(),"ok"==a.id&&c.onSelect&&c.onSelect(e,d.getValues()))},"on-show":function(e,f){var g=a(f.find(".mollify-selectdialog-table")[0]);d=b.ui.controls.table(g,{key:c.key,selectOnEdit:!0,columns:[{type:"selectrow"}].concat(c.columns)}),d.set(c.list)}})},g.error=function(b){g.custom({title:b.title,content:a("#mollify-tmpl-dialog-error").tmpl({message:b.message}),buttons:[{id:"ok","title-key":"ok",cls:"btn-primary"}],"on-button":function(a,c){c.close(),b.callback&&b.callback()}})},g.confirmation=function(a){g.custom({title:a.title,content:a.message,buttons:[{id:"yes","title-key":"yes"},{id:"no","title-key":"no"}],"on-button":function(b,c){c.close(),a.callback&&"yes"===b.id&&a.callback()}})},g.input=function(b){var c=!1;g.custom({title:b.title,content:a("#mollify-tmpl-dialog-input").tmpl({message:b.message}),buttons:[{id:"yes",title:b.yesTitle,cls:"btn-primary"},{id:"no",title:b.noTitle}],"on-button":function(a,d){if("yes"===a.id){if(!b.handler||!b.handler.isAcceptable)return;if(!b.handler.isAcceptable(c.val()))return}d.close(),"yes"===a.id&&b.handler.onInput(c.val())},"on-show":function(a,d){c=d.find(".mollify-inputdialog-input"),b.defaultValue&&c.val(b.defaultValue),c.focus()}})},g.wait=function(c){var d=a(c&&c.target?"#"+c.target:"body"),e=b.dom.template("mollify-tmpl-wait",a.extend(c,g._dialogDefaults)).appendTo(d).show();return{close:function(){e.remove()}}},g.notification=function(c){if(!(b.App.activeView&&b.App.activeView.onNotification&&b.App.activeView.onNotification(c))){var d=c&&c.target?"string"==typeof c.target?a("#"+c.target):c.target:a("#mollify-notification-container");0===d.length&&(d=a("body"));var e=b.dom.template("mollify-tmpl-notification",a.extend(c,g._dialogDefaults)).hide().appendTo(d).fadeIn(300);setTimeout(function(){e.fadeOut(300),c["on-finish"]&&c["on-finish"]()},3e3|c.time)}},g.custom=function(c){var d=function(a){a.css("margin-left",-a.outerWidth()/2),a.css("margin-top",-a.outerHeight()/2),a.css("top","50%"),a.css("left","50%")},e=c;e["title-key"]&&(e.title=b.ui.texts.get(e["title-key"]));var f=a("#mollify-tmpl-dialog-custom").tmpl(a.extend(g._dialogDefaults,e),{getContent:function(){if(c.html)return c.html;if(c.content){var b=c.content;return"string"==typeof b?b:a("<div/>").append(b.clone()).html()}return""},getButtonTitle:function(a){return a.title?a.title:a["title-key"]?b.ui.texts.get(a["title-key"]):""}});c.element&&f.find(".modal-body").append(c.element),b.ui.handlers.localize(f),f.on("hidden",function(a){a.target==f[0]&&f.remove()}).modal({backdrop:"static",show:!0,keyboard:!0});var h={close:function(){f.modal("hide"),g._activeDialog=!1},center:function(){d(f)},setInfo:function(a){var b=f.find(".modal-footer > .info").empty();a&&b.html(a)}};if(f.find(".modal-footer .btn").click(function(b){b.preventDefault();var d=f.find(".modal-footer .btn").index(a(this)),e=c.buttons[d];c["on-button"]&&c["on-button"](e,h)}),c.resizable){var i=f.find(".modal-header"),j=f.find(".modal-body"),k=f.find(".modal-footer"),l=30;j.css({"max-height":"none","max-width":"none"});var m=function(){d(f);var a=f.innerHeight()-i.outerHeight()-k.outerHeight()-l;j.css("height",a)};f.css({"max-height":"none","max-width":"none","min-height":f.outerHeight()+"px","min-width":f.outerWidth()+"px"}).on("resize",m).resizable(),c.initSize&&f.css({width:c.initSize[0]+"px",height:c.initSize[1]+"px"}),m()}return c["on-show"]&&c["on-show"](h,f),g._activeDialog=h,h},g.folderSelector=function(b){return g.itemSelector(a.extend({allowFiles:!1},b))},g.itemSelector=function(c){var d=a.extend({allowFiles:!0,allowFolders:!0},c),e=!1,f=a("#mollify-tmpl-dialog-itemselector").tmpl({message:d.message}),h=!1,i={},j=function(c,e){i[e?e.id:"root"]||(h.addClass("loading"),b.filesystem.items(e,d.allowFiles).done(function(b){h.removeClass("loading"),i[e?e.id:"root"]=!0;var d=b.files?b.folders.concat(b.files):b.folders;if(!d||0===d.length)return void(c&&c.find(".mollify-itemselector-folder-indicator").empty());var f=0,g=[];if(e){var k=e.path.match(/\//g);f=k?k.length+1:1;for(var l=0;f>l;l++)g.push({})}var m=a("#mollify-tmpl-dialog-itemselector-item").tmpl(d,{cls:0===f?"root":"",levels:g});c?(c.after(m),c.addClass("loaded"),c&&c.find(".mollify-itemselector-folder-indicator").find("i").removeClass("icon-caret-right").addClass("icon-caret-down")):h.append(m),e||1!=d.length||j(a(m[0]),d[0])}))};g.custom({title:d.title,content:f,buttons:[{id:"action",title:d.actionTitle,cls:"btn-primary"},{id:"cancel","title-key":"dialogCancel"}],"on-button":function(a,b){("action"!==a.id||e&&d.handler&&d.handler.canSelect(e))&&(b.close(),"action"===a.id&&d.handler.onSelect(e))},"on-show":function(b,c){h=c.find(".mollify-itemselector-tree"),h.on("click",".mollify-itemselector-folder-indicator",function(){var b=a(this).parent(),c=b.tmplItem().data;return j(b,c),!1}),h.on("click",".mollify-itemselector-item",function(){var b=a(this),c=a(this).tmplItem().data;(!c.is_file||d.allowFiles)&&(c.is_file||d.allowFolders)&&d.handler.canSelect(c)&&(e=c,a(".mollify-itemselector-item").removeClass("selected"),b.addClass("selected"))}),j(null,null)}})},g.tableView=function(a){b.ui.dialogs.custom({resizable:!0,initSize:[600,400],title:a.title,content:b.dom.template("mollify-tmpl-tableview"),buttons:a.buttons,"on-button":function(b,c){a.onButton(b,c)},"on-show":function(c,d){var e=d.find("#mollify-tableview-content");c.center();var f=b.ui.controls.table("mollify-tableview-list",{key:a.table.key,columns:a.table.columns,onRowAction:function(b,d){a.onTableRowAction&&a.onTableRowAction(c,f,b,d)}});a.onRender(c,e,f)}})},b.MollifyHTML5DragAndDrop=function(){var c=this;c.dragObj=!1,c.dragEl=!1,c.dragListener=!1;var d=function(a){c.dragEl&&(c.dragEl.removeClass("dragged"),c.dragListener&&c.dragListener.onDragEnd&&c.dragListener.onDragEnd(c.dragEl,a),c.dragEl=!1),c.dragObj=!1,c.dragListener=!1};a("body").bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="none",!1}),setTimeout(function(){var a=[];for(var c in b.settings.dnd.dragimages)if(b.settings.dnd.dragimages.hasOwnProperty(c)){var d=b.settings.dnd.dragimages[c];d&&(a.indexOf(d)>=0||a.push(d))}a&&b.ui.preloadImages(a)},0);var e={enableDragToDesktop:function(a,c){if(a){var d=b.getItemDownloadInfo(a);d&&c.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",d.name,d.url].join(":"))}},enableDrag:function(f,g){f.attr("draggable","true").bind("dragstart",function(d){if(c.dragObj=!1,d.originalEvent.dataTransfer.effectAllowed="none",!g.onDragStart)return!1;if(c.dragObj=g.onDragStart(a(this),d),!c.dragObj)return!1;var f=c.dragObj.type;if("filesystemitem"==c.dragObj.type){var h=c.dragObj.payload;if(window.isArray(h)&&1!=h.length)f="filesystemitem-many";else{var i=window.isArray(h)?h[0]:h;f=i.is_file?"filesystemitem-file":"filesystemitem-folder"}e.enableDragToDesktop(h,d)}if(c.dragEl=a(this),c.dragListener=g,c.dragEl.addClass("dragged"),d.originalEvent.dataTransfer.effectAllowed="copyMove",b.settings.dnd.dragimages[f]){var j=document.createElement("img");j.src=b.settings.dnd.dragimages[f],d.originalEvent.dataTransfer.setDragImage(j,0,0)}}).bind("dragend",function(a){d(a)})},enableDrop:function(b,e){b.addClass("droppable").bind("drop",function(b){if(b.stopPropagation&&b.stopPropagation(),e.canDrop&&e.onDrop&&c.dragObj){var f=a(this);e.canDrop(f,b,c.dragObj)&&(e.onDrop(f,b,c.dragObj),f.removeClass("dragover")),d(b)}}).bind("dragenter",function(b){if(!e.canDrop||!c.dragObj)return!1;var d=a(this);e.canDrop(d,b,c.dragObj)&&d.addClass("dragover")}).bind("dragover",function(b){b.preventDefault&&b.preventDefault();var d="none";if(e.canDrop&&e.dropType&&c.dragObj){var f=a(this);if(e.canDrop(f,b,c.dragObj)){var g=e.dropType(f,b,c.dragObj);g&&(d=g)}}return b.originalEvent.dataTransfer.dropEffect=d,!1}).bind("dragleave",function(){var b=a(this);b.removeClass("dragover"),c.dragTarget=!1})}};return e},b.MollifyJQueryDragAndDrop=function(){return{enableDragToDesktop:function(){},enableDrag:function(b,c){b.draggable({revert:"invalid",distance:10,addClasses:!1,zIndex:2700,start:function(b){c.onDragStart&&c.onDragStart(a(this),b)}})}}},b.ZeroClipboard=function(b){if(!b||!window.ZeroClipboard)return!1;window.ZeroClipboard.setDefaults({moviePath:"js/lib/ZeroClipboard.swf",hoverClass:"hover",activeClass:"active",forceHandCursor:!0});var c=a('<div id="zeroclipboard-test" style="width=0px; height=0px;"></div>').appendTo(a("body")),d=new window.ZeroClipboard(c[0]);d.on("load",function(){var a={enableCopy:function(a,b,c){var d=a.data("mollify-zeroclipboard");d||(d=new window.ZeroClipboard(a),a.data("mollify-zeroclipboard",d),c&&a.data("mollify-zeroclipboard-listener",c)),b&&a.data("mollify-zeroclipboard-text",b)}};b(a)}),d.on("dataRequested",function(){var b=a(this),c=b.data("mollify-zeroclipboard-listener"),e=!1;c&&c.onGetText&&(e=c.onGetText(b)),e||(e=b.data("mollify-zeroclipboard-text")),e&&d.setText(e)}),d.on("mouseover",function(){var b=a(this),c=b.data("mollify-zeroclipboard-listener");c&&c.onMouseOver&&c.onMouseOver(b,d)}),d.on("mouseout",function(){var b=a(this),c=b.data("mollify-zeroclipboard-listener");c&&c.onMouseOut&&c.onMouseOut(b)}),d.on("complete",function(b,c){var d=a(this),e=d.data("mollify-zeroclipboard-listener");e&&e.onCopy&&e.onCopy(d,c.text)})}}(window.jQuery,window.mollify),!function(a,b){"use strict";b.MollifyHTML5Uploader=function(){var c=this;return a(document).bind("drop dragover",function(a){return a.preventDefault(),!1}),this._getUploaderSettings=function(){return b.settings["html5-uploader"]||{}},this._initDropZoneEffects=function(a){a.bind("dragover",function(b){b.stopPropagation();var c=a,d=window.dropZoneTimeout;d?clearTimeout(d):c.addClass("in"),b.target===c[0]?c.addClass("hover"):c.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,c.removeClass("in hover")},100)})},this.initWidget=function(d,e){var f=b.dom.template("mollify-tmpl-uploader-widget").appendTo(d);b.ui.handlers.localize(d);var g=e.dropElement||d,h=!1,i=!1,j=e.handler,k=f.find("input");c._getUploaderSettings()["allow-folders"]&&k.attr("directory webkitdirectory mozdirectory"),k.fileupload(a.extend({url:e.url,dataType:"json",dropZone:g,submit:function(a,b){if(!(h&&i||h)){if(h=!0,i=!1,j.isUploadAllowed&&!j.isUploadAllowed(b.originalFiles))return i=!0,!1;j.start&&j.start(b.originalFiles,function(){})}},progressall:function(a,b){if(j.progress){var c=parseInt(b.loaded/b.total*100,10);j.progress(c,b.bitrate||!1)}},done:function(){},stop:function(){h=!1,i=!1,j.finished&&j.finished()},fail:function(a,b){var c=b.response(),d=null;if(c&&c.jqXHR){var e=c.jqXHR.responseText;e&&(d=JSON.parse(e))}j.failed&&j.failed(b.files,d)}},c._getUploaderSettings())),g&&c._initDropZoneEffects(g)},{initUploadWidget:function(a,d){b.templates.load("mollify-uploader",b.templates.url("uploader.html")).done(function(){c.initWidget(a,d)})},initDragAndDropUploader:function(b){var d=b.container,e=a('<div style="width: 0px; height: 0px; overflow: hidden;"></div>').appendTo(d),f=a('<form enctype="multipart/form-data"></form>').appendTo(e),g=!1,h=!1,i="";c._getUploaderSettings()["allow-folders"]&&(i="directory webkitdirectory mozdirectory");var j=a('<input type="file" class="mollify-mainview-uploader-input" name="uploader-html5[]" multiple="multiple"'+i+"></input>").appendTo(f).fileupload(a.extend({url:"",dataType:"json",dropZone:b.dropElement,submit:function(a,c){if(!(g&&h||g)){if(g=!0,h=!1,b.handler.isUploadAllowed&&!b.handler.isUploadAllowed(c.originalFiles))return h=!0,!1;b.handler.start&&b.handler.start(c.originalFiles,function(){})}},progressall:function(a,c){if(b.handler.progress){var d=parseInt(c.loaded/c.total*100,10);b.handler.progress(d,c.bitrate||!1)}},done:function(){},stop:function(){g=!1,h=!1,b.handler.finished&&b.handler.finished()},fail:function(a,c){var d=c.response(),e=null;if(d&&d.jqXHR){var f=d.jqXHR.responseText;f&&(e=JSON.parse(f))}b.handler.failed&&b.handler.failed(c.files,e)}},c._getUploaderSettings())).fileupload("disable");return c._initDropZoneEffects(b.dropElement),{destroy:function(){j&&j.fileupload("destroy"),j=!1},setUrl:function(a){return j?a?void j.fileupload("enable").fileupload("option","url",a):void j.fileupload("disable"):void 0}}}}}}(window.jQuery,window.mollify);